<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>季风决策者 v2.6.2</title>
  <link rel="icon" type="image/png" href="./imgs/monsoon_rain_clouds_game_icon_purple_circle.jpg">
  <link rel="shortcut icon" type="image/png" href="./imgs/monsoon_rain_clouds_game_icon_purple_circle.jpg">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --flood-color: #006994;
      --drought-color: #8B4513;
      --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-bg: rgba(255, 255, 255, 0.95);
      --accent-color: #FF5722;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --danger-color: #f44336;
      --info-color: #2196F3;
      --hell-color: #8B0000;
      --catastrophe-color: #FF0000;
      --policy-bg: rgba(255, 249, 230, 0.9);
      --policy-border: #ffd700;
      --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--primary-bg);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }

    .game-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      min-height: 100vh;
    }

    .main-content {
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 20px;
    }

    .game-header {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      background-image: url('imgs/beautiful_farm_agriculture_landscape_sunset_game_background.jpg');
      background-size: cover;
      background-position: center;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      position: relative;
    }

    .game-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      border-radius: var(--border-radius);
    }

    .game-header * {
      position: relative;
      z-index: 1;
    }

    .game-title {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
    }

    .game-subtitle {
      font-size: 1.2em;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .difficulty-badge {
      display: inline-block;
      padding: 5px 15px;
      background: var(--hell-color);
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      animation: hellPulse 2s infinite;
    }

    @keyframes hellPulse {
      0%, 100% { box-shadow: 0 0 5px var(--hell-color); }
      50% { box-shadow: 0 0 20px var(--catastrophe-color); }
    }

    /* 关键修复：添加游戏失败界面样式 */
    .critical-warning {
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .game-over-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
    }

    .game-over-title {
      font-size: 3em;
      color: #ff0000;
      margin-bottom: 20px;
    }

    .game-over-stats {
      margin: 20px 0;
      text-align: left;
    }

    .status-bar {
      background: var(--secondary-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .status-item {
      text-align: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      border-left: 4px solid var(--accent-color);
      transition: var(--transition);
    }

    .status-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .status-value {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--accent-color);
    }

    .status-label {
      font-size: 0.8em;
      color: #666;
      margin-top: 2px;
    }

    .game-board {
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .map-container {
      background: linear-gradient(45deg, #8FBC8F, #98FB98);
      border-radius: var(--border-radius);
      height: 250px;
      position: relative;
      overflow: hidden;
      background-image: url('imgs/farm_agriculture_game_background_sunrise_tractor_barn.jpg');
      background-size: cover;
      background-position: center;
    }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      z-index: 10;
    }

    .satellite-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      transition: all 0.5s ease;
    }

    .flood-effect {
      background: radial-gradient(circle, transparent 30%, rgba(0, 105, 148, 0.3) 70%);
      animation: flood-wave 2s infinite;
    }

    .drought-effect {
      background: radial-gradient(circle, transparent 30%, rgba(139, 69, 19, 0.3) 70%);
      animation: heat-shimmer 3s infinite;
    }

    .hell-disaster-effect {
      background: radial-gradient(circle, transparent 20%, rgba(255, 0, 0, 0.6) 80%);
      animation: catastrophe-pulse 1s infinite;
    }

    @keyframes flood-wave {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes heat-shimmer {
      0%, 100% { filter: hue-rotate(0deg); }
      50% { filter: hue-rotate(30deg); }
    }

    @keyframes catastrophe-pulse {
      0%, 100% { 
        background: radial-gradient(circle, transparent 20%, rgba(255, 0, 0, 0.6) 80%);
        transform: scale(1);
      }
      50% { 
        background: radial-gradient(circle, transparent 10%, rgba(139, 0, 0, 0.8) 90%);
        transform: scale(1.1);
      }
    }

    .particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(100px) translateX(0);
        opacity: 1;
      }
      100% {
        transform: translateY(-20px) translateX(20px);
        opacity: 0;
      }
    }

    .game-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .control-section {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .crop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
    }

    .crop-button {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 0.9em;
    }

    .crop-button:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .crop-button.selected {
      border-color: var(--success-color);
      background: var(--success-color);
      color: white;
    }

    .crop-icon {
      font-size: 1.5em;
      display: block;
      margin-bottom: 4px;
    }

    .crop-description {
      font-size: 0.7em;
      color: #666;
      line-height: 1.2;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
    }

    .panel-header {
      background: var(--accent-color);
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .panel-content {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .policy-card {
      background: var(--policy-bg);
      border: 2px solid var(--policy-border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .policy-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .policy-card.selected {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #ff8c00;
    }

    .policy-title {
      font-weight: bold;
      color: #8B4513;
      margin-bottom: 5px;
    }

    .policy-effect {
      font-size: 0.85em;
      color: #666;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
      font-size: 0.9em;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .success-btn {
      background: var(--success-color);
      color: white;
    }

    .warning-btn {
      background: var(--warning-color);
      color: white;
    }

    .danger-btn {
      background: var(--danger-color);
      color: white;
    }

    .info-btn {
      background: var(--info-color);
      color: white;
    }

    .hell-btn {
      background: var(--hell-color);
      color: white;
      animation: hellGlow 2s infinite;
    }

    @keyframes hellGlow {
      0%, 100% { box-shadow: 0 0 5px var(--hell-color); }
      50% { box-shadow: 0 0 15px var(--catastrophe-color); }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: var(--border-radius);
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #999;
    }

    .close:hover {
      color: #000;
    }

    .log-container {
      background: #f5f5f5;
      border-radius: 6px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.8em;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 3px 6px;
      border-radius: 3px;
    }

    .log-success {
      background: #e8f5e8;
      color: #2e7d32;
    }

    .log-warning {
      background: #fff3e0;
      color: #f57c00;
    }

    .log-error {
      background: #ffebee;
      color: #c62828;
    }

    .log-info {
      background: #e3f2fd;
      color: #1976d2;
    }

    .skill-bar {
      background: #e0e0e0;
      border-radius: 10px;
      height: 8px;
      margin-top: 3px;
      overflow: hidden;
    }

    .skill-progress {
      background: linear-gradient(90deg, var(--success-color), var(--warning-color));
      height: 100%;
      transition: width 0.5s ease;
    }

    .reputation-bar {
      background: #e0e0e0;
      border-radius: 10px;
      height: 12px;
      margin: 8px 0;
      overflow: hidden;
      position: relative;
    }

    .reputation-indicator {
      background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0, #FF9800, #F44336);
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8em;
    }

    .history-table th,
    .history-table td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .history-table th {
      background: #f5f5f5;
      font-weight: bold;
    }

    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .popup-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .bulletin-board {
      background: linear-gradient(135deg, #FFE4B5, #DDD);
      border: 3px solid #8B4513;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .bulletin-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #8B4513;
      margin-bottom: 10px;
      text-align: center;
      border-bottom: 2px solid #8B4513;
      padding-bottom: 5px;
    }

    .bulletin-content {
      font-size: 0.9em;
      line-height: 1.4;
      color: #333;
    }

    .hell-indicator {
      background: linear-gradient(45deg, var(--hell-color), var(--catastrophe-color));
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
      animation: hellPulse 2s infinite;
    }

    .anti-afk-warning {
      background: linear-gradient(45deg, #FF4444, #AA0000);
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      animation: warningFlash 1s infinite;
    }

    @keyframes warningFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .survival-equipment {
      background: linear-gradient(135deg, #2C5364, #203A43, #0F2027);
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 5px 0;
      border-left: 4px solid var(--catastrophe-color);
    }

    .export-preview {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: 20px auto;
    }

    .achievement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 5px;
      margin-top: 10px;
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .achievement-icon:hover {
      transform: scale(1.1);
    }

    .achievement-unlocked {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .achievement-locked {
      background: #CCC;
      color: #666;
    }

    .radar-chart-container {
      width: 300px;
      height: 300px;
      margin: 20px auto;
    }

    /* 响应式设计 */
    @media (max-width: 1200px) {
      .game-container {
        grid-template-columns: 1fr;
        max-width: 100%;
      }
      
      .sidebar {
        grid-row: 2;
      }
    }

    @media (max-width: 768px) {
      .game-container {
        padding: 10px;
      }
      
      .game-board {
        grid-template-columns: 1fr;
      }
      
      .status-bar {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <!-- 教程覆盖层 -->
  <div id="tutorial-overlay" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <h2>🌾 欢迎来到季风决策者 v2.6.2！</h2>
      <p id="tutorial-text">在这个极致挑战的农业经营游戏中，您将面对前所未有的困难...</p>
      <div style="margin-top: 20px;">
        <button onclick="nextTutorial()" class="btn info-btn">下一步</button>
        <button onclick="skipTutorial()" class="btn warning-btn">跳过教程</button>
      </div>
    </div>
  </div>

  <!-- 出生地选择覆盖层 -->
  <div id="birthplace-overlay" class="popup-overlay">
    <div class="popup-content">
      <h2>🌍 选择您的出生地</h2>
      <p>不同的出生地将带来不同的初始条件和特殊优势</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0;">
        <button onclick="selectBirthplace('china-south')" class="btn info-btn">🇨🇳 中国南方<br><small>水稻优势</small></button>
        <button onclick="selectBirthplace('china-north')" class="btn info-btn">🇨🇳 中国北方<br><small>小麦优势</small></button>
        <button onclick="selectBirthplace('india-east')" class="btn info-btn">🇮🇳 印度东部<br><small>季风前沿</small></button>
        <button onclick="selectBirthplace('sea-thailand')" class="btn info-btn">🇹🇭 泰国<br><small>热带作物</small></button>
        <button onclick="selectBirthplace('africa-east')" class="btn info-btn">🌍 东非<br><small>咖啡优势</small></button>
        <button onclick="selectBirthplace('russia-south')" class="btn info-btn">🇷🇺 俄国南部<br><small>机械化</small></button>
      </div>
    </div>
  </div>

  <!-- 难度选择覆盖层 -->
  <div id="difficulty-overlay" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <h2>⚡ 选择游戏难度</h2>
      <p>v2.6.2 提供史无前例的挑战等级！</p>
      <div style="margin: 20px 0;">
        <button onclick="selectDifficulty(10)" class="btn success-btn">🟢 10% - 新手模式<br><small>原版体验，适合学习</small></button>
        <button onclick="selectDifficulty(30)" class="btn warning-btn">🟡 30% - 标准挑战<br><small>2倍难度倍数</small></button>
        <button onclick="selectDifficulty(50)" class="btn info-btn">🟠 50% - 困难模式<br><small>5倍难度倍数</small></button>
        <button onclick="selectDifficulty(70)" class="btn danger-btn">🔴 70% - 地狱模式<br><small>10倍难度 + 灭世灾害</small></button>
        <button onclick="selectDifficulty(90)" class="btn hell-btn">⚫ 90% - 绝望模式<br><small>20倍难度 + 终极挑战</small></button>
        <button onclick="selectGameMode('endless')" class="btn hell-btn">♾️ 无尽模式<br><small>每5年递增难度直至终结</small></button>
      </div>
    </div>
  </div>

  <!-- 主游戏界面 -->
  <div class="game-container">
    <!-- 主要内容区域 -->
    <div class="main-content">
      <!-- 游戏标题 -->
      <div class="game-header">
        <h1 class="game-title">季风决策者</h1>
        <div class="game-subtitle">v2.6 地狱版 - 终极难度完整版</div>
        <div class="difficulty-badge" id="difficulty-display">极限地狱模式激活</div>
        
        <!-- 开发者公告栏 -->
        <div class="bulletin-board" style="margin-top: 15px;">
          <div class="bulletin-title">📢 v2.6 版本更新</div>
          <div class="bulletin-content">
            🔥 修复版终极难度！彻底解决无限生存漏洞！<br>
            ⚡ 保留所有完整功能：设备、研发、成就、政策、市场系统！<br>
            💀 新增多重失败机制：人口归零、资金耗尽、生存压力过载！<br>
            ☢️ 警告：此版本可能导致严重精神创伤！不适合心脏不好的玩家！
          </div>
        </div>

        <!-- 关键修复：添加临界警告 -->
        <div class="critical-warning" id="critical-warning" style="display: none;">
          ⚠️ 临界状态！再次失败可能导致游戏结束！
        </div>
      </div>

      <!-- 状态栏 -->
      <div class="status-bar">
        <div class="status-item">
          <div class="status-value" id="money-display">300</div>
          <div class="status-label">资金 (₹)</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="year-display">1</div>
          <div class="status-label">年份</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="population-display">80</div>
          <div class="status-label">人口</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="weather-display">正常</div>
          <div class="status-label">天气</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="season-display">春季</div>
          <div class="status-label">季节</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="current-crop-display">未选择</div>
          <div class="status-label">当前作物</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="farmer-level-display">1</div>
          <div class="status-label">农民等级</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="reputation-display">0</div>
          <div class="status-label">声望值</div>
        </div>
        <!-- 关键修复：添加生存压力和失败警告显示 -->
        <div class="status-item">
          <div class="status-value" id="survival-pressure-display">0%</div>
          <div class="status-label">⚡ 生存压力</div>
        </div>
        <div class="status-item">
          <div class="status-value" id="failure-warnings-display">0/3</div>
          <div class="status-label">💀 失败警告</div>
        </div>
      </div>

      <!-- 游戏面板 -->
      <div class="game-board">
        <!-- 地图区域 -->
        <div class="map-container">
          <div class="map-overlay" id="map-info">
            地图信息将在这里显示
          </div>
          <div class="satellite-overlay" id="weather-overlay"></div>
          <div class="particles" id="weather-particles"></div>
        </div>

        <!-- 游戏控制 -->
        <div class="game-controls">
          <!-- 难度指示器 -->
          <div class="control-section">
            <div class="section-title">⚡ 难度状态</div>
            <div id="difficulty-indicator" class="hell-indicator">
              地狱模式激活 - 极限挑战
            </div>
            <div id="afk-warning" class="anti-afk-warning" style="display: none;">
              ⚠️ 反挂机警告：请采取行动或将面临惩罚！
            </div>
          </div>

          <!-- 作物选择 -->
          <div class="control-section">
            <div class="section-title">
              🌾 作物选择
              <span style="font-size: 0.8em; color: #666;">当前季节: <span id="season-indicator">春季</span></span>
            </div>
            <div class="crop-grid">
              <!-- 基础粮食作物 -->
              <button class="crop-button" onclick="chooseCrop('水稻')" data-crop="水稻">
                <span class="crop-icon">🌾</span>
                <div>水稻</div>
                <div class="crop-description">主食作物<br>洪水适应</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('小麦')" data-crop="小麦">
                <span class="crop-icon">🌾</span>
                <div>小麦</div>
                <div class="crop-description">耐寒作物<br>稳定产量</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('玉米')" data-crop="玉米">
                <span class="crop-icon">🌽</span>
                <div>玉米</div>
                <div class="crop-description">高产作物<br>饲料用途</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('大豆')" data-crop="大豆">
                <span class="crop-icon">🫘</span>
                <div>大豆</div>
                <div class="crop-description">蛋白质作物<br>土壤改良</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('高粱')" data-crop="高粱">
                <span class="crop-icon">🌾</span>
                <div>高粱</div>
                <div class="crop-description">抗旱<br>干旱适应</div>
              </button>
              <!-- 经济作物 -->
              <button class="crop-button" onclick="chooseCrop('棉花')" data-crop="棉花">
                <span class="crop-icon">🌿</span>
                <div>棉花</div>
                <div class="crop-description">经济作物<br>高价值</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('茶叶')" data-crop="茶叶">
                <span class="crop-icon">🍃</span>
                <div>茶叶</div>
                <div class="crop-description">山地作物<br>特殊环境</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('甘蔗')" data-crop="甘蔗">
                <span class="crop-icon">🎋</span>
                <div>甘蔗</div>
                <div class="crop-description">热带作物<br>高温多湿</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('橡胶')" data-crop="橡胶">
                <span class="crop-icon">🌳</span>
                <div>橡胶</div>
                <div class="crop-description">热带经济<br>长期投资</div>
              </button>
              <!-- 新增特殊作物 -->
              <button class="crop-button" onclick="chooseCrop('咖啡')" data-crop="咖啡">
                <span class="crop-icon">☕</span>
                <div>咖啡</div>
                <div class="crop-description">高价经济<br>山地种植</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('可可')" data-crop="可可">
                <span class="crop-icon">🍫</span>
                <div>可可</div>
                <div class="crop-description">热带珍品<br>长期收益</div>
              </button>
            </div>
          </div>

          <!-- 操作按钮 -->
          <div class="control-section">
            <div class="section-title">🎮 游戏操作</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
              <button onclick="nextTurn()" id="next-turn-btn" class="btn success-btn">下一回合 ⏭️</button>
              <button onclick="showMarket()" class="btn warning-btn">市场交易 🏪</button>
              <button onclick="showLoanCenter()" class="btn danger-btn">贷款中心 🏦</button>
              <button onclick="showInsurance()" class="btn info-btn">农业保险 🛡️</button>
              <button onclick="showCoop()" class="btn success-btn">合作社 🤝</button>
              <button onclick="showResearch()" class="btn info-btn">研发中心 🔬</button>
            </div>
          </div>

          <!-- 技能与经验 -->
          <div class="control-section">
            <div class="section-title">📈 农民技能</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div style="margin-bottom: 8px;">
                种植经验: <span id="planting-exp">0</span>/<span id="planting-exp-needed">100</span>
                <div class="skill-bar">
                  <div class="skill-progress" id="planting-progress" style="width: 0%"></div>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                管理经验: <span id="management-exp">0</span>/<span id="management-exp-needed">100</span>
                <div class="skill-bar">
                  <div class="skill-progress" id="management-progress" style="width: 0%"></div>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                市场经验: <span id="market-exp">0</span>/<span id="market-exp-needed">100</span>
                <div class="skill-bar">
                  <div class="skill-progress" id="market-progress" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- 声望系统 -->
          <div class="control-section">
            <div class="section-title">🌟 声望系统</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div>声望等级: <span id="reputation-level">新手农民</span></div>
              <div class="reputation-bar">
                <div class="reputation-indicator" id="reputation-indicator"></div>
              </div>
              <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                <span id="reputation-desc">刚刚开始农业生涯</span>
              </div>
            </div>
          </div>

          <!-- 环境系统 -->
          <div class="control-section">
            <div class="section-title">🌍 环境系统</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div style="margin-bottom: 8px;">
                环境健康: <span id="environmental-health">100</span>/100
                <div class="skill-bar">
                  <div class="skill-progress" id="environmental-progress" style="width: 100%"></div>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                可持续性: <span id="sustainability-score">0</span>分
              </div>
              <div style="margin-bottom: 8px;">
                碳足迹: <span id="carbon-footprint">0</span>kg CO₂
              </div>
            </div>
          </div>

          <!-- 市场分析 -->
          <div class="control-section">
            <div class="section-title">📈 市场分析</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div id="market-analysis">
                <div>市场趋势分析将在这里显示...</div>
              </div>
              <button onclick="showDetailedMarketAnalysis()" class="btn info-btn" style="width: 100%; margin-top: 8px;">
                详细市场分析
              </button>
            </div>
          </div>

          <!-- 政策中心 -->
          <div class="control-section">
            <div class="section-title">🏛️ 政策中心</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div id="current-policies">
                <div style="font-size: 0.9em; color: #666;">当前无活跃政策</div>
              </div>
              <button onclick="showPolicyCenter()" class="btn warning-btn" style="width: 100%; margin-top: 8px;">
                政策管理
              </button>
            </div>
          </div>

          <!-- 生存设备（地狱版特色） -->
          <div class="control-section">
            <div class="section-title">🛡️ 生存设备</div>
            <div id="survival-equipment-panel">
              <p style="color: #666; text-align: center; font-size: 0.9em;">
                高难度模式下的生存装备将在这里显示
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧边栏 -->
    <div class="sidebar">
      <!-- 实时信息面板 -->
      <div class="panel">
        <div class="panel-header">
          📊 实时信息
        </div>
        <div class="panel-content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em;">
            <div>游戏时长: <span id="game-duration">0</span>分钟</div>
            <div>操作次数: <span id="action-count">0</span></div>
            <div>平均APM: <span id="apm">0</span></div>
            <div>效率评分: <span id="efficiency-score">0</span></div>
          </div>
        </div>
      </div>

      <!-- 市场面板 -->
      <div class="panel">
        <div class="panel-header">
          🏪 农产品市场
        </div>
        <div class="panel-content" id="market-panel">
          <!-- 市场内容将通过JavaScript动态生成 -->
        </div>
      </div>

      <!-- 事件通知面板 -->
      <div class="panel">
        <div class="panel-header">
          📢 事件通知
        </div>
        <div class="panel-content" id="events-panel">
          <div style="color: #666; text-align: center; font-size: 0.9em;">暂无活跃事件</div>
        </div>
      </div>

      <!-- 设备面板 -->
      <div class="panel">
        <div class="panel-header">
          🔧 农业设备
        </div>
        <div class="panel-content" id="equipment-panel">
          <!-- 设备内容将通过JavaScript动态生成 -->
        </div>
      </div>

      <!-- 成就面板 -->
      <div class="panel">
        <div class="panel-header">
          🏆 成就与奖励
        </div>
        <div class="panel-content" id="achievement-panel">
          <p style="color: #666; text-align: center;">暂无成就</p>
        </div>
      </div>

      <!-- 统计面板 -->
      <div class="panel">
        <div class="panel-header">
          📈 游戏统计
        </div>
        <div class="panel-content">
          <div style="font-size: 0.8em;">
            <div style="margin-bottom: 5px;">
              <strong>基础统计</strong>
            </div>
            <div>设备购买: <span id="total-equipment">0</span>件</div>
            <div>研发完成: <span id="total-research">0</span>项</div>
            <div>政策应用: <span id="total-policies">0</span>次</div>
            <div>事件经历: <span id="total-events">0</span>次</div>
            <div style="margin: 8px 0; border-top: 1px solid #eee; padding-top: 5px;">
              <strong>巅峰记录</strong>
            </div>
            <div>最高人口: <span id="max-population">80</span>人</div>
            <div>最长连胜: <span id="longest-streak">0</span>年</div>
            <div>环境评分: <span id="env-score">100</span>/100</div>
          </div>
        </div>
      </div>

      <!-- 历史记录 -->
      <div class="panel">
        <div class="panel-header">
          📊 经营历史
        </div>
        <div class="panel-content">
          <table class="history-table">
            <thead>
              <tr>
                <th>年份</th>
                <th>天气</th>
                <th>收入</th>
                <th>作物</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- 历史记录将动态生成 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 日志面板 -->
      <div class="panel">
        <div class="panel-header">
          📜 游戏日志
        </div>
        <div class="panel-content">
          <div class="log-container" id="log-container">
            <!-- 日志内容将动态生成 -->
          </div>
        </div>
      </div>

      <!-- 导出功能 -->
      <div class="panel">
        <div class="panel-header">
          📤 数据导出
        </div>
        <div class="panel-content">
          <button onclick="showExportModal()" class="btn info-btn" style="width: 100%; margin-bottom: 10px;">
            📊 导出战绩图片
          </button>
          <button onclick="exportGameData()" class="btn warning-btn" style="width: 100%; margin-bottom: 10px;">
            💾 导出JSON数据
          </button>
          <button onclick="exportDetailedReport()" class="btn success-btn" style="width: 100%; margin-bottom: 10px;">
            📋 导出详细报告
          </button>
          <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
            <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreGameData(event)">
            <button onclick="document.getElementById('restore-file').click()" class="btn danger-btn" style="width: 100%;">
              📁 恢复存档
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 关键修复：添加游戏失败界面 -->
  <div class="game-over-screen" id="game-over-screen">
    <div class="game-over-content">
      <div class="game-over-title">💀 游戏结束</div>
      <div class="game-over-stats" id="game-over-stats"></div>
      <button onclick="restartGame()" class="btn success-btn">重新开始</button>
    </div>
  </div>

  <!-- 政策中心模态框 -->
  <div id="policy-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePolicyModal()">&times;</span>
      <h2>🏛️ 政策管理中心</h2>
      
      <div style="margin: 20px 0;">
        <h3>当前活跃政策</h3>
        <div id="active-policies-list">
          <p style="color: #666;">当前无活跃政策</p>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <h3>可申请政策</h3>
        <div id="available-policies-list">
          <!-- 政策列表将动态生成 -->
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="closePolicyModal()" class="btn info-btn">关闭</button>
      </div>
    </div>
  </div>

  <!-- 市场分析模态框 -->
  <div id="market-analysis-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeMarketAnalysisModal()">&times;</span>
      <h2>📈 详细市场分析</h2>
      
      <div style="margin: 20px 0;">
        <div id="detailed-market-content">
          <!-- 详细市场分析内容 -->
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="closeMarketAnalysisModal()" class="btn info-btn">关闭</button>
      </div>
    </div>
  </div>

  <!-- 导出模态框 -->
  <div id="export-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeExportModal()">&times;</span>
      <h2>📊 战绩导出</h2>
      
      <div style="margin: 20px 0;">
        <label>玩家姓名：</label>
        <input type="text" id="player-name" placeholder="输入您的名字" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px;">
      </div>
      
      <!-- 导出预览区域 -->
      <div id="export-preview" class="export-preview">
        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px 10px 0 0;">
          <h1>🌾 季风决策者 v2.6.2</h1>
          <h2 id="preview-player-name">玩家战绩报告</h2>
          <div id="preview-date"></div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
          <!-- 基本信息 -->
          <div>
            <h3>🎮 游戏信息</h3>
            <div id="preview-game-info"></div>
          </div>
          
          <!-- 成就墙 -->
          <div>
            <h3>🏆 成就墙</h3>
            <div id="preview-achievements" class="achievement-grid"></div>
          </div>
        </div>
        
        <!-- 雷达图 -->
        <div style="text-align: center; padding: 20px;">
          <h3>📊 能力雷达图</h3>
          <div class="radar-chart-container">
            <canvas id="radar-chart"></canvas>
          </div>
        </div>
        
        <!-- 统计数据 -->
        <div style="padding: 20px;">
          <h3>📈 详细统计</h3>
          <div id="preview-statistics"></div>
        </div>
        
        <!-- 文字评价 -->
        <div style="padding: 20px; background: #f5f5f5; border-radius: 0 0 10px 10px;">
          <h3>🎯 综合评价</h3>
          <div id="preview-evaluation"></div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="generateImageExport()" class="btn success-btn">🖼️ 生成PNG图片</button>
        <button onclick="closeExportModal()" class="btn danger-btn">取消</button>
      </div>
    </div>
  </div>

  <!-- 各种功能模态框（市场、贷款、保险等） -->
  <div id="feature-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeFeatureModal()">&times;</span>
      <div id="feature-content">
        <!-- 动态内容 -->
      </div>
    </div>
  </div>

  <script>
    // 游戏启动时间
    let gameStartTime = Date.now();
    let actionCount = 0;

    // 关键修复：集成修复版的核心游戏状态
    let gameState = {
      money: 300,                    // 修复版的平衡设置
      year: 1,
      season: 0,
      population: 80,               // 修复版的平衡设置
      weather: '正常',
      currentCrop: null,
      crops: {
        '水稻': 0, '小麦': 0, '玉米': 0, '大豆': 0, '高粱': 0, 
        '棉花': 0, '茶叶': 0, '甘蔗': 0, '橡胶': 0, '咖啡': 0, '可可': 0
      },
      farmerLevel: 1,
      totalIncome: 0,
      totalHarvests: 0,
      history: [],
      
      // 关键修复：新增修复版的核心变量
      consecutiveFailures: 0,       // 连续失败次数
      survivalPressure: 0,          // 生存压力值 
      failureWarnings: 0,           // 失败警告次数
      isGameOver: false,            // 游戏是否结束
      
      // 保留完整版的扩展功能
      reputation: 0,
      planting: { exp: 0, level: 1 },
      management: { exp: 0, level: 1 },
      market: { exp: 0, level: 1 },
      weatherPrediction: false,
      nextWeatherEvent: null,
      researchPoints: 0,
      ongoingResearch: null,
      completedResearch: [],
      equipment: [],
      survivalEquipment: [],
      joinedCoops: [],
      activePolicies: [],
      randomEvents: [],
      achievements: [],
      environmentalHealth: 100,
      sustainabilityScore: 0,
      carbonFootprint: 0,
      difficulty: 70,
      gameMode: 'normal',
      birthplace: null,
      endlessYearMultiplier: 1.0,
      maxPopulationReached: 80,
      longestSurvivalStreak: 0,
      totalEquipmentPurchased: 0,
      totalResearchCompleted: 0,
      totalPoliciesApplied: 0,
      totalEventsExperienced: 0,
      playerActivity: {
        lastAction: Date.now(),
        afkWarnings: 0,
        totalIdleTime: 0
      }
    };

    // 市场价格系统（完整版功能）
    let marketPrices = {
      '水稻': 18, '小麦': 22, '玉米': 16, '大豆': 25, '高粱': 20,
      '棉花': 35, '茶叶': 55, '甘蔗': 12, '橡胶': 85, '咖啡': 105, '可可': 140
    };

    // 关键修复：集成修复版的作物配置（保留完整版的11种作物）
    const CROPS = {
      '水稻': { baseYield: 60, basePrice: 18, modifiers: { '正常': 1.0, '干旱': 0.3, '洪水': 1.2, '灾害': 0.1 }},
      '小麦': { baseYield: 50, basePrice: 22, modifiers: { '正常': 1.0, '干旱': 0.2, '洪水': 0.8, '灾害': 0.1 }},
      '玉米': { baseYield: 70, basePrice: 16, modifiers: { '正常': 1.0, '干旱': 0.4, '洪水': 0.9, '灾害': 0.1 }},
      '大豆': { baseYield: 40, basePrice: 25, modifiers: { '正常': 1.0, '干旱': 0.5, '洪水': 0.7, '灾害': 0.1 }},
      '高粱': { baseYield: 60, basePrice: 20, modifiers: { '正常': 1.0, '干旱': 0.6, '洪水': 0.4, '灾害': 0.2 }},
      '棉花': { baseYield: 40, basePrice: 35, modifiers: { '正常': 1.0, '干旱': 0.2, '洪水': 0.3, '灾害': 0.1 }},
      '茶叶': { baseYield: 25, basePrice: 55, modifiers: { '正常': 1.0, '干旱': 0.5, '洪水': 0.7, '灾害': 0.2 }},
      '甘蔗': { baseYield: 120, basePrice: 12, modifiers: { '正常': 1.0, '干旱': 0.15, '洪水': 0.8, '灾害': 0.1 }},
      '橡胶': { baseYield: 20, basePrice: 85, modifiers: { '正常': 1.0, '干旱': 0.4, '洪水': 0.6, '灾害': 0.1 }},
      '咖啡': { baseYield: 15, basePrice: 105, modifiers: { '正常': 1.0, '干旱': 0.3, '洪水': 0.5, '灾害': 0.1 }},
      '可可': { baseYield: 12, basePrice: 140, modifiers: { '正常': 1.0, '干旱': 0.2, '洪水': 0.6, '灾害': 0.1 }}
    };

    // 关键修复：集成修复版的天气事件配置（更加严苛）
    const WEATHER_EVENTS = [
      { type: '正常', probability: 0.15, severity: 0, description: '风调雨顺' },  // 大幅降低正常天气概率
      { type: '干旱', probability: 0.35, severity: 2, description: '持续干旱，作物减产' },
      { type: '洪水', probability: 0.30, severity: 2, description: '洪水泛滥，部分作物被淹' },
      { type: '灾害', probability: 0.20, severity: 4, description: '极端灾害！' }
    ];

    // ===== 关键修复：修复版的核心函数 =====

    // 选择作物
    function chooseCrop(cropName) {
      if (gameState.isGameOver) return;
      
      gameState.currentCrop = cropName;
      
      // 更新UI
      document.querySelectorAll('.crop-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      addLog(`选择种植作物：${cropName}`, 'info');
      incrementActionCount();
      updateDisplay();
    }

    // 生成天气事件
    function generateWeatherEvent() {
      // 根据生存压力增加灾害概率
      const pressureMultiplier = 1 + (gameState.survivalPressure / 100);
      const random = Math.random();
      let cumulative = 0;
      
      for (const event of WEATHER_EVENTS) {
        const adjustedProbability = event.probability * pressureMultiplier;
        cumulative += adjustedProbability;
        if (random <= cumulative) {
          return { ...event };
        }
      }
      
      return WEATHER_EVENTS[0]; // 默认返回正常天气
    }

    // 计算收获
    function calculateHarvest(weatherEvent) {
      if (!gameState.currentCrop) return { quantity: 0, income: 0 };
      
      const crop = CROPS[gameState.currentCrop];
      const weatherModifier = crop.modifiers[weatherEvent.type] || crop.modifiers['正常'];
      
      let baseYield = crop.baseYield;
      let finalYield = baseYield * weatherModifier;
      
      // 人口影响产量（人口不足会严重影响产出）
      const populationFactor = Math.min(1.0, gameState.population / 100);
      finalYield *= populationFactor;
      
      const quantity = Math.floor(finalYield);
      const income = Math.floor(quantity * crop.basePrice);
      
      return { quantity, income, weatherModifier, populationFactor };
    }

    // 关键修复：处理灾害后果（移除人口保底！）
    function handleDisasterConsequences(weatherEvent) {
      const severity = weatherEvent.severity;
      
      if (severity > 1) {
        // 金钱损失 - 更加严重
        const moneyLoss = Math.floor(gameState.money * (0.2 + severity * 0.15));
        gameState.money = Math.max(0, gameState.money - moneyLoss);
        
        // 关键修复：人口损失 - 移除保底机制！
        const populationLoss = Math.floor(gameState.population * (0.1 + severity * 0.1));
        gameState.population = Math.max(0, gameState.population - populationLoss); // 允许人口归零！
        
        // 作物损失
        Object.keys(gameState.crops).forEach(cropType => {
          if (gameState.crops[cropType] > 0) {
            const lossPercentage = 0.3 + Math.random() * 0.4;
            const lostAmount = Math.floor(gameState.crops[cropType] * lossPercentage);
            gameState.crops[cropType] = Math.max(0, gameState.crops[cropType] - lostAmount);
          }
        });
        
        if (moneyLoss > 0) addLog(`💸 灾害损失：损失₹${moneyLoss}`, 'error');
        if (populationLoss > 0) addLog(`☠️ 人口损失：${populationLoss}人`, 'error');
        
        // 增加连续失败计数
        gameState.consecutiveFailures++;
        gameState.survivalPressure = Math.min(100, gameState.survivalPressure + severity * 10);
      } else {
        gameState.consecutiveFailures = Math.max(0, gameState.consecutiveFailures - 1);
        gameState.survivalPressure = Math.max(0, gameState.survivalPressure - 5);
      }
    }

    // 关键修复：检查游戏失败条件（新增！）
    function checkGameFailure() {
      let failureReason = null;
      
      // 人口归零
      if (gameState.population <= 0) {
        failureReason = '人口全部死亡，农庄彻底废弃！';
      }
      // 资金不足且连续失败
      else if (gameState.money <= 0 && gameState.consecutiveFailures >= 3) {
        failureReason = '资金耗尽且连续灾害，无法维持农庄运营！';
      }
      // 生存压力过高
      else if (gameState.survivalPressure >= 100) {
        failureReason = '生存压力过大，农庄崩溃！';
      }
      // 极端情况：人口过少且资金不足
      else if (gameState.population <= 5 && gameState.money <= 50) {
        failureReason = '人口过少且资金短缺，农庄无法维持！';
      }
      
      if (failureReason) {
        gameOver(failureReason);
        return true;
      }
      
      // 发出警告
      if ((gameState.population <= 10 || gameState.money <= 100 || gameState.survivalPressure >= 80) && gameState.failureWarnings < 3) {
        gameState.failureWarnings++;
        addLog(`⚠️ 警告${gameState.failureWarnings}/3：农庄面临严重危机！`, 'warning');
        updateCriticalWarning();
      }
      
      return false;
    }

    // 关键修复：游戏结束函数
    function gameOver(reason) {
      gameState.isGameOver = true;
      
      const stats = `
        <h3>失败原因：${reason}</h3>
        <p><strong>存活年数：</strong>${gameState.year - 1}年</p>
        <p><strong>最终人口：</strong>${gameState.population}人</p>
        <p><strong>最终资金：</strong>₹${gameState.money}</p>
        <p><strong>总收入：</strong>₹${gameState.totalIncome}</p>
        <p><strong>生存压力：</strong>${gameState.survivalPressure}%</p>
        <p><strong>连续失败：</strong>${gameState.consecutiveFailures}次</p>
      `;
      
      document.getElementById('game-over-stats').innerHTML = stats;
      document.getElementById('game-over-screen').style.display = 'flex';
      
      addLog(`💀 游戏结束：${reason}`, 'error');
    }

    // 关键修复：更新临界警告显示
    function updateCriticalWarning() {
      const warningDiv = document.getElementById('critical-warning');
      if (gameState.failureWarnings > 0 || gameState.survivalPressure >= 60) {
        warningDiv.style.display = 'block';
        warningDiv.textContent = `⚠️ 临界状态！警告 ${gameState.failureWarnings}/3 | 压力 ${gameState.survivalPressure}%`;
      } else {
        warningDiv.style.display = 'none';
      }
    }

    // 重新开始游戏
    function restartGame() {
      gameState = {
        money: 300,
        year: 1,
        season: 0,
        population: 80,
        weather: '正常',
        currentCrop: null,
        crops: {
          '水稻': 0, '小麦': 0, '玉米': 0, '大豆': 0, '高粱': 0, 
          '棉花': 0, '茶叶': 0, '甘蔗': 0, '橡胶': 0, '咖啡': 0, '可可': 0
        },
        farmerLevel: 1,
        totalIncome: 0,
        totalHarvests: 0,
        history: [],
        consecutiveFailures: 0,
        survivalPressure: 0,
        failureWarnings: 0,
        isGameOver: false,
        reputation: 0,
        planting: { exp: 0, level: 1 },
        management: { exp: 0, level: 1 },
        market: { exp: 0, level: 1 },
        weatherPrediction: false,
        nextWeatherEvent: null,
        researchPoints: 0,
        ongoingResearch: null,
        completedResearch: [],
        equipment: [],
        survivalEquipment: [],
        joinedCoops: [],
        activePolicies: [],
        randomEvents: [],
        achievements: [],
        environmentalHealth: 100,
        sustainabilityScore: 0,
        carbonFootprint: 0,
        difficulty: 70,
        gameMode: 'normal',
        birthplace: null,
        endlessYearMultiplier: 1.0,
        maxPopulationReached: 80,
        longestSurvivalStreak: 0,
        totalEquipmentPurchased: 0,
        totalResearchCompleted: 0,
        totalPoliciesApplied: 0,
        totalEventsExperienced: 0,
        playerActivity: {
          lastAction: Date.now(),
          afkWarnings: 0,
          totalIdleTime: 0
        }
      };
      
      document.getElementById('game-over-screen').style.display = 'none';
      document.getElementById('log-container').innerHTML = '';
      document.querySelectorAll('.crop-button').forEach(btn => btn.classList.remove('selected'));
      
      addLog('游戏重新开始！v2.6修复版激活！', 'info');
      addLog('警告：人口可能完全死亡，无限生存漏洞已修复！', 'warning');
      updateDisplay();
    }

    // 关键修复：下一回合（集成修复版的检查）
    function nextTurn() {
      if (gameState.isGameOver) return;
      
      if (!gameState.currentCrop) {
        addLog('请先选择要种植的作物！', 'warning');
        return;
      }
      
      incrementActionCount();
      
      // 生成天气事件
      const weatherEvent = generateWeatherEvent();
      gameState.weather = weatherEvent.type;
      
      // 计算收获
      const harvestResult = calculateHarvest(weatherEvent);
      
      // 更新游戏状态
      gameState.year++;
      gameState.money += harvestResult.income;
      gameState.totalIncome += harvestResult.income;
      gameState.crops[gameState.currentCrop] += harvestResult.quantity;
      gameState.totalHarvests++;
      
      // 关键修复：处理灾害后果
      handleDisasterConsequences(weatherEvent);
      
      // 关键修复：检查失败条件
      if (checkGameFailure()) {
        return;
      }
      
      // 记录日志
      let logMessage = `第${gameState.year - 1}年：${weatherEvent.type}，收获${gameState.currentCrop} ${harvestResult.quantity}单位，收入₹${harvestResult.income}`;
      const logType = weatherEvent.severity > 2 ? 'error' : weatherEvent.severity > 1 ? 'warning' : 'success';
      addLog(logMessage, logType);
      
      // 更新历史记录
      gameState.history.push({
        year: gameState.year - 1,
        weather: weatherEvent.type,
        income: harvestResult.income,
        crop: gameState.currentCrop
      });
      
      // 更新显示
      updateDisplay();
      updateEnhancedDisplay();
      updateMarketPrices();
      updateHistoryDisplay();
    }

    // 添加日志
    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('log-container');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[第${gameState.year}年] ${message}`;
      
      logDiv.insertBefore(entry, logDiv.firstChild);
      
      // 保持日志数量合理
      if (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.lastChild);
      }
    }

    // 关键修复：更新显示（集成两个版本）
    function updateDisplay() {
      document.getElementById('money-display').textContent = gameState.money;
      document.getElementById('year-display').textContent = gameState.year;
      document.getElementById('population-display').textContent = gameState.population;
      document.getElementById('weather-display').textContent = gameState.weather;
      document.getElementById('current-crop-display').textContent = gameState.currentCrop || '未选择';
      document.getElementById('farmer-level-display').textContent = gameState.farmerLevel;
      document.getElementById('reputation-display').textContent = gameState.reputation;
      
      // 关键修复：显示生存压力和失败警告
      document.getElementById('survival-pressure-display').textContent = gameState.survivalPressure + '%';
      document.getElementById('failure-warnings-display').textContent = `${gameState.failureWarnings}/3`;
      
      // 更新状态颜色
      const moneyElement = document.getElementById('money-display');
      const populationElement = document.getElementById('population-display');
      const pressureElement = document.getElementById('survival-pressure-display');
      
      moneyElement.style.color = gameState.money < 100 ? '#ff0000' : '#4CAF50';
      populationElement.style.color = gameState.population < 20 ? '#ff0000' : '#2196F3';
      pressureElement.style.color = gameState.survivalPressure > 60 ? '#ff0000' : '#333';
      
      updateCriticalWarning();
    }

    // ===== 完整版的扩展功能（保持原有逻辑） =====

    // 增加操作计数
    function incrementActionCount() {
      actionCount++;
      gameState.playerActivity.lastAction = Date.now();
    }

    // 增强的游戏状态更新
    function updateEnhancedDisplay() {
      // 更新游戏时长
      const gameTime = Math.floor((Date.now() - gameStartTime) / 60000);
      document.getElementById('game-duration').textContent = gameTime;
      
      // 更新操作次数和APM
      document.getElementById('action-count').textContent = actionCount;
      const apm = gameTime > 0 ? Math.round(actionCount / gameTime) : 0;
      document.getElementById('apm').textContent = apm;
      
      // 更新效率评分
      const efficiency = Math.min(100, Math.round((gameState.totalIncome / Math.max(1, gameState.year)) / 100));
      document.getElementById('efficiency-score').textContent = efficiency;
      
      // 更新统计数据
      document.getElementById('total-equipment').textContent = gameState.totalEquipmentPurchased;
      document.getElementById('total-research').textContent = gameState.totalResearchCompleted;
      document.getElementById('total-policies').textContent = gameState.totalPoliciesApplied;
      document.getElementById('total-events').textContent = gameState.totalEventsExperienced;
      document.getElementById('max-population').textContent = gameState.maxPopulationReached;
      document.getElementById('longest-streak').textContent = gameState.longestSurvivalStreak;
      document.getElementById('env-score').textContent = gameState.environmentalHealth;
      
      // 更新环境系统
      document.getElementById('environmental-health').textContent = gameState.environmentalHealth;
      document.getElementById('sustainability-score').textContent = gameState.sustainabilityScore;
      document.getElementById('carbon-footprint').textContent = gameState.carbonFootprint;
      document.getElementById('environmental-progress').style.width = gameState.environmentalHealth + '%';
    }

    // 更新市场价格
    function updateMarketPrices() {
      Object.keys(marketPrices).forEach(crop => {
        const volatility = 0.1 + Math.random() * 0.2;
        const change = (Math.random() - 0.5) * volatility;
        marketPrices[crop] = Math.max(1, marketPrices[crop] * (1 + change));
      });
    }

    // 更新历史显示
    function updateHistoryDisplay() {
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = gameState.history.slice(-10).reverse().map(record => `
        <tr>
          <td>${record.year}</td>
          <td>${record.weather}</td>
          <td>₹${record.income}</td>
          <td>${record.crop}</td>
        </tr>
      `).join('');
    }

    // 初始化游戏
    function initializeGame() {
      addLog('欢迎来到季风决策者v2.6.2-overlay').style.display = 'none';
      document.getElementById('birthplace-overlay').style.display = 'block';
    }
    function selectBirthplace(place) {
      gameState.birthplace = place;
      document.getElementById('birthplace-overlay').style.display = 'none';
      addLog(`选择出生地：${place}`, 'info');
    }
    function selectDifficulty(level) {
      gameState.difficulty = level;
      addLog(`设置难度：${level}%`, 'info');
    }
    function selectGameMode(mode) {
      gameState.gameMode = mode;
      addLog(`选择游戏模式：${mode}`, 'info');
    }

    // 页面加载完成后初始化
    window.addEventListener('load', function() {
      initializeGame();
    });
  </script>
</body>

</html>
