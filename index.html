<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­£é£å†³ç­–è€…v2.4</title>
  <link rel="icon" href="./f.ico">
  <style>
    :root {
      --flood-color: #006994;
      --drought-color: #8B4513;
      --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-bg: rgba(255, 255, 255, 0.95);
      --accent-color: #FF5722;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --danger-color: #f44336;
      --info-color: #2196F3;
      --policy-bg: rgba(255, 249, 230, 0.9);
      --policy-border: #ffd700;
      --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--primary-bg);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }

    .game-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      min-height: 100vh;
    }

    .main-content {
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 20px;
    }

    .game-header {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
      background-image: url('imgs/beautiful_farm_agriculture_landscape_sunset_game_background.jpg');
      background-size: cover;
      background-position: center;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      position: relative;
    }

    .game-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      border-radius: var(--border-radius);
    }

    .game-header * {
      position: relative;
      z-index: 1;
    }

    .status-bar {
      background: var(--secondary-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .status-item {
      text-align: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      border-left: 4px solid var(--accent-color);
      transition: var(--transition);
    }

    .status-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .status-value {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--accent-color);
    }

    .status-label {
      font-size: 0.8em;
      color: #666;
      margin-top: 2px;
    }

    .game-board {
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .map-container {
      background: linear-gradient(45deg, #8FBC8F, #98FB98);
      border-radius: var(--border-radius);
      height: 250px;
      position: relative;
      overflow: hidden;
      background-image: url('imgs/farm_background_for_agriculture_simulator_game.jpg');
      background-size: cover;
      background-position: center;
    }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      z-index: 10;
    }

    .satellite-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      transition: all 0.5s ease;
    }

    .flood-effect {
      background: radial-gradient(circle, transparent 30%, rgba(0, 105, 148, 0.3) 70%);
      animation: flood-wave 2s infinite;
    }

    .drought-effect {
      background: radial-gradient(circle, transparent 30%, rgba(139, 69, 19, 0.3) 70%);
      animation: heat-shimmer 3s infinite;
    }

    @keyframes flood-wave {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes heat-shimmer {
      0%, 100% { filter: hue-rotate(0deg); }
      50% { filter: hue-rotate(30deg); }
    }

    .particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(100px) translateX(0);
        opacity: 1;
      }
      100% {
        transform: translateY(-20px) translateX(20px);
        opacity: 0;
      }
    }

    .game-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .control-section {
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .crop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
    }

    .crop-button {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 0.9em;
    }

    .crop-button:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .crop-button.selected {
      border-color: var(--success-color);
      background: var(--success-color);
      color: white;
    }

    .crop-icon {
      font-size: 1.5em;
      display: block;
      margin-bottom: 4px;
    }

    .crop-description {
      font-size: 0.7em;
      color: #666;
      line-height: 1.2;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
    }

    .panel-header {
      background: var(--accent-color);
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .panel-content {
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .policy-card {
      background: var(--policy-bg);
      border: 2px solid var(--policy-border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .policy-card h4 {
      color: #B8860B;
      margin-bottom: 5px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
      text-decoration: none;
      display: inline-block;
      text-align: center;
      font-size: 0.9em;
    }

    .success-btn {
      background: var(--success-color);
      color: white;
    }

    .success-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
    }

    .warning-btn {
      background: var(--warning-color);
      color: white;
    }

    .warning-btn:hover {
      background: #f57c00;
      transform: translateY(-1px);
    }

    .danger-btn {
      background: var(--danger-color);
      color: white;
    }

    .danger-btn:hover {
      background: #d32f2f;
      transform: translateY(-1px);
    }

    .info-btn {
      background: var(--info-color);
      color: white;
    }

    .info-btn:hover {
      background: #1976d2;
      transform: translateY(-1px);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-content.success {
      border-left: 5px solid var(--success-color);
    }

    .modal-content.failure {
      border-left: 5px solid var(--danger-color);
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }

    .close-btn:hover {
      color: #000;
    }

    /* æŠ€èƒ½æ¡æ ·å¼ */
    .skill-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin: 5px 0 10px 0;
      overflow: hidden;
    }

    .skill-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--success-color), var(--warning-color));
      transition: width 0.5s ease;
    }

    /* å¸‚åœºç›¸å…³æ ·å¼ */
    .market-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      background: rgba(255, 255, 255, 0.5);
      margin: 5px 0;
      border-radius: 4px;
    }

    .market-item:last-child {
      border-bottom: none;
    }

    .market-item-info {
      flex: 1;
    }

    .market-controls {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .market-input {
      width: 60px;
      padding: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    /* æ—¥å¿—æ ·å¼ */
    .log-container {
      max-height: 150px;
      overflow-y: auto;
      background: #f5f5f5;
      border-radius: 4px;
      padding: 10px;
      font-family: monospace;
      font-size: 0.8em;
    }

    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }

    .log-entry.success {
      color: var(--success-color);
    }

    .log-entry.warning {
      color: var(--warning-color);
    }

    .log-entry.error {
      color: var(--danger-color);
    }

    .log-entry.info {
      color: var(--info-color);
    }

    /* å†å²è¡¨æ ¼æ ·å¼ */
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8em;
    }

    .history-table th,
    .history-table td {
      padding: 5px 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .history-table th {
      background: #f0f0f0;
      font-weight: bold;
    }

    /* æˆå°±æ ·å¼ */
    .achievement-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.5);
    }

    .achievement-item.unlocked {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid var(--success-color);
    }

    .achievement-item.locked {
      background: rgba(0, 0, 0, 0.05);
      opacity: 0.6;
    }

    .achievement-icon {
      font-size: 1.5em;
      margin-right: 10px;
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-name {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .achievement-desc {
      font-size: 0.8em;
      color: #666;
    }

    /* æ–°å¢ï¼šå£°æœ›ç³»ç»Ÿæ ·å¼ */
    .reputation-bar {
      background: linear-gradient(90deg, #ff6b6b, #ffa500, #4ecdc4, #45b7d1, #96ceb4);
      height: 10px;
      border-radius: 5px;
      position: relative;
      margin: 5px 0;
    }

    .reputation-indicator {
      position: absolute;
      top: -2px;
      width: 6px;
      height: 14px;
      background: white;
      border: 2px solid #333;
      border-radius: 2px;
      transition: left 0.5s ease;
    }

    /* æ–°å¢ï¼šå­£èŠ‚æ•ˆæœæ ·å¼ */
    .season-effect {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      border-left: 4px solid var(--info-color);
    }

    /* æ–°å¢ï¼šåˆä½œç¤¾æ ·å¼ */
    .coop-panel {
      background: rgba(255, 248, 220, 0.9);
      border: 2px solid #daa520;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    /* æ–°å¢ï¼šç ”å‘ç³»ç»Ÿæ ·å¼ */
    .research-item {
      background: rgba(240, 248, 255, 0.9);
      border: 1px solid #87ceeb;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      cursor: pointer;
      transition: var(--transition);
    }

    .research-item:hover {
      background: rgba(135, 206, 235, 0.2);
      transform: translateX(5px);
    }

    .research-item.completed {
      background: rgba(144, 238, 144, 0.3);
      border-color: var(--success-color);
    }

    .research-item.in-progress {
      background: rgba(255, 255, 0, 0.2);
      border-color: var(--warning-color);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media screen and (max-width: 1200px) {
      .game-container {
        grid-template-columns: 1fr;
        max-width: 800px;
      }
      
      .sidebar {
        grid-row: 1;
      }
    }

    @media screen and (max-width: 768px) {
      .game-container {
        padding: 10px;
        gap: 10px;
      }
      
      .status-bar {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .game-board {
        grid-template-columns: 1fr;
      }
      
      .crop-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <!-- æ¨¡å¼é€‰æ‹©å¼¹çª— -->
  <div id="mode-selection-modal" class="modal" style="display: flex;">
    <div class="modal-content">
      <h2>ğŸŒ¦ï¸ å­£é£å†³ç­–è€…v2.4</h2>
      <p>é€‰æ‹©æ‚¨çš„æŒ‘æˆ˜æ¨¡å¼</p>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin: 10px 0;">
          <input type="radio" name="game-mode" value="tutorial" checked> 
          ğŸ“ æ•™å­¦æ¨¡å¼ (æ¨èæ–°æ‰‹)
        </label>
        <label style="display: block; margin: 10px 0;">
          <input type="radio" name="game-mode" value="challenge"> 
          ğŸ¯ æŒ‘æˆ˜æ¨¡å¼ (é™æ—¶æŒ‘æˆ˜)
        </label>
        <label style="display: block; margin: 10px 0;">
          <input type="radio" name="game-mode" value="endless"> 
          â™¾ï¸ æ— å°½æ¨¡å¼ (è‡ªç”±å‘å±•)
        </label>
        <label style="display: block; margin: 10px 0;">
          <input type="radio" name="game-mode" value="extreme"> 
          ğŸ’€ æé™æ¨¡å¼ (ä¸“å®¶æŒ‘æˆ˜)
        </label>
      </div>
      
      <div id="challenge-settings" style="margin: 20px 0; display: none;">
        <label for="challenge-years">æŒ‘æˆ˜å¹´é™:</label>
        <input type="number" id="challenge-years" min="5" max="50" value="20" style="margin: 0 10px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label>é€‰æ‹©éš¾åº¦:</label>
        <select id="difficulty" style="margin-left: 10px; padding: 5px;">
          <option value="10">ğŸŒ± æ–°æ‰‹ (10%)</option>
          <option value="25">ğŸŒ¿ ç®€å• (25%)</option>
          <option value="50" selected>ğŸŒ¾ æ™®é€š (50%)</option>
          <option value="75">ğŸŒªï¸ å›°éš¾ (75%)</option>
          <option value="90">ğŸ’€ åœ°ç‹± (90%)</option>
          <option value="100">ğŸ”¥ å™©æ¢¦ (100%)</option>
        </select>
      </div>
      
      <button onclick="startSettings()" class="btn success-btn">ä¸‹ä¸€æ­¥ â†’</button>
    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <h2>ğŸŒ é€‰æ‹©å‡ºç”Ÿåœ°</h2>
      <div id="birthplace-selection" style="text-align: left;">
        <div class="birthplace-option" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4>ğŸ‡¨ğŸ‡³ ä¸­å›½</h4>
          <p>å¤šæ ·æ°”å€™ï¼Œå†œä¸šå‘è¾¾ï¼ŒæŠ€æœ¯å…ˆè¿›</p>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="china-north" checked> ååŒ—å¹³åŸ (å°éº¦ä¸»äº§åŒº)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="china-south"> é•¿æ±Ÿä¸­ä¸‹æ¸¸ (æ°´ç¨»ä¸»äº§åŒº)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="china-west"> è¥¿åŒ—åœ°åŒº (å¹²æ—±é€‚åº”)
          </label>
        </div>
        
        <div class="birthplace-option" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4>ğŸ‡·ğŸ‡º ä¿„ç½—æ–¯</h4>
          <p>æ°”å€™ä¸¥å¯’ï¼ŒåœŸåœ°å¹¿é˜”ï¼Œæœºæ¢°åŒ–ç¨‹åº¦é«˜</p>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="russia-south"> å—éƒ¨å¹³åŸ (è°·ç‰©äº§åŒº)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="russia-west"> è¥¿ä¼¯åˆ©äºš (ä¸¥å¯’æŒ‘æˆ˜)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="russia-east"> è¿œä¸œåœ°åŒº (è¾¹å¢ƒå‘å±•)
          </label>
        </div>
        
        <div class="birthplace-option" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4>ğŸŒ´ ä¸œå—äºš</h4>
          <p>çƒ­å¸¦æ°”å€™ï¼Œå­£é£æ˜æ˜¾ï¼Œå¤šæ ·åŒ–ç§æ¤</p>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="sea-thailand"> æ³°å›½ä¸­éƒ¨ (ç¨»ç±³ç‹å›½)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="sea-vietnam"> è¶Šå—åŒ—éƒ¨ (å­£é£æ°´ç¨»)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="sea-indonesia"> å°å°¼ç¾¤å²› (å¤šå²›ç»æµ)
          </label>
        </div>
        
        <div class="birthplace-option" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4>ğŸ‡®ğŸ‡³ å°åº¦</h4>
          <p>å­£é£ä¾èµ–ï¼Œäººå£ä¼—å¤šï¼Œä¼ ç»Ÿä¸ç°ä»£å¹¶å­˜</p>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="india-north"> åŒ—éƒ¨å¹³åŸ (æ’æ²³æµåŸŸ)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="india-south"> å—éƒ¨é«˜åŸ (é¦™æ–™äº§åŒº)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="india-east"> ä¸œéƒ¨æ²¿æµ· (å­£é£å‰æ²¿)
          </label>
        </div>

        <div class="birthplace-option" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4>ğŸŒ éæ´²</h4>
          <p>æŒ‘æˆ˜ä¸æœºé‡å¹¶å­˜ï¼Œæ°”å€™å¤šå˜</p>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="africa-east"> ä¸œéé«˜åŸ (å’–å•¡äº§åŒº)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="africa-west"> è¥¿éå¹³åŸ (å¯å¯äº§åŒº)
          </label>
          <label style="margin: 5px 0; display: block;">
            <input type="radio" name="birthplace" value="africa-south"> å—éè‰åŸ (å¤šæ ·å†œä¸š)
          </label>
        </div>
      </div>
      <button onclick="startGame()" class="btn success-btn">å¼€å§‹æ¸¸æˆ ğŸš€</button>
    </div>
  </div>

  <!-- æ•™ç¨‹å¼¹çª— -->
  <div id="tutorial-overlay" class="modal">
    <div class="modal-content">
      <h2>ğŸ“ æ¸¸æˆæ•™ç¨‹</h2>
      <p id="tutorial-text">æ¬¢è¿æ¥åˆ°å­£é£å†³ç­–è€…å¢å¼ºç‰ˆï¼</p>
      <div style="margin: 20px 0;">
        <button onclick="nextTutorial()" class="btn success-btn">ä¸‹ä¸€æ­¥</button>
        <button onclick="skipTutorial()" class="btn warning-btn">è·³è¿‡æ•™ç¨‹</button>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
  <div id="game-over-modal" class="modal">
    <div class="modal-content" id="modal-content">
      <h2 id="modal-title">æ¸¸æˆç»“æŸ</h2>
      <p id="modal-message">æ‚¨çš„å†œåœºç»è¥ç»“æŸäº†</p>
      <div style="margin: 20px 0;">
        <button onclick="restartGame()" class="btn success-btn">é‡æ–°å¼€å§‹</button>
        <button onclick="exportScore()" class="btn info-btn">å¯¼å‡ºæˆ˜ç»©</button>
      </div>
    </div>
  </div>

  <!-- å¸‚åœºå¼¹çª— -->
  <div id="market-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeMarket()">&times;</span>
      <h2>ğŸª å†œäº§å“å¸‚åœº</h2>
      <div id="market-content">
        <!-- å¸‚åœºå†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div style="margin-top: 20px;">
        <button onclick="closeMarket()" class="btn warning-btn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- è´·æ¬¾ä¸­å¿ƒå¼¹çª— -->
  <div id="loan-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeLoanCenter()">&times;</span>
      <h2>ğŸ¦ è´·æ¬¾ä¸­å¿ƒ</h2>
      <div id="loan-content">
        <!-- è´·æ¬¾å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div style="margin-top: 20px;">
        <button onclick="closeLoanCenter()" class="btn warning-btn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- ä¿é™©å¼¹çª— -->
  <div id="insurance-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeInsurance()">&times;</span>
      <h2>ğŸ›¡ï¸ å†œä¸šä¿é™©</h2>
      <div id="insurance-content">
        <!-- ä¿é™©å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div style="margin-top: 20px;">
        <button onclick="closeInsurance()" class="btn warning-btn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ï¼šåˆä½œç¤¾å¼¹çª— -->
  <div id="coop-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeCoop()">&times;</span>
      <h2>ğŸ¤ å†œä¸šåˆä½œç¤¾</h2>
      <div id="coop-content">
        <!-- åˆä½œç¤¾å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div style="margin-top: 20px;">
        <button onclick="closeCoop()" class="btn warning-btn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ï¼šç ”å‘ä¸­å¿ƒå¼¹çª— -->
  <div id="research-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeResearch()">&times;</span>
      <h2>ğŸ”¬ å†œä¸šç ”å‘ä¸­å¿ƒ</h2>
      <div id="research-content">
        <!-- ç ”å‘å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div style="margin-top: 20px;">
        <button onclick="closeResearch()" class="btn warning-btn">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- å¯¼å‡ºæˆ˜ç»©å¼¹çª— -->
  <div id="export-score-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeExportModal()">&times;</span>
      <h2>ğŸ“Š å¯¼å‡ºæˆ˜ç»©</h2>
      <div style="margin: 20px 0;">
        <label for="player-name">å†œåœºä¸»å§“å:</label>
        <input type="text" id="player-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="exportScoreImage()" class="btn success-btn">å¯¼å‡ºå›¾ç‰‡</button>
        <button onclick="exportScoreJSON()" class="btn info-btn">å¯¼å‡ºæ•°æ®</button>
        <button onclick="exportDetailedReport()" class="btn warning-btn">è¯¦ç»†æŠ¥å‘Š</button>
        <button onclick="backupGameData()" class="btn danger-btn">å¤‡ä»½å­˜æ¡£</button>
      </div>
      <div style="margin-top: 15px;">
        <label for="import-data">æ¢å¤å­˜æ¡£:</label>
        <input type="file" id="import-data" accept=".json" onchange="restoreGameData(event)" style="width: 100%; margin: 5px 0;">
      </div>
    </div>
  </div>

  <div class="game-container">
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <!-- æ¸¸æˆæ ‡é¢˜ -->
      <div class="game-header">
        <h1>ğŸŒ¦ï¸ å­£é£å†³ç­–è€…v2.4 ğŸšœ</h1>
        <p>ç®¡ç†æ‚¨çš„å†œåœºï¼Œåº”å¯¹å­£é£æŒ‘æˆ˜ï¼Œæˆä¸ºå†œä¸šä¼ å¥‡ï¼</p>
      </div>

      <!-- çŠ¶æ€æ  -->
      <div class="status-bar">
        <div class="status-item">
          <div class="status-value">â‚¹<span id="money">2000</span></div>
          <div class="status-label">ğŸ’° èµ„é‡‘</div>
        </div>
        <div class="status-item">
          <div class="status-value"><span id="current-population">200</span></div>
          <div class="status-label">ğŸ‘¥ äººå£</div>
        </div>
        <div class="status-item">
          <div class="status-value"><span id="current-year">1</span></div>
          <div class="status-label">ğŸ“… å¹´ä»½</div>
        </div>
        <div class="status-item">
          <div class="status-value"><span id="climate-risk">30</span>%</div>
          <div class="status-label">ğŸŒ¡ï¸ æ°”å€™é£é™©</div>
        </div>
        <div class="status-item">
          <div class="status-value">Lv.<span id="farmer-level">1</span></div>
          <div class="status-label">ğŸ‘¨â€ğŸŒ¾ å†œæ°‘ç­‰çº§</div>
        </div>
        <div class="status-item">
          <div class="status-value"><span id="current-season">æ˜¥å­£</span></div>
          <div class="status-label">ğŸŒ¸ å½“å‰å­£èŠ‚</div>
        </div>
        <div class="status-item">
          <div class="status-value"><span id="reputation">50</span></div>
          <div class="status-label">ğŸŒŸ å£°æœ›</div>
        </div>
        <div class="status-item">
          <div class="status-value"><span id="research-points">0</span></div>
          <div class="status-label">ğŸ§ª ç ”å‘ç‚¹</div>
        </div>
      </div>

      <!-- æ¸¸æˆé¢æ¿ -->
      <div class="game-board">
        <!-- åœ°å›¾åŒºåŸŸ -->
        <div class="map-container" id="map-container">
          <div class="map-overlay" id="map-overlay">æ­£å¸¸å¤©æ°”</div>
          <div class="satellite-overlay" id="satellite-overlay"></div>
          <div class="particles" id="particles"></div>
        </div>

        <!-- æ¸¸æˆæ§åˆ¶åŒº -->
        <div class="game-controls">
          <!-- æ”¿ç­–æ˜¾ç¤º -->
          <div id="policy-effect" class="policy-card" style="display: none;">
            <h4>ğŸ“œ å½“å‰æ”¿ç­–</h4>
            <p id="policy-text">æ— æ´»è·ƒæ”¿ç­–</p>
          </div>

          <!-- å­£èŠ‚æ•ˆæœæ˜¾ç¤º -->
          <div id="season-effect" class="season-effect">
            <h4>ğŸŒ¸ å­£èŠ‚æ•ˆæœ</h4>
            <p id="season-text">æ˜¥å­£ï¼šä¸‡ç‰©å¤è‹ï¼Œä½œç‰©ç”Ÿé•¿è‰¯å¥½</p>
          </div>

          <!-- ä½œç‰©é€‰æ‹© -->
          <div class="control-section">
            <div class="section-title">
              ğŸŒ± é€‰æ‹©ä½œç‰©
              <span style="font-size: 0.8em; color: #666;">(å½“å‰: <span id="current-crop-display">æ— </span>)</span>
            </div>
            <div class="crop-grid" id="crop-grid">
              <!-- ä¸»è¦ç²®é£Ÿä½œç‰© -->
              <button class="crop-button" onclick="chooseCrop('æ°´ç¨»')" data-crop="æ°´ç¨»">
                <span class="crop-icon">ğŸŒ¾</span>
                <div>æ°´ç¨»</div>
                <div class="crop-description">é€‚åº”æ´ªæ°´<br>åŸºç¡€äº§é‡</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('å°éº¦')" data-crop="å°éº¦">
                <span class="crop-icon">ğŸŒ¾</span>
                <div>å°éº¦</div>
                <div class="crop-description">æ­£å¸¸æ°”å€™<br>ç¨³å®šæ”¶ç›Š</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('ç‰ç±³')" data-crop="ç‰ç±³">
                <span class="crop-icon">ğŸŒ½</span>
                <div>ç‰ç±³</div>
                <div class="crop-description">é«˜äº§é‡<br>æ­£å¸¸ç¯å¢ƒ</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('é«˜ç²±')" data-crop="é«˜ç²±">
                <span class="crop-icon">ğŸŒ¾</span>
                <div>é«˜ç²±</div>
                <div class="crop-description">æŠ—æ—±<br>å¹²æ—±é€‚åº”</div>
              </button>
              <!-- ç»æµä½œç‰© -->
              <button class="crop-button" onclick="chooseCrop('æ£‰èŠ±')" data-crop="æ£‰èŠ±">
                <span class="crop-icon">ğŸŒ¿</span>
                <div>æ£‰èŠ±</div>
                <div class="crop-description">ç»æµä½œç‰©<br>é«˜ä»·å€¼</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('èŒ¶å¶')" data-crop="èŒ¶å¶">
                <span class="crop-icon">ğŸƒ</span>
                <div>èŒ¶å¶</div>
                <div class="crop-description">å±±åœ°ä½œç‰©<br>ç‰¹æ®Šç¯å¢ƒ</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('ç”˜è”—')" data-crop="ç”˜è”—">
                <span class="crop-icon">ğŸ‹</span>
                <div>ç”˜è”—</div>
                <div class="crop-description">çƒ­å¸¦ä½œç‰©<br>é«˜æ¸©å¤šæ¹¿</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('æ©¡èƒ¶')" data-crop="æ©¡èƒ¶">
                <span class="crop-icon">ğŸŒ³</span>
                <div>æ©¡èƒ¶</div>
                <div class="crop-description">çƒ­å¸¦ç»æµ<br>é•¿æœŸæŠ•èµ„</div>
              </button>
              <!-- æ–°å¢ç‰¹æ®Šä½œç‰© -->
              <button class="crop-button" onclick="chooseCrop('å’–å•¡')" data-crop="å’–å•¡">
                <span class="crop-icon">â˜•</span>
                <div>å’–å•¡</div>
                <div class="crop-description">é«˜ä»·ç»æµ<br>å±±åœ°ç§æ¤</div>
              </button>
              <button class="crop-button" onclick="chooseCrop('å¯å¯')" data-crop="å¯å¯">
                <span class="crop-icon">ğŸ«</span>
                <div>å¯å¯</div>
                <div class="crop-description">çƒ­å¸¦çå“<br>é•¿æœŸæ”¶ç›Š</div>
              </button>
            </div>
          </div>

          <!-- æ“ä½œæŒ‰é’® -->
          <div class="control-section">
            <div class="section-title">ğŸ® æ¸¸æˆæ“ä½œ</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
              <button onclick="nextTurn()" id="next-turn-btn" class="btn success-btn">ä¸‹ä¸€å›åˆ â­ï¸</button>
              <button onclick="showMarket()" class="btn warning-btn">å¸‚åœºäº¤æ˜“ ğŸª</button>
              <button onclick="showLoanCenter()" class="btn danger-btn">è´·æ¬¾ä¸­å¿ƒ ğŸ¦</button>
              <button onclick="showInsurance()" class="btn info-btn">å†œä¸šä¿é™© ğŸ›¡ï¸</button>
              <button onclick="showCoop()" class="btn success-btn">åˆä½œç¤¾ ğŸ¤</button>
              <button onclick="showResearch()" class="btn info-btn">ç ”å‘ä¸­å¿ƒ ğŸ”¬</button>
            </div>
          </div>

          <!-- æŠ€èƒ½ä¸ç»éªŒ -->
          <div class="control-section">
            <div class="section-title">ğŸ“ˆ å†œæ°‘æŠ€èƒ½</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div style="margin-bottom: 8px;">
                ç§æ¤ç»éªŒ: <span id="planting-exp">0</span>/<span id="planting-exp-needed">100</span>
                <div class="skill-bar">
                  <div class="skill-progress" id="planting-progress" style="width: 0%"></div>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                ç®¡ç†ç»éªŒ: <span id="management-exp">0</span>/<span id="management-exp-needed">100</span>
                <div class="skill-bar">
                  <div class="skill-progress" id="management-progress" style="width: 0%"></div>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                å¸‚åœºç»éªŒ: <span id="market-exp">0</span>/<span id="market-exp-needed">100</span>
                <div class="skill-bar">
                  <div class="skill-progress" id="market-progress" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- å£°æœ›ç³»ç»Ÿ -->
          <div class="control-section">
            <div class="section-title">ğŸŒŸ å£°æœ›ç³»ç»Ÿ</div>
            <div style="background: rgba(255,255,255,0.8); padding: 12px; border-radius: 8px;">
              <div>å£°æœ›ç­‰çº§: <span id="reputation-level">æ–°æ‰‹å†œæ°‘</span></div>
              <div class="reputation-bar">
                <div class="reputation-indicator" id="reputation-indicator"></div>
              </div>
              <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                <span id="reputation-desc">åˆšåˆšå¼€å§‹å†œä¸šç”Ÿæ¶¯</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å³ä¾§è¾¹æ  -->
    <div class="sidebar">
      <!-- å¸‚åœºé¢æ¿ -->
      <div class="panel">
        <div class="panel-header">
          ğŸª å†œäº§å“å¸‚åœº
        </div>
        <div class="panel-content" id="market-panel">
          <!-- å¸‚åœºå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- è®¾å¤‡é¢æ¿ -->
      <div class="panel">
        <div class="panel-header">
          ğŸ”§ å†œä¸šè®¾å¤‡
        </div>
        <div class="panel-content" id="equipment-panel">
          <!-- è®¾å¤‡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æˆå°±é¢æ¿ -->
      <div class="panel">
        <div class="panel-header">
          ğŸ† æˆå°±ä¸å¥–åŠ±
        </div>
        <div class="panel-content" id="achievement-panel">
          <p style="color: #666; text-align: center;">æš‚æ— æˆå°±</p>
        </div>
      </div>

      <!-- å†å²è®°å½• -->
      <div class="panel">
        <div class="panel-header">
          ğŸ“Š ç»è¥å†å²
        </div>
        <div class="panel-content">
          <table class="history-table">
            <thead>
              <tr>
                <th>å¹´ä»½</th>
                <th>å¤©æ°”</th>
                <th>æ”¶å…¥</th>
                <th>ä½œç‰©</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- å†å²è®°å½•å°†åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- æ—¥å¿—é¢æ¿ -->
      <div class="panel">
        <div class="panel-header">
          ğŸ“œ æ¸¸æˆæ—¥å¿—
        </div>
        <div class="panel-content">
          <div class="log-container" id="log-container">
            <!-- æ—¥å¿—å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ¸¸æˆé…ç½®å¯¹è±¡
    const GAME_CONFIG = {
      // ä½œç‰©é…ç½® - é‡æ–°å¹³è¡¡
      CROPS: {
        'æ°´ç¨»': {
          baseYield: 120,
          basePrice: 25,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.4,
            'æ´ªæ°´': 1.2,
            'ä¸¥é‡å¹²æ—±': 0.2,
            'ç—…è™«å®³': 0.6,
            'å°é£': 0.3,
            'éœœå†»': 0.5
          },
          seasons: { optimal: [1, 2], good: [0, 3], poor: [] }
        },
        'å°éº¦': {
          baseYield: 100,
          basePrice: 30,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.7,
            'æ´ªæ°´': 0.6,
            'ä¸¥é‡å¹²æ—±': 0.4,
            'ç—…è™«å®³': 0.7,
            'å°é£': 0.4,
            'éœœå†»': 0.3
          },
          seasons: { optimal: [0, 3], good: [1], poor: [2] }
        },
        'ç‰ç±³': {
          baseYield: 140,
          basePrice: 22,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.5,
            'æ´ªæ°´': 0.7,
            'ä¸¥é‡å¹²æ—±': 0.3,
            'ç—…è™«å®³': 0.8,
            'å°é£': 0.5,
            'éœœå†»': 0.6
          },
          seasons: { optimal: [1, 2], good: [0], poor: [3] }
        },
        'é«˜ç²±': {
          baseYield: 90,
          basePrice: 28,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.8,
            'æ´ªæ°´': 0.6,
            'ä¸¥é‡å¹²æ—±': 0.7,
            'ç—…è™«å®³': 0.9,
            'å°é£': 0.6,
            'éœœå†»': 0.7
          },
          seasons: { optimal: [1, 2], good: [0, 3], poor: [] }
        },
        'æ£‰èŠ±': {
          baseYield: 80,
          basePrice: 45,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.6,
            'æ´ªæ°´': 0.5,
            'ä¸¥é‡å¹²æ—±': 0.3,
            'ç—…è™«å®³': 0.4,
            'å°é£': 0.4,
            'éœœå†»': 0.5
          },
          seasons: { optimal: [1], good: [2], poor: [0, 3] }
        },
        'èŒ¶å¶': {
          baseYield: 60,
          basePrice: 65,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.7,
            'æ´ªæ°´': 0.8,
            'ä¸¥é‡å¹²æ—±': 0.5,
            'ç—…è™«å®³': 0.6,
            'å°é£': 0.7,
            'éœœå†»': 0.4
          },
          seasons: { optimal: [0, 1], good: [2], poor: [3] }
        },
        'ç”˜è”—': {
          baseYield: 160,
          basePrice: 18,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.5,
            'æ´ªæ°´': 1.1,
            'ä¸¥é‡å¹²æ—±': 0.2,
            'ç—…è™«å®³': 0.7,
            'å°é£': 0.6,
            'éœœå†»': 0.1
          },
          seasons: { optimal: [1, 2], good: [0], poor: [3] }
        },
        'æ©¡èƒ¶': {
          baseYield: 40,
          basePrice: 85,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.8,
            'æ´ªæ°´': 1.0,
            'ä¸¥é‡å¹²æ—±': 0.6,
            'ç—…è™«å®³': 0.5,
            'å°é£': 0.7,
            'éœœå†»': 0.3
          },
          seasons: { optimal: [1, 2], good: [0, 3], poor: [] }
        },
        'å’–å•¡': {
          baseYield: 50,
          basePrice: 95,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.6,
            'æ´ªæ°´': 0.7,
            'ä¸¥é‡å¹²æ—±': 0.4,
            'ç—…è™«å®³': 0.3,
            'å°é£': 0.5,
            'éœœå†»': 0.2
          },
          seasons: { optimal: [0, 3], good: [1], poor: [2] }
        },
        'å¯å¯': {
          baseYield: 45,
          basePrice: 110,
          modifiers: {
            'æ­£å¸¸': 1.0,
            'å»¶è¿Ÿå¹²æ—±': 0.5,
            'æ´ªæ°´': 0.9,
            'ä¸¥é‡å¹²æ—±': 0.3,
            'ç—…è™«å®³': 0.4,
            'å°é£': 0.6,
            'éœœå†»': 0.1
          },
          seasons: { optimal: [1, 2], good: [0], poor: [3] }
        }
      },

      // è®¾å¤‡é…ç½® - é‡æ–°å¹³è¡¡
      EQUIPMENT: [
        {
          name: "åŸºç¡€çŒæº‰ç³»ç»Ÿ",
          cost: 300,
          effect: "å¹²æ—±å‡æŸ30%",
          description: "åŸºç¡€çš„æ»´çŒè®¾å¤‡ï¼Œæ˜¾è‘—å‡å°‘å¹²æ—±å¯¹ä½œç‰©çš„å½±å“",
          icon: "ğŸ’§",
          tier: 1
        },
        {
          name: "é˜²æ´ªå ¤å",
          cost: 450,
          effect: "æ´ªæ°´å‡æŸ35%",
          description: "ä¿æŠ¤å†œç”°å…å—æ´ªæ°´ä¾µå®³ï¼Œæä¾›ç¨³å®šä¿æŠ¤",
          icon: "ğŸŒŠ",
          tier: 1
        },
        {
          name: "æ°”è±¡ç›‘æµ‹ç«™",
          cost: 600,
          effect: "å¤©æ°”é¢„è­¦ï¼Œäº§é‡åŠ æˆ20%",
          description: "æå‰é¢„çŸ¥å¤©æ°”å˜åŒ–ï¼Œä¼˜åŒ–ç§æ¤å†³ç­–",
          icon: "ğŸŒ¡ï¸",
          tier: 2
        },
        {
          name: "ç°ä»£æ‹–æ‹‰æœº",
          cost: 800,
          effect: "ç§æ¤æ•ˆç‡æå‡25%",
          description: "æœºæ¢°åŒ–ä½œä¸šï¼Œå¤§å¹…æé«˜å†œä¸šç”Ÿäº§æ•ˆç‡",
          icon: "ğŸšœ",
          tier: 2
        },
        {
          name: "æ™ºèƒ½æ¸©å®¤",
          cost: 1500,
          effect: "å…¨å¤©å€™ä¿æŠ¤ï¼Œäº§é‡ç¿»å€",
          description: "æ§åˆ¶ç¯å¢ƒçš„é«˜ç§‘æŠ€å†œä¸šè®¾æ–½",
          icon: "ğŸ ",
          tier: 3
        },
        {
          name: "æ— äººæœºæ¤ä¿",
          cost: 1200,
          effect: "ç—…è™«å®³é˜²æ²»50%ï¼Œå“è´¨æå‡",
          description: "ç²¾å‡†å†œä¸šçš„ç°ä»£åŒ–å·¥å…·",
          icon: "ğŸš",
          tier: 3
        },
        {
          name: "åœŸå£¤æ”¹è‰¯è®¾å¤‡",
          cost: 900,
          effect: "æ‰€æœ‰ä½œç‰©åŸºç¡€äº§é‡+20%",
          description: "æ”¹å–„åœŸå£¤è´¨é‡ï¼Œæå‡ä½œç‰©æ ¹æœ¬äº§é‡",
          icon: "ğŸŒ±",
          tier: 2
        },
        {
          name: "æ™ºèƒ½ä¼ æ„Ÿå™¨ç½‘ç»œ",
          cost: 2000,
          effect: "ç²¾ç¡®ç›‘æ§ï¼Œäº§é‡+30%ï¼Œç¾å®³é¢„è­¦",
          description: "IoTå†œä¸šçš„æœªæ¥æŠ€æœ¯",
          icon: "ğŸ“¡",
          tier: 4
        },
        {
          name: "è‡ªåŠ¨æ”¶å‰²æœº",
          cost: 1800,
          effect: "æ”¶è·æ•ˆç‡+50%ï¼Œå‡å°‘æŸå¤±",
          description: "å…¨è‡ªåŠ¨æ”¶å‰²ï¼Œå‡å°‘äººåŠ›ä¾èµ–",
          icon: "ğŸ¤–",
          tier: 4
        }
      ],

      // æ”¿ç­–é…ç½® - å¢åŠ æ›´å¤šæ”¿ç­–
      POLICIES: [
        {
          name: "å‡ºå£è¡¥è´´",
          effect: () => gameState.incomeMultiplier *= 1.4,
          description: "æ”¿åºœè¡¥è´´å‡ºå£ï¼Œå†œäº§å“ä»·æ ¼ä¸Šæ¶¨40%",
          icon: "ğŸ“ˆ",
          duration: 2
        },
        {
          name: "ç§æ¤è¡¥è´´",
          effect: () => gameState.equipmentCostMultiplier = 0.6,
          description: "æ”¿åºœè¡¥è´´å†œä¸šè®¾å¤‡ï¼Œè´­ä¹°æˆæœ¬é™ä½40%",
          icon: "ğŸ",
          duration: 3
        },
        {
          name: "ç´§æ€¥æ•‘åŠ©",
          effect: () => {
            gameState.money += 800;
            gameState.reputation += 10;
          },
          description: "æ”¿åºœç´§æ€¥æ‹¨æ¬¾â‚¹800ç”¨äºç¾åé‡å»º",
          icon: "ğŸ†˜",
          duration: 1
        },
        {
          name: "æŠ€æœ¯æ¨å¹¿",
          effect: () => {
            gameState.incomeMultiplier *= 1.3;
            gameState.researchPoints += 20;
          },
          description: "æ–°æŠ€æœ¯æ¨å¹¿ï¼Œå†œä¸šäº§é‡æå‡30%ï¼Œè·å¾—ç ”å‘ç‚¹",
          icon: "ğŸ”¬",
          duration: 4
        },
        {
          name: "ç¯ä¿ç¨æ”¶",
          effect: () => gameState.incomeMultiplier *= 0.8,
          description: "ç¯ä¿æ”¿ç­–å®æ–½ï¼Œéƒ¨åˆ†æ”¶å…¥éœ€ç¼´ç¨20%",
          icon: "ğŸŒ±",
          duration: 3
        },
        {
          name: "è´¸æ˜“é™åˆ¶",
          effect: () => gameState.incomeMultiplier *= 0.65,
          description: "å›½é™…è´¸æ˜“é™åˆ¶ï¼Œå†œäº§å“ä»·æ ¼ä¸‹è·Œ35%",
          icon: "â›”",
          duration: 2
        },
        {
          name: "åˆä½œç¤¾æ¨å¹¿",
          effect: () => {
            gameState.coopBonus += 0.15;
            gameState.reputation += 15;
          },
          description: "æ”¿åºœæ¨å¹¿å†œä¸šåˆä½œç¤¾ï¼Œæå‡åˆä½œæ•ˆç›Š",
          icon: "ğŸ¤",
          duration: 5
        },
        {
          name: "ç»¿è‰²å†œä¸šè®¤è¯",
          effect: () => {
            gameState.incomeMultiplier *= 1.2;
            gameState.reputation += 20;
          },
          description: "ç»¿è‰²å†œä¸šè®¤è¯ï¼Œæå‡äº§å“ä»·å€¼å’Œå£°æœ›",
          icon: "ğŸ…",
          duration: 6
        }
      ],

      // å¤©æ°”äº‹ä»¶é…ç½® - é‡æ–°å¹³è¡¡
      WEATHER_EVENTS: [
        { type: "æ­£å¸¸", probability: 0.35, yieldFactor: 1.0, icon: "â˜€ï¸" },
        { type: "å»¶è¿Ÿå¹²æ—±", probability: 0.18, yieldFactor: 0.65, icon: "ğŸŒµ" },
        { type: "æ´ªæ°´", probability: 0.15, yieldFactor: 0.75, icon: "ğŸŒŠ" },
        { type: "ä¸¥é‡å¹²æ—±", probability: 0.12, yieldFactor: 0.35, icon: "ğŸœï¸" },
        { type: "ç—…è™«å®³", probability: 0.10, yieldFactor: 0.55, icon: "ğŸ›" },
        { type: "å°é£", probability: 0.06, yieldFactor: 0.25, icon: "ğŸŒ€" },
        { type: "éœœå†»", probability: 0.04, yieldFactor: 0.45, icon: "â„ï¸" }
      ],

      // å­£èŠ‚é…ç½®
      SEASONS: ["æ˜¥å­£", "å¤å­£", "ç§‹å­£", "å†¬å­£"],
      
      // å­£èŠ‚æ•ˆæœé…ç½®
      SEASON_EFFECTS: {
        0: { name: "æ˜¥å­£", description: "ä¸‡ç‰©å¤è‹ï¼Œä½œç‰©ç”Ÿé•¿è‰¯å¥½", modifier: 1.1 },
        1: { name: "å¤å­£", description: "é˜³å…‰å……è¶³ï¼Œä½†éœ€æ³¨æ„å¹²æ—±", modifier: 1.0 },
        2: { name: "ç§‹å­£", description: "æ”¶è·å­£èŠ‚ï¼Œäº§é‡ç¨æœ‰æå‡", modifier: 1.05 },
        3: { name: "å†¬å­£", description: "å¯’å†·å­£èŠ‚ï¼Œä½œç‰©ç”Ÿé•¿ç¼“æ…¢", modifier: 0.9 }
      },

      // ç ”å‘ç³»ç»Ÿé…ç½®
      RESEARCH: [
        {
          id: "drought_resistance",
          name: "æŠ—æ—±æŠ€æœ¯",
          cost: 50,
          effect: () => gameState.droughtResistance += 0.2,
          description: "æå‡ä½œç‰©æŠ—æ—±èƒ½åŠ›20%",
          icon: "ğŸŒµ",
          category: "cultivation"
        },
        {
          id: "pest_control",
          name: "ç”Ÿç‰©é˜²æ²»",
          cost: 60,
          effect: () => gameState.pestResistance += 0.25,
          description: "æå‡ç—…è™«å®³æŠ—æ€§25%",
          icon: "ğŸ›",
          category: "protection"
        },
        {
          id: "yield_enhancement",
          name: "é«˜äº§æŠ€æœ¯",
          cost: 80,
          effect: () => gameState.yieldBonus += 0.15,
          description: "åŸºç¡€äº§é‡æå‡15%",
          icon: "ğŸŒ¾",
          category: "cultivation"
        },
        {
          id: "market_analysis",
          name: "å¸‚åœºåˆ†æ",
          cost: 70,
          effect: () => gameState.marketInsight = true,
          description: "æå‰é¢„çŸ¥å¸‚åœºä»·æ ¼è¶‹åŠ¿",
          icon: "ğŸ“Š",
          category: "economics"
        },
        {
          id: "weather_prediction",
          name: "å¤©æ°”é¢„æµ‹",
          cost: 90,
          effect: () => gameState.weatherPrediction = true,
          description: "æå‰ä¸€è½®é¢„çŸ¥å¤©æ°”å˜åŒ–",
          icon: "ğŸŒ¦ï¸",
          category: "technology"
        },
        {
          id: "soil_optimization",
          name: "åœŸå£¤ä¼˜åŒ–",
          cost: 100,
          effect: () => gameState.soilQuality += 0.2,
          description: "åœŸå£¤è´¨é‡æå‡ï¼Œå…¨é¢å¢äº§20%",
          icon: "ğŸŒ",
          category: "cultivation"
        },
        {
          id: "automation",
          name: "å†œä¸šè‡ªåŠ¨åŒ–",
          cost: 150,
          effect: () => gameState.automation += 0.3,
          description: "è‡ªåŠ¨åŒ–ç¨‹åº¦æå‡ï¼Œå‡å°‘äººåŠ›éœ€æ±‚",
          icon: "ğŸ¤–",
          category: "technology"
        },
        {
          id: "climate_adaptation",
          name: "æ°”å€™é€‚åº”",
          cost: 120,
          effect: () => gameState.climateAdaptation += 0.25,
          description: "æå‡æ‰€æœ‰æç«¯å¤©æ°”é€‚åº”æ€§25%",
          icon: "ğŸŒ¡ï¸",
          category: "protection"
        }
      ],

      // åˆä½œç¤¾ç³»ç»Ÿé…ç½®
      COOPERATIVES: [
        {
          id: "grain_coop",
          name: "ç²®é£Ÿåˆä½œç¤¾",
          cost: 500,
          effect: () => gameState.grainPriceBonus += 0.2,
          description: "ç²®é£Ÿä½œç‰©å”®ä»·æå‡20%",
          icon: "ğŸŒ¾",
          members: 0,
          maxMembers: 50
        },
        {
          id: "equipment_coop",
          name: "è®¾å¤‡å…±äº«åˆä½œç¤¾",
          cost: 800,
          effect: () => gameState.equipmentCostMultiplier *= 0.8,
          description: "è®¾å¤‡è´­ä¹°æˆæœ¬é™ä½20%",
          icon: "ğŸšœ",
          members: 0,
          maxMembers: 30
        },
        {
          id: "insurance_coop",
          name: "ä¿é™©äº’åŠ©ç¤¾",
          cost: 600,
          effect: () => gameState.insuranceCostMultiplier *= 0.7,
          description: "ä¿é™©è´¹ç”¨é™ä½30%",
          icon: "ğŸ›¡ï¸",
          members: 0,
          maxMembers: 40
        }
      ],

      // æˆå°±é…ç½® - å¤§å¹…å¢åŠ 
      ACHIEVEMENTS: [
        // åŸºç¡€æˆå°±
        {
          id: "first_harvest",
          name: "åˆæ¬¡æ”¶è·",
          description: "å®Œæˆç¬¬ä¸€æ¬¡å†œä½œç‰©æ”¶è·",
          icon: "ğŸŒ¾",
          type: "basic",
          condition: () => gameState.totalHarvests >= 1,
          reward: { money: 100, reputation: 5 }
        },
        {
          id: "rich_farmer",
          name: "å¯Œè£•å†œæ°‘",
          description: "ç´¯ç§¯èµ„é‡‘è¾¾åˆ°â‚¹5000",
          icon: "ğŸ’°",
          type: "economic",
          condition: () => gameState.money >= 5000,
          reward: { reputation: 10, researchPoints: 10 }
        },
        {
          id: "weather_master",
          name: "å¤©æ°”å¤§å¸ˆ",
          description: "è¿ç»­7å¹´æˆåŠŸåº”å¯¹æç«¯å¤©æ°”",
          icon: "ğŸŒ¦ï¸",
          type: "survival",
          condition: () => gameState.consecutiveWeatherSuccess >= 7,
          reward: { money: 500, reputation: 15 }
        },
        {
          id: "equipment_king",
          name: "è®¾å¤‡å¤§ç‹",
          description: "æ‹¥æœ‰æ‰€æœ‰ç±»å‹çš„å†œä¸šè®¾å¤‡",
          icon: "ğŸ”§",
          type: "progression",
          condition: () => gameState.equipment.length >= 6,
          reward: { reputation: 20, researchPoints: 25 }
        },
        {
          id: "master_farmer",
          name: "å†œä¸šå¤§å¸ˆ",
          description: "å†œæ°‘ç­‰çº§è¾¾åˆ°15çº§",
          icon: "ğŸ‘¨â€ğŸŒ¾",
          type: "progression",
          condition: () => gameState.farmerLevel >= 15,
          reward: { money: 1000, reputation: 25 }
        },
        
        // ä¸“ä¸šæˆå°±
        {
          id: "crop_specialist",
          name: "ä½œç‰©ä¸“å®¶",
          description: "ç§æ¤è¿‡æ‰€æœ‰ç±»å‹çš„ä½œç‰©",
          icon: "ğŸŒ¿",
          type: "exploration",
          condition: () => Object.keys(gameState.cropsPlanted || {}).length >= 10,
          reward: { reputation: 15, researchPoints: 20 }
        },
        {
          id: "disaster_survivor",
          name: "ç¾éš¾å¹¸å­˜è€…",
          description: "æˆåŠŸåº¦è¿‡10æ¬¡æç«¯å¤©æ°”äº‹ä»¶",
          icon: "â›ˆï¸",
          type: "survival",
          condition: () => gameState.extremeWeatherSurvived >= 10,
          reward: { money: 800, reputation: 20 }
        },
        {
          id: "market_genius",
          name: "å¸‚åœºå¤©æ‰",
          description: "å•æ¬¡äº¤æ˜“è·åˆ©è¶…è¿‡â‚¹2000",
          icon: "ğŸ“ˆ",
          type: "economic",
          condition: () => gameState.maxSingleProfit >= 2000,
          reward: { reputation: 15, researchPoints: 15 }
        },
        {
          id: "researcher",
          name: "å†œä¸šç ”ç©¶è€…",
          description: "å®Œæˆ5é¡¹ç ”å‘é¡¹ç›®",
          icon: "ğŸ”¬",
          type: "technology",
          condition: () => gameState.completedResearch.length >= 5,
          reward: { researchPoints: 50, reputation: 20 }
        },
        {
          id: "community_leader",
          name: "ç¤¾åŒºé¢†è¢–",
          description: "åŠ å…¥3ä¸ªåˆä½œç¤¾",
          icon: "ğŸ‘¥",
          type: "social",
          condition: () => gameState.joinedCoops.length >= 3,
          reward: { reputation: 30, money: 500 }
        },
        
        // éšè—æˆå°±
        {
          id: "lucky_farmer",
          name: "å¹¸è¿å†œæ°‘",
          description: "è¿ç»­5å¹´é‡åˆ°æ­£å¸¸å¤©æ°”",
          icon: "ğŸ€",
          type: "hidden",
          condition: () => gameState.consecutiveNormalWeather >= 5,
          reward: { money: 1000, reputation: 10 }
        },
        {
          id: "risk_taker",
          name: "å†’é™©å®¶",
          description: "åœ¨è´Ÿå€ºçŠ¶æ€ä¸‹è·å¾—å¤§ä¸°æ”¶",
          icon: "ğŸ’",
          type: "hidden",
          condition: () => gameState.riskTakingSuccess === true,
          reward: { reputation: 25, researchPoints: 30 }
        },
        {
          id: "perfectionist",
          name: "å®Œç¾ä¸»ä¹‰è€…",
          description: "è¿ç»­10å¹´æ— ä»»ä½•æŸå¤±",
          icon: "â­",
          type: "hidden",
          condition: () => gameState.perfectYears >= 10,
          reward: { money: 2000, reputation: 35 }
        },
        {
          id: "comeback_king",
          name: "é€†å¢ƒé‡ç”Ÿ",
          description: "ä»ç ´äº§è¾¹ç¼˜æ¢å¤åˆ°â‚¹10000èµ„é‡‘",
          icon: "ğŸ‘‘",
          type: "hidden",
          condition: () => gameState.comebackSuccess === true,
          reward: { reputation: 40, researchPoints: 50 }
        },
        {
          id: "reputation_legend",
          name: "å£°æœ›ä¼ å¥‡",
          description: "å£°æœ›è¾¾åˆ°200ç‚¹",
          icon: "ğŸ†",
          type: "legendary",
          condition: () => gameState.reputation >= 200,
          reward: { money: 5000, researchPoints: 100 }
        },
        
        // é•¿æœŸæˆå°±
        {
          id: "veteran_farmer",
          name: "èµ„æ·±å†œæ°‘",
          description: "ç»è¥å†œåœº30å¹´",
          icon: "ğŸ—“ï¸",
          type: "longevity",
          condition: () => gameState.year >= 30,
          reward: { reputation: 50, money: 3000 }
        },
        {
          id: "millionaire",
          name: "ç™¾ä¸‡å¯Œç¿",
          description: "ç´¯ç§¯æ€»æ”¶å…¥è¾¾åˆ°â‚¹100000",
          icon: "ğŸ’",
          type: "economic",
          condition: () => gameState.totalIncome >= 100000,
          reward: { reputation: 60, researchPoints: 75 }
        },
        {
          id: "population_booster",
          name: "äººå£ç¹è£",
          description: "äººå£å¢é•¿åˆ°1000äºº",
          icon: "ğŸ˜ï¸",
          type: "social",
          condition: () => gameState.population >= 1000,
          reward: { reputation: 40, money: 2000 }
        },
        
        // ç‰¹æ®Šæˆå°±
        {
          id: "extreme_survivor",
          name: "æé™ç”Ÿå­˜è€…",
          description: "åœ¨åœ°ç‹±éš¾åº¦ä¸‹å­˜æ´»20å¹´",
          icon: "ğŸ”¥",
          type: "special",
          condition: () => gameState.difficulty >= 90 && gameState.year >= 20,
          reward: { reputation: 100, money: 10000 }
        },
        {
          id: "innovation_pioneer",
          name: "åˆ›æ–°å…ˆé”‹",
          description: "å®Œæˆæ‰€æœ‰ç ”å‘é¡¹ç›®",
          icon: "ğŸš€",
          type: "special",
          condition: () => gameState.completedResearch.length >= GAME_CONFIG.RESEARCH.length,
          reward: { reputation: 80, money: 5000 }
        }
      ]
    };

    // æ•™ç¨‹æ­¥éª¤
    const tutorialSteps = [
      "æ¬¢è¿æ¥åˆ°å­£é£å†³ç­–è€…å¢å¼ºç‰ˆï¼è¿™æ˜¯ä¸€ä¸ªæ›´åŠ ä¸°å¯Œå’Œå¹³è¡¡çš„å†œä¸šç®¡ç†æ¸¸æˆã€‚",
      "è§‚å¯Ÿå³ä¸Šè§’çš„çŠ¶æ€æ ï¼Œé™¤äº†åŸºç¡€ä¿¡æ¯å¤–ï¼Œè¿˜å¢åŠ äº†å£°æœ›å’Œç ”å‘ç‚¹æ•°ç³»ç»Ÿã€‚",
      "é€‰æ‹©åˆé€‚çš„ä½œç‰©æ˜¯æˆåŠŸçš„å…³é”®ã€‚æ³¨æ„å­£èŠ‚æ•ˆæœå¯¹ä¸åŒä½œç‰©çš„å½±å“ã€‚",
      "è´­ä¹°å†œä¸šè®¾å¤‡å¯ä»¥å¤§å¹…æå‡æŠ—ç¾èƒ½åŠ›å’Œäº§é‡ï¼Œç°åœ¨è®¾å¤‡æœ‰ç­‰çº§åˆ’åˆ†ã€‚",
      "å…³æ³¨å¸‚åœºä»·æ ¼æ³¢åŠ¨ï¼Œæ–°å¢çš„å¸‚åœºåˆ†æå¯ä»¥å¸®åŠ©æ‚¨é¢„æµ‹ä»·æ ¼è¶‹åŠ¿ã€‚",
      "å£°æœ›ç³»ç»Ÿå½±å“æ‚¨çš„ç¤¾ä¼šåœ°ä½ï¼Œé«˜å£°æœ›å¯ä»¥è·å¾—æ›´å¤šæœºä¼šå’ŒæŠ˜æ‰£ã€‚",
      "ç ”å‘ä¸­å¿ƒå¯ä»¥è§£é”æ–°æŠ€æœ¯ï¼Œæå‡å†œåœºçš„å„é¡¹èƒ½åŠ›ã€‚",
      "åˆä½œç¤¾ç³»ç»Ÿè®©æ‚¨å¯ä»¥ä¸å…¶ä»–å†œæ°‘åˆä½œï¼Œè·å¾—é›†ä½“ä¼˜åŠ¿ã€‚",
      "æˆå°±ç³»ç»Ÿæ›´åŠ ä¸°å¯Œï¼ŒåŒ…å«éšè—æˆå°±å’Œç‰¹æ®ŠæŒ‘æˆ˜ã€‚",
      "å»ºè®®åœ¨æ•™å­¦æ¨¡å¼ä¸‹ç†Ÿæ‚‰æ–°æœºåˆ¶ï¼Œç„¶åæŒ‘æˆ˜æ›´é«˜éš¾åº¦ï¼"
    ];
    let currentTutorialStep = 0;

    // æ¸¸æˆçŠ¶æ€ - å¢å¼ºç‰ˆ
    let gameState = {
      // åŸºç¡€çŠ¶æ€
      money: 2000,
      population: 200,
      year: 1,
      season: 0,
      farmerLevel: 1,
      
      // ä½œç‰©ç›¸å…³
      currentCrop: null,
      crops: {
        wheat: 200,
        rice: 0,
        corn: 0,
        sorghum: 0,
        cotton: 0,
        tea: 0,
        sugarcane: 0,
        rubber: 0,
        coffee: 0,
        cocoa: 0
      },
      cropPrices: {},
      cropsPlanted: {},
      
      // è®¾å¤‡å’Œæ”¿ç­–
      equipment: [],
      currentPolicy: null,
      policyDuration: 0,
      
      // æ¸¸æˆæœºåˆ¶
      gameMode: 'tutorial',
      difficulty: 50,
      challengeYears: 20,
      birthplace: 'china-north',
      
      // ç»Ÿè®¡æ•°æ®
      totalHarvests: 0,
      totalIncome: 0,
      consecutiveWeatherSuccess: 0,
      consecutiveNormalWeather: 0,
      extremeWeatherSurvived: 0,
      perfectYears: 0,
      maxSingleProfit: 0,
      history: [],
      achievements: [],
      
      // æŠ€èƒ½ç»éªŒ
      plantingExp: 0,
      managementExp: 0,
      marketExp: 0,
      plantingLevel: 1,
      managementLevel: 1,
      marketLevel: 1,
      
      // ç»æµç³»ç»Ÿ
      debt: 0,
      insurance: false,
      
      // æ–°å¢ï¼šå£°æœ›ç³»ç»Ÿ
      reputation: 50,
      reputationLevel: "æ–°æ‰‹å†œæ°‘",
      
      // æ–°å¢ï¼šç ”å‘ç³»ç»Ÿ
      researchPoints: 0,
      completedResearch: [],
      ongoingResearch: null,
      researchProgress: 0,
      
      // æ–°å¢ï¼šåˆä½œç¤¾ç³»ç»Ÿ
      joinedCoops: [],
      coopBonus: 0,
      
      // æ–°å¢ï¼šå¢å¼ºå±æ€§
      droughtResistance: 0,
      pestResistance: 0,
      yieldBonus: 0,
      soilQuality: 0,
      automation: 0,
      climateAdaptation: 0,
      
      // æ–°å¢ï¼šå¸‚åœºæ´å¯Ÿ
      marketInsight: false,
      weatherPrediction: false,
      nextWeatherEvent: null,
      
      // ä¿®é¥°ç¬¦
      incomeMultiplier: 1,
      equipmentCostMultiplier: 1,
      insuranceCostMultiplier: 1,
      grainPriceBonus: 0,
      climateRisk: 30,
      
      // æˆå°±ç›¸å…³
      riskTakingSuccess: false,
      comebackSuccess: false
    };

    // åˆå§‹åŒ–ä½œç‰©ä»·æ ¼
    function initializePrices() {
      Object.keys(GAME_CONFIG.CROPS).forEach(cropName => {
        const cropKey = getCropKey(cropName);
        gameState.cropPrices[cropKey] = GAME_CONFIG.CROPS[cropName].basePrice;
      });
    }

    // è·å–ä½œç‰©é”®å€¼æ˜ å°„
    function getCropKey(cropName) {
      const cropMap = {
        'æ°´ç¨»': 'rice',
        'å°éº¦': 'wheat',
        'ç‰ç±³': 'corn',
        'é«˜ç²±': 'sorghum',
        'æ£‰èŠ±': 'cotton',
        'èŒ¶å¶': 'tea',
        'ç”˜è”—': 'sugarcane',
        'æ©¡èƒ¶': 'rubber',
        'å’–å•¡': 'coffee',
        'å¯å¯': 'cocoa'
      };
      return cropMap[cropName];
    }

    // è·å–ä½œç‰©ä¸­æ–‡å
    function getCropName(cropKey) {
      const nameMap = {
        'rice': 'æ°´ç¨»',
        'wheat': 'å°éº¦',
        'corn': 'ç‰ç±³',
        'sorghum': 'é«˜ç²±',
        'cotton': 'æ£‰èŠ±',
        'tea': 'èŒ¶å¶',
        'sugarcane': 'ç”˜è”—',
        'rubber': 'æ©¡èƒ¶',
        'coffee': 'å’–å•¡',
        'cocoa': 'å¯å¯'
      };
      return nameMap[cropKey];
    }

    // æ¨¡å¼é€‰æ‹©ç›¸å…³å‡½æ•°
    document.addEventListener('DOMContentLoaded', function() {
      const gameModeRadios = document.querySelectorAll('input[name="game-mode"]');
      const challengeSettings = document.getElementById('challenge-settings');
      
      gameModeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'challenge') {
            challengeSettings.style.display = 'block';
          } else {
            challengeSettings.style.display = 'none';
          }
        });
      });
      
      initializePrices();
      updateDisplay();
      updateMarketPanel();
      updateEquipmentPanel();
      updateAchievementPanel();
    });

    function startSettings() {
      const gameMode = document.querySelector('input[name="game-mode"]:checked').value;
      gameState.gameMode = gameMode;
      
      if (gameMode === 'challenge') {
        gameState.challengeYears = parseInt(document.getElementById('challenge-years').value);
      }
      
      gameState.difficulty = parseInt(document.getElementById('difficulty').value);
      gameState.climateRisk = gameState.difficulty;
      
      // æ ¹æ®éš¾åº¦è°ƒæ•´åˆå§‹èµ„æº
      if (gameState.difficulty <= 25) {
        gameState.money = 3000;
        gameState.reputation = 60;
      } else if (gameState.difficulty >= 90) {
        gameState.money = 1200;
        gameState.reputation = 30;
        gameState.climateRisk += 20;
      }
      
      document.getElementById('mode-selection-modal').style.display = 'none';
      document.getElementById('settings-modal').style.display = 'flex';
    }

    function startGame() {
      const birthplaceElement = document.querySelector('input[name="birthplace"]:checked');
      if (birthplaceElement) {
        gameState.birthplace = birthplaceElement.value;
      }
      
      // æ ¹æ®å‡ºç”Ÿåœ°è°ƒæ•´åˆå§‹æ¡ä»¶
      adjustInitialConditions();
      
      document.getElementById('settings-modal').style.display = 'none';
      
      if (gameState.gameMode === 'tutorial') {
        document.getElementById('tutorial-overlay').style.display = 'flex';
      }
      
      updateDisplay();
      updateSeasonEffect();
      addLog("æ¸¸æˆå¼€å§‹ï¼æ¬¢è¿æ¥åˆ°å†œä¸šç»è¥çš„æ–°ä¸–ç•Œï¼", "success");
    }

    // æ ¹æ®å‡ºç”Ÿåœ°è°ƒæ•´åˆå§‹æ¡ä»¶
    function adjustInitialConditions() {
      const adjustments = {
        'china-north': { 
          money: 500, reputation: 10, crops: { wheat: 100 },
          bonus: "å°éº¦äº§é‡+20%", resistance: "å¯’å†·é€‚åº”" 
        },
        'china-south': { 
          money: 300, reputation: 15, crops: { rice: 150 },
          bonus: "æ°´ç¨»äº§é‡+25%", resistance: "æ¹¿æ¶¦é€‚åº”" 
        },
        'china-west': { 
          money: 200, reputation: 5, crops: { sorghum: 80 },
          bonus: "å¹²æ—±æŠ—æ€§+30%", resistance: "å¹²æ—±é€‚åº”" 
        },
        'russia-south': { 
          money: 600, reputation: 8, crops: { wheat: 120 },
          bonus: "æœºæ¢°åŒ–ä¼˜åŠ¿", resistance: "å¯’å†·é€‚åº”" 
        },
        'russia-west': { 
          money: 400, reputation: 5, crops: { wheat: 80 },
          bonus: "æåœ°ä½œç‰©é€‚åº”", resistance: "æå¯’é€‚åº”" 
        },
        'russia-east': { 
          money: 350, reputation: 12, crops: { corn: 90 },
          bonus: "è¾¹å¢ƒè´¸æ˜“ä¼˜åŠ¿", resistance: "å¤šå˜é€‚åº”" 
        },
        'sea-thailand': { 
          money: 400, reputation: 18, crops: { rice: 180 },
          bonus: "çƒ­å¸¦ä½œç‰©+30%", resistance: "é«˜æ¸©é€‚åº”" 
        },
        'sea-vietnam': { 
          money: 350, reputation: 15, crops: { rice: 160 },
          bonus: "å­£é£é€‚åº”+25%", resistance: "å­£é£é€‚åº”" 
        },
        'sea-indonesia': { 
          money: 450, reputation: 20, crops: { sugarcane: 100 },
          bonus: "å¤šå²›è´¸æ˜“ç½‘ç»œ", resistance: "æµ·æ´‹æ°”å€™" 
        },
        'india-north': { 
          money: 300, reputation: 12, crops: { wheat: 140 },
          bonus: "äººå£çº¢åˆ©", resistance: "å­£é£é€‚åº”" 
        },
        'india-south': { 
          money: 380, reputation: 22, crops: { tea: 60 },
          bonus: "é¦™æ–™è´¸æ˜“+40%", resistance: "çƒ­å¸¦é€‚åº”" 
        },
        'india-east': { 
          money: 320, reputation: 16, crops: { rice: 170 },
          bonus: "å­£é£å‰æ²¿ä¼˜åŠ¿", resistance: "æç«¯å¤©æ°”" 
        },
        'africa-east': { 
          money: 250, reputation: 8, crops: { coffee: 40 },
          bonus: "å’–å•¡äº§é‡+50%", resistance: "é«˜åŸé€‚åº”" 
        },
        'africa-west': { 
          money: 280, reputation: 10, crops: { cocoa: 35 },
          bonus: "å¯å¯äº§é‡+60%", resistance: "çƒ­å¸¦é€‚åº”" 
        },
        'africa-south': { 
          money: 420, reputation: 14, crops: { corn: 110 },
          bonus: "å¤šæ ·åŒ–å†œä¸š", resistance: "è‰åŸé€‚åº”" 
        }
      };
      
      const adjustment = adjustments[gameState.birthplace];
      if (adjustment) {
        gameState.money += adjustment.money;
        gameState.reputation += adjustment.reputation;
        
        // æ·»åŠ åˆå§‹ä½œç‰©
        Object.keys(adjustment.crops).forEach(cropKey => {
          gameState.crops[cropKey] += adjustment.crops[cropKey];
        });
        
        // è®°å½•ç‰¹æ®Šä¼˜åŠ¿
        gameState.birthplaceBonus = adjustment.bonus;
        gameState.climateResistance = adjustment.resistance;
        
        addLog(`å‡ºç”Ÿåœ°ç‰¹è‰²ï¼š${adjustment.bonus}`, "info");
      }
    }

    // æ•™ç¨‹ç³»ç»Ÿ
    function nextTutorial() {
      currentTutorialStep++;
      if (currentTutorialStep < tutorialSteps.length) {
        document.getElementById('tutorial-text').textContent = tutorialSteps[currentTutorialStep];
      } else {
        skipTutorial();
      }
    }

    function skipTutorial() {
      document.getElementById('tutorial-overlay').style.display = 'none';
      addLog("æ•™ç¨‹å®Œæˆï¼Œå¼€å§‹æ‚¨çš„å†œä¸šä¹‹æ—…ï¼", "success");
    }

    // é€‰æ‹©ä½œç‰©
    function chooseCrop(cropName) {
      if (!gameState.currentCrop || gameState.currentCrop !== cropName) {
        gameState.currentCrop = cropName;
        
        // è®°å½•ç§æ¤è¿‡çš„ä½œç‰©
        if (!gameState.cropsPlanted) gameState.cropsPlanted = {};
        gameState.cropsPlanted[cropName] = true;
        
        document.getElementById('current-crop-display').textContent = cropName;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.crop-button').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.querySelector(`[data-crop="${cropName}"]`).classList.add('selected');
        
        // æ£€æŸ¥å­£èŠ‚é€‚åº”æ€§
        const crop = GAME_CONFIG.CROPS[cropName];
        const currentSeason = gameState.season;
        let seasonFeedback = "";
        
        if (crop.seasons.optimal.includes(currentSeason)) {
          seasonFeedback = "æœ€é€‚å­£èŠ‚ï¼";
        } else if (crop.seasons.good.includes(currentSeason)) {
          seasonFeedback = "é€‚å®œå­£èŠ‚";
        } else if (crop.seasons.poor.includes(currentSeason)) {
          seasonFeedback = "ä¸é€‚å­£èŠ‚ï¼Œäº§é‡ä¼šé™ä½";
        }
        
        if (seasonFeedback) {
          addLog(`é€‰æ‹©${cropName} - ${seasonFeedback}`, seasonFeedback.includes("ä¸é€‚") ? "warning" : "info");
        } else {
          addLog(`é€‰æ‹©ä½œç‰©ï¼š${cropName}`, "info");
        }
        
        gainExperience('planting', 5);
      }
    }

    // ä¸‹ä¸€å›åˆ
    function nextTurn() {
      if (!gameState.currentCrop) {
        addLog("è¯·å…ˆé€‰æ‹©è¦ç§æ¤çš„ä½œç‰©ï¼", "warning");
        return;
      }
      
      // å¤©æ°”é¢„æµ‹åŠŸèƒ½
      if (gameState.weatherPrediction && gameState.nextWeatherEvent) {
        addLog(`å¤©æ°”é¢„æµ‹ï¼šä¸‹ä¸€è½®å°†æ˜¯${gameState.nextWeatherEvent.type}`, "info");
      }
      
      // ç”Ÿæˆå¤©æ°”äº‹ä»¶
      const weatherEvent = generateWeatherEvent();
      
      // ä¸ºä¸‹ä¸€è½®é¢„æµ‹å¤©æ°”
      if (gameState.weatherPrediction) {
        gameState.nextWeatherEvent = generateWeatherEvent();
      }
      
      // åº”ç”¨æ”¿ç­–
      applyCurrentPolicy();
      applyRandomPolicy();
      
      // è®¡ç®—æ”¶è·
      const harvestResult = calculateHarvest(weatherEvent);
      
      // æ›´æ–°æ¸¸æˆçŠ¶æ€
      updateGameState(harvestResult, weatherEvent);
      
      // æ›´æ–°åœ°å›¾æ˜¾ç¤º
      updateMapDisplay(weatherEvent);
      
      // æ›´æ–°äººå£
      updatePopulation();
      
      // æ›´æ–°å¸‚åœºä»·æ ¼
      updateMarketPrices();
      
      // æ›´æ–°å†œæ°‘ç­‰çº§
      updateFarmerLevel();
      
      // æ›´æ–°å£°æœ›
      updateReputation(harvestResult, weatherEvent);
      
      // å¢åŠ ç ”å‘ç‚¹æ•°
      const researchGain = Math.max(1, Math.floor(gameState.farmerLevel / 3));
      gameState.researchPoints += researchGain;
      
      // å¤„ç†ç ”å‘è¿›åº¦
      if (gameState.ongoingResearch) {
        updateResearchProgress();
      }
      
      // æ£€æŸ¥æˆå°±
      checkAchievements();
      
      // æ›´æ–°ç•Œé¢
      updateDisplay();
      updateMarketPanel();
      updateEquipmentPanel();
      updateAchievementPanel();
      
      // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
      checkGameOver();
      
      // å¢åŠ å›åˆ
      gameState.year++;
      gameState.season = (gameState.season + 1) % 4;
      updateSeasonEffect();
      
      // é‡ç½®æ”¿ç­–æŒç»­æ—¶é—´
      if (gameState.policyDuration > 0) {
        gameState.policyDuration--;
        if (gameState.policyDuration <= 0) {
          gameState.currentPolicy = null;
          document.getElementById('policy-effect').style.display = 'none';
          addLog("æ”¿ç­–æ•ˆæœç»“æŸ", "info");
        }
      }
      
      const logMessage = `ç¬¬${gameState.year-1}å¹´ç»“æŸï¼š${weatherEvent.type}ï¼Œæ”¶è·${harvestResult.quantity}å•ä½${gameState.currentCrop}ï¼Œæ”¶å…¥â‚¹${harvestResult.income}`;
      addLog(logMessage, "success");
      
      // è®°å½•å†å²
      gameState.history.push({
        year: gameState.year - 1,
        weather: weatherEvent.type,
        income: harvestResult.income,
        crop: gameState.currentCrop,
        quantity: harvestResult.quantity
      });
      
      updateHistoryDisplay();
    }

    // ç”Ÿæˆå¤©æ°”äº‹ä»¶ - å¢å¼ºç‰ˆ
    function generateWeatherEvent() {
      const random = Math.random();
      let cumulativeProbability = 0;
      
      // æ ¹æ®æ°”å€™é£é™©å’Œå­£èŠ‚è°ƒæ•´æ¦‚ç‡
      const seasonModifier = {
        0: { drought: 0.8, flood: 1.2, normal: 1.1 }, // æ˜¥å­£
        1: { drought: 1.3, flood: 0.9, normal: 0.9 }, // å¤å­£
        2: { drought: 1.1, flood: 1.1, normal: 1.0 }, // ç§‹å­£
        3: { drought: 0.7, flood: 0.8, normal: 1.2 }  // å†¬å­£
      };
      
      const adjustedEvents = GAME_CONFIG.WEATHER_EVENTS.map(event => {
        let adjustedProbability = event.probability;
        
        // æ°”å€™é£é™©å½±å“
        if (event.type === "æ­£å¸¸") {
          adjustedProbability *= (1 - gameState.climateRisk / 150);
        } else {
          adjustedProbability *= (1 + gameState.climateRisk / 200);
        }
        
        // å­£èŠ‚å½±å“
        const season = seasonModifier[gameState.season];
        if (event.type.includes("å¹²æ—±") && season.drought) {
          adjustedProbability *= season.drought;
        } else if (event.type === "æ´ªæ°´" && season.flood) {
          adjustedProbability *= season.flood;
        } else if (event.type === "æ­£å¸¸" && season.normal) {
          adjustedProbability *= season.normal;
        }
        
        return { ...event, adjustedProbability };
      });
      
      // é‡æ–°æ ‡å‡†åŒ–æ¦‚ç‡
      const totalProbability = adjustedEvents.reduce((sum, event) => sum + event.adjustedProbability, 0);
      adjustedEvents.forEach(event => {
        event.adjustedProbability /= totalProbability;
      });
      
      for (const event of adjustedEvents) {
        cumulativeProbability += event.adjustedProbability;
        if (random <= cumulativeProbability) {
          return event;
        }
      }
      
      return GAME_CONFIG.WEATHER_EVENTS[0]; // é»˜è®¤è¿”å›æ­£å¸¸å¤©æ°”
    }

    // åº”ç”¨å½“å‰æ”¿ç­–æ•ˆæœ
    function applyCurrentPolicy() {
      if (gameState.currentPolicy && gameState.policyDuration > 0) {
        // é‡ç½®ä¿®é¥°ç¬¦
        gameState.incomeMultiplier = 1;
        gameState.equipmentCostMultiplier = 1;
        
        // åº”ç”¨æ”¿ç­–æ•ˆæœ
        gameState.currentPolicy.effect();
      }
    }

    // åº”ç”¨éšæœºæ”¿ç­–
    function applyRandomPolicy() {
      if (Math.random() < 0.25) { // 25% æ¦‚ç‡è§¦å‘æ”¿ç­–
        const policy = GAME_CONFIG.POLICIES[Math.floor(Math.random() * GAME_CONFIG.POLICIES.length)];
        gameState.currentPolicy = policy;
        gameState.policyDuration = policy.duration || 2;
        
        document.getElementById('policy-effect').style.display = 'block';
        document.getElementById('policy-text').textContent = `${policy.icon} ${policy.name}: ${policy.description}`;
        
        addLog(`æ–°æ”¿ç­–é¢å¸ƒï¼š${policy.name}ï¼ˆæŒç»­${gameState.policyDuration}å¹´ï¼‰`, "warning");
        
        // å¢åŠ ç®¡ç†ç»éªŒ
        gainExperience('management', 15);
      } else if (gameState.policyDuration <= 0) {
        gameState.currentPolicy = null;
        document.getElementById('policy-effect').style.display = 'none';
      }
    }

    // è®¡ç®—æ”¶è· - å¢å¼ºç‰ˆ
    function calculateHarvest(weatherEvent) {
      const crop = GAME_CONFIG.CROPS[gameState.currentCrop];
      let yieldModifier = crop.modifiers[weatherEvent.type] || 0.5;
      
      // å­£èŠ‚æ•ˆæœ
      const seasonEffect = GAME_CONFIG.SEASON_EFFECTS[gameState.season];
      const currentSeason = gameState.season;
      
      if (crop.seasons.optimal.includes(currentSeason)) {
        yieldModifier *= 1.2;
      } else if (crop.seasons.good.includes(currentSeason)) {
        yieldModifier *= 1.0;
      } else if (crop.seasons.poor.includes(currentSeason)) {
        yieldModifier *= 0.7;
      }
      
      yieldModifier *= seasonEffect.modifier;
      
      // è®¾å¤‡åŠ æˆ - é‡æ–°è®¡ç®—
      gameState.equipment.forEach(equipment => {
        switch(equipment.name) {
          case "åŸºç¡€çŒæº‰ç³»ç»Ÿ":
            if (weatherEvent.type.includes("å¹²æ—±")) {
              yieldModifier *= 1.3;
            }
            break;
          case "é˜²æ´ªå ¤å":
            if (weatherEvent.type === "æ´ªæ°´") {
              yieldModifier *= 1.35;
            }
            break;
          case "æ°”è±¡ç›‘æµ‹ç«™":
            yieldModifier *= 1.2;
            break;
          case "ç°ä»£æ‹–æ‹‰æœº":
            yieldModifier *= 1.25;
            break;
          case "æ™ºèƒ½æ¸©å®¤":
            yieldModifier *= 2.0;
            break;
          case "æ— äººæœºæ¤ä¿":
            if (weatherEvent.type === "ç—…è™«å®³") {
              yieldModifier *= 1.5;
            }
            yieldModifier *= 1.15;
            break;
          case "åœŸå£¤æ”¹è‰¯è®¾å¤‡":
            yieldModifier *= 1.2;
            break;
          case "æ™ºèƒ½ä¼ æ„Ÿå™¨ç½‘ç»œ":
            yieldModifier *= 1.3;
            if (weatherEvent.type !== "æ­£å¸¸") {
              yieldModifier *= 1.1; // é¢å¤–ç¾å®³é¢„è­¦
            }
            break;
          case "è‡ªåŠ¨æ”¶å‰²æœº":
            yieldModifier *= 1.15; // å‡å°‘æ”¶è·æŸå¤±
            break;
        }
      });
      
      // æŠ€èƒ½åŠ æˆ - é‡æ–°è®¡ç®—
      const skillBonus = 1 + (gameState.plantingExp / 800);
      yieldModifier *= skillBonus;
      
      // ç ”å‘åŠ æˆ
      yieldModifier *= (1 + gameState.yieldBonus);
      yieldModifier *= (1 + gameState.soilQuality);
      
      // æŠ—æ€§åŠ æˆ
      if (weatherEvent.type.includes("å¹²æ—±")) {
        yieldModifier *= (1 + gameState.droughtResistance);
      }
      if (weatherEvent.type === "ç—…è™«å®³") {
        yieldModifier *= (1 + gameState.pestResistance);
      }
      if (weatherEvent.type !== "æ­£å¸¸") {
        yieldModifier *= (1 + gameState.climateAdaptation);
      }
      
      // å£°æœ›åŠ æˆ
      const reputationBonus = Math.min(0.3, gameState.reputation / 500);
      yieldModifier *= (1 + reputationBonus);
      
      // åˆä½œç¤¾åŠ æˆ
      yieldModifier *= (1 + gameState.coopBonus);
      
      // è®¡ç®—æœ€ç»ˆäº§é‡å’Œæ”¶å…¥
      const baseQuantity = crop.baseYield;
      const quantity = Math.max(1, Math.round(baseQuantity * yieldModifier));
      
      let basePrice = crop.basePrice * gameState.incomeMultiplier;
      
      // ç²®é£Ÿä½œç‰©ä»·æ ¼åŠ æˆ
      const grainCrops = ['æ°´ç¨»', 'å°éº¦', 'ç‰ç±³', 'é«˜ç²±'];
      if (grainCrops.includes(gameState.currentCrop)) {
        basePrice *= (1 + gameState.grainPriceBonus);
      }
      
      const income = Math.round(quantity * basePrice);
      
      return { quantity, income };
    }

    // æ›´æ–°æ¸¸æˆçŠ¶æ€ - å¢å¼ºç‰ˆ
    function updateGameState(harvestResult, weatherEvent) {
      gameState.money += harvestResult.income;
      gameState.totalIncome += harvestResult.income;
      gameState.totalHarvests++;
      
      // æ£€æŸ¥å•æ¬¡æœ€å¤§æ”¶ç›Š
      if (harvestResult.income > gameState.maxSingleProfit) {
        gameState.maxSingleProfit = harvestResult.income;
      }
      
      // æ£€æŸ¥è´Ÿå€ºçŠ¶æ€ä¸‹çš„æˆåŠŸ
      if (gameState.debt > gameState.money && harvestResult.income > 1000) {
        gameState.riskTakingSuccess = true;
      }
      
      // æ£€æŸ¥ä»ç ´äº§è¾¹ç¼˜æ¢å¤
      if (gameState.money < 500 && gameState.money + harvestResult.income >= 10000) {
        gameState.comebackSuccess = true;
      }
      
      // æ·»åŠ æ”¶è·çš„ä½œç‰©åˆ°ä»“åº“
      const cropKey = getCropKey(gameState.currentCrop);
      gameState.crops[cropKey] += harvestResult.quantity;
      
      // æ›´æ–°æ°”å€™é£é™©
      gameState.climateRisk = Math.min(100, gameState.climateRisk + 1.5);
      
      // ç»Ÿè®¡å¤©æ°”äº‹ä»¶
      if (weatherEvent.type === "æ­£å¸¸") {
        gameState.consecutiveNormalWeather++;
        gameState.consecutiveWeatherSuccess++;
      } else {
        gameState.consecutiveNormalWeather = 0;
        gameState.extremeWeatherSurvived++;
        if (harvestResult.quantity > 0) {
          gameState.consecutiveWeatherSuccess++;
        } else {
          gameState.consecutiveWeatherSuccess = 0;
        }
      }
      
      // å®Œç¾å¹´ç»Ÿè®¡
      if (harvestResult.income >= crop.basePrice * crop.baseYield * 0.8) {
        gameState.perfectYears++;
      } else {
        gameState.perfectYears = 0;
      }
      
      // å¢åŠ ç»éªŒ
      gainExperience('planting', 12);
      
      // å¤„ç†å€ºåŠ¡åˆ©æ¯
      if (gameState.debt > 0) {
        const interest = Math.round(gameState.debt * 0.08);
        gameState.debt += interest;
        if (interest > 0) {
          addLog(`å€ºåŠ¡åˆ©æ¯ï¼šâ‚¹${interest}`, "warning");
        }
      }
    }

    // æ›´æ–°å­£èŠ‚æ•ˆæœ
    function updateSeasonEffect() {
      const seasonEffect = GAME_CONFIG.SEASON_EFFECTS[gameState.season];
      document.getElementById('season-text').textContent = `${seasonEffect.name}ï¼š${seasonEffect.description}`;
    }

    // æ›´æ–°å£°æœ›ç³»ç»Ÿ
    function updateReputation(harvestResult, weatherEvent) {
      let reputationChange = 0;
      
      // åŸºç¡€å£°æœ›å˜åŒ–
      if (harvestResult.income > 1000) {
        reputationChange += 2;
      } else if (harvestResult.income < 200) {
        reputationChange -= 1;
      }
      
      // å¤©æ°”åº”å¯¹èƒ½åŠ›
      if (weatherEvent.type !== "æ­£å¸¸" && harvestResult.quantity > 0) {
        reputationChange += 3;
      }
      
      // äººå£ç»´æŒ
      if (gameState.population > 500) {
        reputationChange += 1;
      }
      
      gameState.reputation += reputationChange;
      gameState.reputation = Math.max(0, Math.min(300, gameState.reputation));
      
      // æ›´æ–°å£°æœ›ç­‰çº§
      updateReputationLevel();
    }

    function updateReputationLevel() {
      const levels = [
        { min: 0, max: 25, name: "æ–°æ‰‹å†œæ°‘", desc: "åˆšåˆšå¼€å§‹å†œä¸šç”Ÿæ¶¯" },
        { min: 25, max: 50, name: "åˆçº§å†œæ°‘", desc: "å·²æœ‰åŸºç¡€ç»éªŒ" },
        { min: 50, max: 80, name: "ç†Ÿç»ƒå†œæ°‘", desc: "æŠ€èƒ½æ—¥æ¸æˆç†Ÿ" },
        { min: 80, max: 120, name: "ä¸“ä¸šå†œæ°‘", desc: "åœ¨å½“åœ°å°æœ‰åæ°”" },
        { min: 120, max: 160, name: "å†œä¸šä¸“å®¶", desc: "è¢«åŒè¡Œè®¤å¯" },
        { min: 160, max: 200, name: "å†œä¸šå¤§å¸ˆ", desc: "åŒºåŸŸçŸ¥åå†œä¸šä¸“å®¶" },
        { min: 200, max: 250, name: "å†œä¸šæƒå¨", desc: "å…¨å›½çŸ¥åçš„å†œä¸šä¸“å®¶" },
        { min: 250, max: 300, name: "å†œä¸šä¼ å¥‡", desc: "ä¼ å¥‡èˆ¬çš„å†œä¸šå¤§å¸ˆ" }
      ];
      
      const currentLevel = levels.find(level => 
        gameState.reputation >= level.min && gameState.reputation < level.max
      );
      
      if (currentLevel) {
        gameState.reputationLevel = currentLevel.name;
        document.getElementById('reputation-level').textContent = currentLevel.name;
        document.getElementById('reputation-desc').textContent = currentLevel.desc;
        
        // æ›´æ–°å£°æœ›æŒ‡ç¤ºå™¨ä½ç½®
        const percentage = ((gameState.reputation - currentLevel.min) / (currentLevel.max - currentLevel.min)) * 100;
        document.getElementById('reputation-indicator').style.left = `${percentage}%`;
      }
    }

    // ç»éªŒå€¼ç³»ç»Ÿ - å¢å¼ºç‰ˆ
    function gainExperience(type, amount) {
      const oldLevel = gameState[`${type}Level`];
      gameState[`${type}Exp`] += amount;
      
      // è®¡ç®—æ–°ç­‰çº§
      const newLevel = Math.floor(gameState[`${type}Exp`] / 100) + 1;
      
      if (newLevel > oldLevel) {
        gameState[`${type}Level`] = newLevel;
        addLog(`${type === 'planting' ? 'ç§æ¤' : type === 'management' ? 'ç®¡ç†' : 'å¸‚åœº'}æŠ€èƒ½å‡çº§åˆ°${newLevel}çº§ï¼`, "success");
        
        // å‡çº§å¥–åŠ±
        gameState.reputation += 5;
        gameState.researchPoints += 10;
      }
    }

    // æ›´æ–°å†œæ°‘ç­‰çº§
    function updateFarmerLevel() {
      const totalExp = gameState.plantingExp + gameState.managementExp + gameState.marketExp;
      const newLevel = Math.floor(totalExp / 200) + 1;
      
      if (newLevel > gameState.farmerLevel) {
        gameState.farmerLevel = newLevel;
        addLog(`å†œæ°‘ç­‰çº§æå‡åˆ°${newLevel}çº§ï¼`, "success");
        gameState.reputation += 10;
        gameState.researchPoints += 15;
      }
    }

    // æ›´æ–°æŠ€èƒ½æ˜¾ç¤º
    function updateSkillDisplay() {
      const skills = ['planting', 'management', 'market'];
      skills.forEach(skill => {
        const exp = gameState[`${skill}Exp`];
        const level = gameState[`${skill}Level`];
        const expNeeded = level * 100;
        const currentLevelExp = exp % 100;
        
        document.getElementById(`${skill}-exp`).textContent = currentLevelExp;
        document.getElementById(`${skill}-exp-needed`).textContent = 100;
        document.getElementById(`${skill}-progress`).style.width = `${currentLevelExp}%`;
      });
    }

    // æ›´æ–°å¸‚åœºä»·æ ¼ - å¢å¼ºç‰ˆ
    function updateMarketPrices() {
      Object.keys(gameState.cropPrices).forEach(cropKey => {
        const baseCrop = Object.keys(GAME_CONFIG.CROPS).find(key => getCropKey(key) === cropKey);
        if (baseCrop) {
          const basePrice = GAME_CONFIG.CROPS[baseCrop].basePrice;
          
          // æ›´å¤æ‚çš„ä»·æ ¼æ³¢åŠ¨
          const volatility = 0.15 + (gameState.difficulty / 500);
          const seasonalEffect = Math.sin((gameState.year + gameState.season) * 0.5) * 0.1;
          const randomEffect = (Math.random() - 0.5) * volatility;
          const trendEffect = Math.sin(gameState.year * 0.2) * 0.08;
          
          let newPrice = basePrice * (1 + seasonalEffect + randomEffect + trendEffect);
          
          // ä¾›éœ€å…³ç³»å½±å“
          const supply = gameState.crops[cropKey] || 0;
          const demand = gameState.population * 0.1;
          const supplyDemandRatio = supply / (demand + 1);
          
          if (supplyDemandRatio > 2) {
            newPrice *= 0.85; // ä¾›è¿‡äºæ±‚ï¼Œä»·æ ¼ä¸‹é™
          } else if (supplyDemandRatio < 0.5) {
            newPrice *= 1.25; // ä¾›ä¸åº”æ±‚ï¼Œä»·æ ¼ä¸Šæ¶¨
          }
          
          gameState.cropPrices[cropKey] = Math.max(5, Math.round(newPrice));
        }
      });
    }

    // ç ”å‘ç³»ç»Ÿ
    function showResearch() {
      document.getElementById('research-modal').style.display = 'flex';
      updateResearchContent();
    }

    function closeResearch() {
      document.getElementById('research-modal').style.display = 'none';
    }

    function updateResearchContent() {
      const content = document.getElementById('research-content');
      const availableResearch = GAME_CONFIG.RESEARCH.filter(research => 
        !gameState.completedResearch.includes(research.id)
      );
      
      content.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3>ğŸ§ª ç ”å‘ç‚¹æ•°: ${gameState.researchPoints}</h3>
          ${gameState.ongoingResearch ? `
            <div class="research-item in-progress">
              <strong>æ­£åœ¨ç ”å‘: ${gameState.ongoingResearch.name}</strong><br>
              <div class="skill-bar">
                <div class="skill-progress" style="width: ${gameState.researchProgress}%"></div>
              </div>
              <small>è¿›åº¦: ${Math.round(gameState.researchProgress)}%</small>
            </div>
          ` : ''}
        </div>
        
        <h4>å¯ç”¨ç ”å‘é¡¹ç›®:</h4>
        ${availableResearch.map(research => `
          <div class="research-item" onclick="startResearch('${research.id}')">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${research.icon} ${research.name}</strong><br>
                <small>${research.description}</small><br>
                <small style="color: #666;">ç±»åˆ«: ${research.category}</small>
              </div>
              <div style="text-align: right;">
                <div style="color: var(--warning-color); font-weight: bold;">â‚¿${research.cost}</div>
                <button class="btn info-btn" style="padding: 4px 8px; font-size: 0.8em;" 
                        ${gameState.researchPoints >= research.cost && !gameState.ongoingResearch ? '' : 'disabled'}>
                  ç ”å‘
                </button>
              </div>
            </div>
          </div>
        `).join('')}
        
        <h4 style="margin-top: 20px;">å·²å®Œæˆç ”å‘:</h4>
        ${gameState.completedResearch.map(researchId => {
          const research = GAME_CONFIG.RESEARCH.find(r => r.id === researchId);
          return research ? `
            <div class="research-item completed">
              <strong>${research.icon} ${research.name}</strong><br>
              <small>${research.description}</small>
            </div>
          ` : '';
        }).join('') || '<p style="color: #666;">æš‚æ— å®Œæˆçš„ç ”å‘é¡¹ç›®</p>'}
      `;
    }

    function startResearch(researchId) {
      if (gameState.ongoingResearch) {
        addLog("å·²æœ‰æ­£åœ¨è¿›è¡Œçš„ç ”å‘é¡¹ç›®ï¼", "warning");
        return;
      }
      
      const research = GAME_CONFIG.RESEARCH.find(r => r.id === researchId);
      if (!research) return;
      
      if (gameState.researchPoints >= research.cost) {
        gameState.researchPoints -= research.cost;
        gameState.ongoingResearch = research;
        gameState.researchProgress = 0;
        
        addLog(`å¼€å§‹ç ”å‘ï¼š${research.name}`, "info");
        updateResearchContent();
        gainExperience('management', 20);
      } else {
        addLog("ç ”å‘ç‚¹æ•°ä¸è¶³ï¼", "warning");
      }
    }

    function updateResearchProgress() {
      if (gameState.ongoingResearch) {
        gameState.researchProgress += 25; // æ¯å›åˆ25%è¿›åº¦
        
        if (gameState.researchProgress >= 100) {
          // ç ”å‘å®Œæˆ
          gameState.completedResearch.push(gameState.ongoingResearch.id);
          gameState.ongoingResearch.effect();
          
          addLog(`ç ”å‘å®Œæˆï¼š${gameState.ongoingResearch.name}ï¼`, "success");
          gameState.reputation += 15;
          
          gameState.ongoingResearch = null;
          gameState.researchProgress = 0;
        }
      }
    }

    // åˆä½œç¤¾ç³»ç»Ÿ
    function showCoop() {
      document.getElementById('coop-modal').style.display = 'flex';
      updateCoopContent();
    }

    function closeCoop() {
      document.getElementById('coop-modal').style.display = 'none';
    }

    function updateCoopContent() {
      const content = document.getElementById('coop-content');
      
      content.innerHTML = `
        <div class="coop-panel">
          <h3>ğŸ¤ åˆä½œç¤¾ç³»ç»Ÿ</h3>
          <p>åŠ å…¥åˆä½œç¤¾å¯ä»¥è·å¾—é›†ä½“ä¼˜åŠ¿ï¼Œé™ä½æˆæœ¬ï¼Œæé«˜æ•ˆç›Šã€‚</p>
          <p><strong>å½“å‰åˆä½œæ•ˆç›ŠåŠ æˆï¼š+${(gameState.coopBonus * 100).toFixed(1)}%</strong></p>
        </div>
        
        <h4>å¯åŠ å…¥çš„åˆä½œç¤¾:</h4>
        ${GAME_CONFIG.COOPERATIVES.map(coop => {
          const isJoined = gameState.joinedCoops.includes(coop.id);
          return `
            <div class="market-item" style="background: ${isJoined ? 'rgba(76, 175, 80, 0.1)' : 'white'};">
              <div class="market-item-info">
                <strong>${coop.icon} ${coop.name}</strong><br>
                <small>${coop.description}</small><br>
                <small>æˆå‘˜: ${coop.members}/${coop.maxMembers} | è´¹ç”¨: â‚¹${coop.cost}</small>
              </div>
              <div class="market-controls">
                ${isJoined ? 
                  '<span style="color: var(--success-color); font-weight: bold;">å·²åŠ å…¥</span>' :
                  `<button onclick="joinCoop('${coop.id}')" class="btn success-btn" 
                           ${gameState.money >= coop.cost && coop.members < coop.maxMembers ? '' : 'disabled'}>
                     åŠ å…¥
                   </button>`
                }
              </div>
            </div>
          `;
        }).join('')}
        
        <div style="margin-top: 20px;">
          <h4>åˆä½œç¤¾ç¦åˆ©:</h4>
          <ul style="margin-left: 20px;">
            <li>é›†ä½“é‡‡è´­ï¼šè®¾å¤‡æˆæœ¬é™ä½</li>
            <li>ç»Ÿä¸€é”€å”®ï¼šå†œäº§å“ä»·æ ¼æå‡</li>
            <li>é£é™©åˆ†æ‹…ï¼šå‡å°‘ç¾å®³æŸå¤±</li>
            <li>æŠ€æœ¯å…±äº«ï¼šè·å¾—é¢å¤–ç ”å‘ç‚¹æ•°</li>
          </ul>
        </div>
      `;
    }

    function joinCoop(coopId) {
      const coop = GAME_CONFIG.COOPERATIVES.find(c => c.id === coopId);
      if (!coop) return;
      
      if (gameState.money >= coop.cost && coop.members < coop.maxMembers) {
        gameState.money -= coop.cost;
        gameState.joinedCoops.push(coopId);
        coop.members++;
        coop.effect();
        
        addLog(`åŠ å…¥${coop.name}æˆåŠŸï¼`, "success");
        gameState.reputation += 10;
        gainExperience('management', 25);
        
        updateCoopContent();
        updateDisplay();
      } else {
        addLog("æ— æ³•åŠ å…¥åˆä½œç¤¾ï¼šèµ„é‡‘ä¸è¶³æˆ–åé¢å·²æ»¡", "warning");
      }
    }

    // æˆå°±ç³»ç»Ÿ - å¢å¼ºç‰ˆ
    function checkAchievements() {
      GAME_CONFIG.ACHIEVEMENTS.forEach(achievement => {
        if (!gameState.achievements.includes(achievement.id) && achievement.condition()) {
          gameState.achievements.push(achievement.id);
          
          // ç»™äºˆå¥–åŠ±
          if (achievement.reward) {
            if (achievement.reward.money) {
              gameState.money += achievement.reward.money;
            }
            if (achievement.reward.reputation) {
              gameState.reputation += achievement.reward.reputation;
            }
            if (achievement.reward.researchPoints) {
              gameState.researchPoints += achievement.reward.researchPoints;
            }
          }
          
          addLog(`ğŸ† è·å¾—æˆå°±ï¼š${achievement.name}ï¼`, "success");
          
          // ç‰¹æ®Šæ•ˆæœ
          if (achievement.type === "hidden") {
            addLog("è¿™æ˜¯ä¸€ä¸ªéšè—æˆå°±ï¼", "info");
          }
        }
      });
    }

    function updateAchievementPanel() {
      const panel = document.getElementById('achievement-panel');
      
      if (gameState.achievements.length === 0) {
        panel.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— æˆå°±</p>';
        return;
      }
      
      // æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºæˆå°±
      const achievementsByType = {};
      GAME_CONFIG.ACHIEVEMENTS.forEach(achievement => {
        if (!achievementsByType[achievement.type]) {
          achievementsByType[achievement.type] = [];
        }
        achievementsByType[achievement.type].push(achievement);
      });
      
      let html = '';
      Object.keys(achievementsByType).forEach(type => {
        const typeAchievements = achievementsByType[type];
        const unlockedCount = typeAchievements.filter(a => gameState.achievements.includes(a.id)).length;
        const totalCount = typeAchievements.length;
        
        html += `<div style="margin-bottom: 10px;">
          <h5>${type} (${unlockedCount}/${totalCount})</h5>
        </div>`;
        
        typeAchievements.forEach(achievement => {
          const isUnlocked = gameState.achievements.includes(achievement.id);
          const itemClass = isUnlocked ? 'achievement-item unlocked' : 'achievement-item locked';
          
          html += `
            <div class="${itemClass}">
              <div class="achievement-icon">${achievement.icon}</div>
              <div class="achievement-info">
                <div class="achievement-name">${achievement.name}</div>
                <div class="achievement-desc">${achievement.description}</div>
                ${achievement.reward ? `<small style="color: var(--success-color);">å¥–åŠ±: ${Object.entries(achievement.reward).map(([key, value]) => `${key}: ${value}`).join(', ')}</small>` : ''}
              </div>
            </div>
          `;
        });
      });
      
      panel.innerHTML = html;
    }

    // æ›´æ–°åœ°å›¾æ˜¾ç¤º
    function updateMapDisplay(weatherEvent) {
      const overlay = document.getElementById('map-overlay');
      const satelliteOverlay = document.getElementById('satellite-overlay');
      
      overlay.textContent = `${weatherEvent.icon} ${weatherEvent.type}`;
      
      // æ¸…é™¤æ—§çš„æ•ˆæœ
      satelliteOverlay.className = 'satellite-overlay';
      
      // æ·»åŠ æ–°çš„è§†è§‰æ•ˆæœ
      if (weatherEvent.type === 'æ´ªæ°´') {
        satelliteOverlay.classList.add('flood-effect');
      } else if (weatherEvent.type.includes('å¹²æ—±')) {
        satelliteOverlay.classList.add('drought-effect');
      }
      
      // æ·»åŠ ç²’å­æ•ˆæœ
      createParticleEffect(weatherEvent.type);
    }

    // åˆ›å»ºç²’å­æ•ˆæœ
    function createParticleEffect(weatherType) {
      const particleContainer = document.getElementById('particles');
      particleContainer.innerHTML = '';
      
      let particleCount = 0;
      let emoji = '';
      let duration = 3000;
      
      switch(weatherType) {
        case 'æ´ªæ°´':
          particleCount = 25;
          emoji = 'ğŸ’§';
          duration = 3000;
          break;
        case 'å»¶è¿Ÿå¹²æ—±':
        case 'ä¸¥é‡å¹²æ—±':
          particleCount = 20;
          emoji = 'â˜€ï¸';
          duration = 4000;
          break;
        case 'ç—…è™«å®³':
          particleCount = 15;
          emoji = 'ğŸ›';
          duration = 2500;
          break;
        case 'å°é£':
          particleCount = 30;
          emoji = 'ğŸŒªï¸';
          duration = 2000;
          break;
        case 'éœœå†»':
          particleCount = 20;
          emoji = 'â„ï¸';
          duration = 3500;
          break;
      }
      
      for (let i = 0; i < particleCount; i++) {
        createParticle(particleContainer, emoji, duration);
      }
    }

    function createParticle(container, emoji, duration) {
      const particle = document.createElement('div');
      particle.textContent = emoji;
      particle.style.position = 'absolute';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.fontSize = (1 + Math.random()) + 'em';
      particle.style.animation = `particleFloat ${duration}ms linear`;
      particle.style.animationDelay = Math.random() * 1000 + 'ms';
      container.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, duration + 1000);
    }

    // æ›´æ–°äººå£ - å¢å¼ºç‰ˆ
    function updatePopulation() {
      // äººå£è‡ªç„¶å¢é•¿
      const growthRate = 1.02 + (gameState.reputation / 5000);
      gameState.population = Math.round(gameState.population * growthRate);
      
      // ç²®é£Ÿæ¶ˆè€—
      const grainNeeded = Math.ceil(gameState.population * 0.35);
      let totalGrain = gameState.crops.wheat + gameState.crops.rice + 
                       gameState.crops.corn + gameState.crops.sorghum;
      
      if (totalGrain >= grainNeeded) {
        // æŒ‰æ¯”ä¾‹æ¶ˆè€—ç²®é£Ÿ
        const consumptionRatio = grainNeeded / totalGrain;
        gameState.crops.wheat = Math.round(gameState.crops.wheat * (1 - consumptionRatio));
        gameState.crops.rice = Math.round(gameState.crops.rice * (1 - consumptionRatio));
        gameState.crops.corn = Math.round(gameState.crops.corn * (1 - consumptionRatio));
        gameState.crops.sorghum = Math.round(gameState.crops.sorghum * (1 - consumptionRatio));
        
        // äººå£æ»¡æ„åº¦æå‡
        gameState.reputation += 1;
      } else {
        // ç²®é£Ÿä¸è¶³ï¼Œäººå£å‡å°‘
        const deficit = grainNeeded - totalGrain;
        const populationLoss = Math.min(deficit * 2, gameState.population * 0.1);
        gameState.population = Math.max(50, gameState.population - populationLoss);
        
        // æ¸…ç©ºç²®é£Ÿå‚¨å¤‡
        gameState.crops.wheat = 0;
        gameState.crops.rice = 0;
        gameState.crops.corn = 0;
        gameState.crops.sorghum = 0;
        
        // å£°æœ›ä¸‹é™
        gameState.reputation = Math.max(0, gameState.reputation - 5);
        
        addLog(`ç²®é£Ÿä¸è¶³ï¼äººå£å‡å°‘${Math.round(populationLoss)}äºº`, "error");
      }
    }

    // å¸‚åœºç³»ç»Ÿ
    function showMarket() {
      document.getElementById('market-modal').style.display = 'flex';
      updateMarketContent();
    }

    function closeMarket() {
      document.getElementById('market-modal').style.display = 'none';
    }

    function updateMarketContent() {
      const content = document.getElementById('market-content');
      content.innerHTML = `
        <div style="text-align: left;">
          <h3>ğŸ“ˆ å¸‚åœºè¡Œæƒ…</h3>
          ${gameState.marketInsight ? '<p style="color: var(--info-color);">ğŸ’¡ æ‚¨æ‹¥æœ‰å¸‚åœºæ´å¯Ÿèƒ½åŠ›ï¼Œå¯ä»¥é¢„æµ‹ä»·æ ¼è¶‹åŠ¿</p>' : ''}
          <div style="margin: 15px 0;">
            <h4>ğŸª å‡ºå”®å†œäº§å“</h4>
            ${Object.keys(gameState.crops).map(cropKey => {
              const cropName = getCropName(cropKey);
              const price = gameState.cropPrices[cropKey];
              const quantity = gameState.crops[cropKey];
              
              // å¸‚åœºæ´å¯Ÿï¼šæ˜¾ç¤ºä»·æ ¼è¶‹åŠ¿
              let trendIndicator = '';
              if (gameState.marketInsight) {
                const trend = Math.sin((gameState.year + 1) * 0.2) - Math.sin(gameState.year * 0.2);
                if (trend > 0.05) trendIndicator = ' ğŸ“ˆ';
                else if (trend < -0.05) trendIndicator = ' ğŸ“‰';
                else trendIndicator = ' â¡ï¸';
              }
              
              return `
                <div class="market-item">
                  <div class="market-item-info">
                    <strong>${cropName}</strong>${trendIndicator}<br>
                    <small>åº“å­˜: ${quantity} | å¸‚åœºä»·: â‚¹${price}</small>
                  </div>
                  <div class="market-controls">
                    <input type="number" class="market-input" id="sell-${cropKey}" 
                           min="0" max="${quantity}" value="0">
                    <button onclick="sellCrop('${cropKey}')" class="btn success-btn" 
                            style="padding: 5px 10px;" ${quantity > 0 ? '' : 'disabled'}>å‡ºå”®</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="margin: 15px 0;">
            <h4>ğŸ›’ è´­ä¹°å†œäº§å“</h4>
            <p style="font-size: 0.9em; color: #666;">ä»å¸‚åœºè´­ä¹°å†œäº§å“ä»¥è¡¥å……åº“å­˜ï¼ˆä»·æ ¼ä¸ºå¸‚ä»·çš„120%ï¼‰</p>
            ${Object.keys(gameState.crops).map(cropKey => {
              const cropName = getCropName(cropKey);
              const buyPrice = Math.round(gameState.cropPrices[cropKey] * 1.2);
              
              return `
                <div class="market-item">
                  <div class="market-item-info">
                    <strong>${cropName}</strong><br>
                    <small>è´­ä¹°ä»·: â‚¹${buyPrice}</small>
                  </div>
                  <div class="market-controls">
                    <input type="number" class="market-input" id="buy-${cropKey}" 
                           min="0" value="0">
                    <button onclick="buyCrop('${cropKey}')" class="btn warning-btn" 
                            style="padding: 5px 10px;">è´­ä¹°</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function sellCrop(cropKey) {
      const amount = parseInt(document.getElementById(`sell-${cropKey}`).value) || 0;
      const available = gameState.crops[cropKey];
      const price = gameState.cropPrices[cropKey];
      
      if (amount <= 0) {
        addLog("è¯·è¾“å…¥æœ‰æ•ˆçš„å‡ºå”®æ•°é‡ï¼", "warning");
        return;
      }
      
      if (amount > available) {
        addLog("åº“å­˜ä¸è¶³ï¼", "warning");
        return;
      }
      
      const income = amount * price;
      gameState.money += income;
      gameState.crops[cropKey] -= amount;
      gameState.totalIncome += income;
      
      addLog(`å‡ºå”®${amount}å•ä½${getCropName(cropKey)}ï¼Œè·å¾—â‚¹${income}`, "success");
      gainExperience('market', 8);
      gameState.reputation += Math.floor(amount / 20);
      
      updateMarketContent();
      updateDisplay();
      updateMarketPanel();
    }

    function buyCrop(cropKey) {
      const amount = parseInt(document.getElementById(`buy-${cropKey}`).value) || 0;
      const buyPrice = Math.round(gameState.cropPrices[cropKey] * 1.2);
      const totalCost = amount * buyPrice;
      
      if (amount <= 0) {
        addLog("è¯·è¾“å…¥æœ‰æ•ˆçš„è´­ä¹°æ•°é‡ï¼", "warning");
        return;
      }
      
      if (totalCost > gameState.money) {
        addLog("èµ„é‡‘ä¸è¶³ï¼", "warning");
        return;
      }
      
      gameState.money -= totalCost;
      gameState.crops[cropKey] += amount;
      
      addLog(`è´­ä¹°${amount}å•ä½${getCropName(cropKey)}ï¼ŒèŠ±è´¹â‚¹${totalCost}`, "info");
      gainExperience('market', 6);
      
      updateMarketContent();
      updateDisplay();
      updateMarketPanel();
    }

    // è´·æ¬¾ç³»ç»Ÿ - å¢å¼ºç‰ˆ
    function showLoanCenter() {
      document.getElementById('loan-modal').style.display = 'flex';
      updateLoanContent();
    }

    function closeLoanCenter() {
      document.getElementById('loan-modal').style.display = 'none';
    }

    function updateLoanContent() {
      const content = document.getElementById('loan-content');
      const reputationDiscount = Math.min(0.3, gameState.reputation / 300);
      
      content.innerHTML = `
        <div style="text-align: left;">
          <h3>å½“å‰å€ºåŠ¡: â‚¹${gameState.debt}</h3>
          ${gameState.reputation >= 100 ? `<p style="color: var(--success-color);">ğŸŒŸ å£°æœ›ä¼˜æƒ ï¼šåˆ©ç‡é™ä½${(reputationDiscount * 100).toFixed(1)}%</p>` : ''}
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>å°é¢è´·æ¬¾</strong><br>
              <small>é‡‘é¢: â‚¹800 | åˆ©ç‡: ${(5 * (1 - reputationDiscount)).toFixed(1)}%/å¹´</small>
            </div>
            <button onclick="takeLoan(800, ${0.05 * (1 - reputationDiscount)})" class="btn warning-btn">ç”³è¯·è´·æ¬¾</button>
          </div>
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>è®¾å¤‡è´·æ¬¾</strong><br>
              <small>é‡‘é¢: â‚¹2000 | åˆ©ç‡: ${(8 * (1 - reputationDiscount)).toFixed(1)}%/å¹´</small>
            </div>
            <button onclick="takeLoan(2000, ${0.08 * (1 - reputationDiscount)})" class="btn warning-btn">ç”³è¯·è´·æ¬¾</button>
          </div>
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>å‘å±•è´·æ¬¾</strong><br>
              <small>é‡‘é¢: â‚¹5000 | åˆ©ç‡: ${(12 * (1 - reputationDiscount)).toFixed(1)}%/å¹´</small>
            </div>
            <button onclick="takeLoan(5000, ${0.12 * (1 - reputationDiscount)})" class="btn warning-btn" 
                    ${gameState.reputation >= 80 ? '' : 'disabled'}>ç”³è¯·è´·æ¬¾</button>
          </div>
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>è¿˜æ¬¾</strong><br>
              <small>æ¯å¹´åˆ©æ¯: â‚¹${Math.round(gameState.debt * 0.08)}</small>
            </div>
            <div>
              <button onclick="repayDebt(Math.min(1000, gameState.debt))" class="btn success-btn" 
                      ${gameState.debt >= 1000 && gameState.money >= 1000 ? '' : 'disabled'}>
                éƒ¨åˆ†è¿˜æ¬¾(â‚¹1000)
              </button>
              <button onclick="repayDebt(gameState.debt)" class="btn success-btn" 
                      ${gameState.debt > 0 && gameState.money >= gameState.debt ? '' : 'disabled'}>
                å…¨é¢è¿˜æ¬¾
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function takeLoan(amount, rate) {
      gameState.money += amount;
      gameState.debt += amount * (1 + rate);
      addLog(`è·å¾—è´·æ¬¾â‚¹${amount}ï¼Œéœ€è¿˜æ¬¾â‚¹${Math.round(amount * (1 + rate))}`, "warning");
      gameState.reputation = Math.max(0, gameState.reputation - 2);
      updateDisplay();
      updateLoanContent();
    }

    function repayDebt(amount) {
      if (gameState.money >= amount && amount <= gameState.debt) {
        gameState.money -= amount;
        gameState.debt -= amount;
        addLog(`è¿˜æ¬¾â‚¹${amount}`, "success");
        gameState.reputation += Math.floor(amount / 500);
        updateDisplay();
        updateLoanContent();
      }
    }

    // ä¿é™©ç³»ç»Ÿ - å¢å¼ºç‰ˆ
    function showInsurance() {
      document.getElementById('insurance-modal').style.display = 'flex';
      updateInsuranceContent();
    }

    function closeInsurance() {
      document.getElementById('insurance-modal').style.display = 'none';
    }

    function updateInsuranceContent() {
      const content = document.getElementById('insurance-content');
      const costMultiplier = gameState.insuranceCostMultiplier;
      
      content.innerHTML = `
        <div style="text-align: left;">
          <h3>ä¿é™©çŠ¶æ€: ${gameState.insurance ? 'âœ… å·²æŠ•ä¿' : 'âŒ æœªæŠ•ä¿'}</h3>
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>åŸºç¡€å†œä¸šä¿é™©</strong><br>
              <small>ä¿è´¹: â‚¹${Math.round(300 * costMultiplier)}/å¹´ | ä¿éšœ: ç¾å®³æŸå¤±50%è¡¥å¿</small>
            </div>
            <button onclick="buyInsurance('basic', ${Math.round(300 * costMultiplier)})" 
                    ${gameState.insurance ? 'disabled' : ''} class="btn success-btn">
              ${gameState.insurance ? 'å·²æŠ•ä¿' : 'è´­ä¹°ä¿é™©'}
            </button>
          </div>
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>ç»¼åˆå†œä¸šä¿é™©</strong><br>
              <small>ä¿è´¹: â‚¹${Math.round(500 * costMultiplier)}/å¹´ | ä¿éšœ: ç¾å®³æŸå¤±70%è¡¥å¿ + ä»·æ ¼ä¿éšœ</small>
            </div>
            <button onclick="buyInsurance('comprehensive', ${Math.round(500 * costMultiplier)})" 
                    ${gameState.comprehensiveInsurance ? 'disabled' : ''} class="btn info-btn">
              ${gameState.comprehensiveInsurance ? 'å·²æŠ•ä¿' : 'è´­ä¹°ä¿é™©'}
            </button>
          </div>
          
          <div class="market-item">
            <div class="market-item-info">
              <strong>è®¾å¤‡ä¿é™©</strong><br>
              <small>ä¿è´¹: â‚¹${Math.round(400 * costMultiplier)}/å¹´ | ä¿éšœ: è®¾å¤‡æŸåå…¨é¢èµ”å¿</small>
            </div>
            <button onclick="buyInsurance('equipment', ${Math.round(400 * costMultiplier)})" 
                    ${gameState.equipmentInsurance ? 'disabled' : ''} class="btn warning-btn">
              ${gameState.equipmentInsurance ? 'å·²æŠ•ä¿' : 'è´­ä¹°ä¿é™©'}
            </button>
          </div>
          
          <p><small>ä¿é™©å¯ä»¥åœ¨é­å—è‡ªç„¶ç¾å®³æ—¶è·å¾—æŸå¤±è¡¥å¿ï¼Œé™ä½ç»è¥é£é™©ã€‚åˆä½œç¤¾æˆå‘˜äº«å—ä¿è´¹ä¼˜æƒ ã€‚</small></p>
        </div>
      `;
    }

    function buyInsurance(type, cost) {
      if (gameState.money >= cost) {
        gameState.money -= cost;
        
        switch(type) {
          case 'basic':
            gameState.insurance = true;
            addLog("è´­ä¹°åŸºç¡€å†œä¸šä¿é™©æˆåŠŸ", "success");
            break;
          case 'comprehensive':
            gameState.comprehensiveInsurance = true;
            addLog("è´­ä¹°ç»¼åˆå†œä¸šä¿é™©æˆåŠŸ", "success");
            break;
          case 'equipment':
            gameState.equipmentInsurance = true;
            addLog("è´­ä¹°è®¾å¤‡ä¿é™©æˆåŠŸ", "success");
            break;
        }
        
        gameState.reputation += 5;
        updateDisplay();
        updateInsuranceContent();
      } else {
        addLog("èµ„é‡‘ä¸è¶³ï¼", "warning");
      }
    }

    // æ›´æ–°å¸‚åœºé¢æ¿
    function updateMarketPanel() {
      const panel = document.getElementById('market-panel');
      let html = '';
      
      Object.keys(gameState.crops).forEach(cropKey => {
        const cropName = getCropName(cropKey);
        const quantity = gameState.crops[cropKey];
        const price = gameState.cropPrices[cropKey];
        
        if (quantity > 0 || price > 0) {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.5); border-radius: 4px;">
              <div>
                <strong>${cropName}</strong><br>
                <small>åº“å­˜: ${quantity}</small>
              </div>
              <div style="text-align: right;">
                <strong>â‚¹${price}</strong><br>
                <small style="color: #666;">å•ä»·</small>
              </div>
            </div>
          `;
        }
      });
      
      panel.innerHTML = html || '<p style="color: #666; text-align: center;">æš‚æ— å†œäº§å“</p>';
    }

    // æ›´æ–°è®¾å¤‡é¢æ¿
    function updateEquipmentPanel() {
      const panel = document.getElementById('equipment-panel');
      let html = '';
      
      // æ˜¾ç¤ºå·²æœ‰è®¾å¤‡
      if (gameState.equipment.length > 0) {
        html += '<h5>å·²æœ‰è®¾å¤‡:</h5>';
        gameState.equipment.forEach(equipment => {
          html += `
            <div style="margin: 5px 0; padding: 8px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid var(--success-color);">
              <strong>${equipment.icon} ${equipment.name}</strong><br>
              <small>${equipment.effect}</small>
            </div>
          `;
        });
      }
      
      // æ˜¾ç¤ºå¯è´­ä¹°è®¾å¤‡
      const availableEquipment = GAME_CONFIG.EQUIPMENT.filter(eq => 
        !gameState.equipment.some(owned => owned.name === eq.name)
      );
      
      if (availableEquipment.length > 0) {
        html += '<h5 style="margin-top: 15px;">å¯è´­ä¹°è®¾å¤‡:</h5>';
        availableEquipment.slice(0, 3).forEach(equipment => {
          const canAfford = gameState.money >= Math.round(equipment.cost * gameState.equipmentCostMultiplier);
          html += `
            <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px; opacity: ${canAfford ? '1' : '0.6'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>${equipment.icon} ${equipment.name}</strong><br>
                  <small>${equipment.effect}</small><br>
                  <small style="color: #666;">T${equipment.tier} | â‚¹${Math.round(equipment.cost * gameState.equipmentCostMultiplier)}</small>
                </div>
                <button onclick="buyEquipment('${equipment.name}')" class="btn ${canAfford ? 'success-btn' : 'disabled'}" 
                        style="padding: 4px 8px; font-size: 0.8em;" ${canAfford ? '' : 'disabled'}>
                  è´­ä¹°
                </button>
              </div>
            </div>
          `;
        });
      }
      
      panel.innerHTML = html || '<p style="color: #666; text-align: center;">æš‚æ— è®¾å¤‡</p>';
    }

    // è´­ä¹°è®¾å¤‡
    function buyEquipment(equipmentName) {
      const equipment = GAME_CONFIG.EQUIPMENT.find(eq => eq.name === equipmentName);
      if (!equipment) return;
      
      const cost = Math.round(equipment.cost * gameState.equipmentCostMultiplier);
      
      if (gameState.money >= cost) {
        gameState.money -= cost;
        gameState.equipment.push(equipment);
        
        addLog(`è´­ä¹°${equipment.name}æˆåŠŸï¼`, "success");
        gainExperience('management', 15);
        gameState.reputation += 8;
        
        updateDisplay();
        updateEquipmentPanel();
      } else {
        addLog("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹°è®¾å¤‡ï¼", "warning");
      }
    }

    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
    function checkGameOver() {
      // äººå£è¿‡å°‘
      if (gameState.population <= 25) {
        showGameOverModal("æ¸¸æˆå¤±è´¥", "äººå£æ•°é‡è¿‡å°‘ï¼Œæ— æ³•ç»´æŒç¤¾ä¼šè¿è½¬ï¼", "failure");
        return true;
      }
      
      // å€ºåŠ¡è¿‡é‡
      if (gameState.money < -3000) {
        showGameOverModal("æ¸¸æˆå¤±è´¥", "å€ºåŠ¡è¿‡é‡ï¼Œå†œåœºç ´äº§ï¼", "failure");
        return true;
      }
      
      // æŒ‘æˆ˜æ¨¡å¼èƒœåˆ©
      if (gameState.gameMode === 'challenge' && gameState.year >= gameState.challengeYears) {
        showGameOverModal("æŒ‘æˆ˜æˆåŠŸ", `æ­å–œï¼æ‚¨æˆåŠŸç»è¥å†œåœº${gameState.challengeYears}å¹´ï¼`, "success");
        return true;
      }
      
      // æé™æ¨¡å¼ç‰¹æ®Šèƒœåˆ©æ¡ä»¶
      if (gameState.gameMode === 'extreme' && gameState.year >= 25 && gameState.reputation >= 200) {
        showGameOverModal("ä¼ å¥‡æˆå°±", "æ‚¨åœ¨æé™æ¨¡å¼ä¸‹æˆä¸ºäº†å†œä¸šä¼ å¥‡ï¼", "success");
        return true;
      }
      
      return false;
    }

    // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
    function showGameOverModal(title, message, status) {
      const modal = document.getElementById('game-over-modal');
      const modalContent = document.getElementById('modal-content');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      
      modal.style.display = 'flex';
      modalContent.classList.remove('success', 'failure');
      modalContent.classList.add(status);
      modalTitle.textContent = title;
      
      const finalStats = `
        ${message}<br><br>
        <strong>æœ€ç»ˆç»Ÿè®¡ï¼š</strong><br>
        ğŸ’° èµ„é‡‘: â‚¹${gameState.money}<br>
        ğŸ‘¥ äººå£: ${gameState.population}<br>
        ğŸ‘¨â€ğŸŒ¾ å†œæ°‘ç­‰çº§: ${gameState.farmerLevel}<br>
        ğŸŒŸ å£°æœ›: ${gameState.reputation} (${gameState.reputationLevel})<br>
        ğŸ’µ æ€»æ”¶å…¥: â‚¹${gameState.totalIncome}<br>
        ğŸ“Š æ”¶è·æ¬¡æ•°: ${gameState.totalHarvests}<br>
        ğŸ† æˆå°±æ•°é‡: ${gameState.achievements.length}/${GAME_CONFIG.ACHIEVEMENTS.length}<br>
        ğŸ”¬ å®Œæˆç ”å‘: ${gameState.completedResearch.length}/${GAME_CONFIG.RESEARCH.length}<br>
        ğŸ¤ åŠ å…¥åˆä½œç¤¾: ${gameState.joinedCoops.length}/${GAME_CONFIG.COOPERATIVES.length}
      `;
      
      modalMessage.innerHTML = finalStats;
    }

    // æ›´æ–°å†å²æ˜¾ç¤º
    function updateHistoryDisplay() {
      const tbody = document.getElementById('history-body');
      const recentHistory = gameState.history.slice(-10).reverse();
      
      tbody.innerHTML = recentHistory.map(record => `
        <tr>
          <td>${record.year}</td>
          <td>${record.weather}</td>
          <td>â‚¹${record.income}</td>
          <td>${record.crop}</td>
        </tr>
      `).join('');
    }

    // æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
    function updateDisplay() {
      document.getElementById('money').textContent = gameState.money;
      document.getElementById('current-population').textContent = gameState.population;
      document.getElementById('current-year').textContent = gameState.year;
      document.getElementById('climate-risk').textContent = Math.round(gameState.climateRisk);
      document.getElementById('farmer-level').textContent = gameState.farmerLevel;
      document.getElementById('current-season').textContent = GAME_CONFIG.SEASONS[gameState.season];
      document.getElementById('reputation').textContent = gameState.reputation;
      document.getElementById('research-points').textContent = gameState.researchPoints;
      
      updateSkillDisplay();
      updateReputationLevel();
    }

    // æ—¥å¿—ç³»ç»Ÿ
    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      // é™åˆ¶æ—¥å¿—æ¡æ•°
      while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.firstChild);
      }
    }

    // é‡æ–°å¼€å§‹æ¸¸æˆ
    function restartGame() {
      // é‡ç½®æ¸¸æˆçŠ¶æ€
      gameState = {
        money: 2000,
        population: 200,
        year: 1,
        season: 0,
        farmerLevel: 1,
        currentCrop: null,
        crops: {
          wheat: 200,
          rice: 0,
          corn: 0,
          sorghum: 0,
          cotton: 0,
          tea: 0,
          sugarcane: 0,
          rubber: 0,
          coffee: 0,
          cocoa: 0
        },
        cropPrices: {},
        cropsPlanted: {},
        equipment: [],
        currentPolicy: null,
        policyDuration: 0,
        gameMode: 'tutorial',
        difficulty: 50,
        challengeYears: 20,
        birthplace: 'china-north',
        totalHarvests: 0,
        totalIncome: 0,
        consecutiveWeatherSuccess: 0,
        consecutiveNormalWeather: 0,
        extremeWeatherSurvived: 0,
        perfectYears: 0,
        maxSingleProfit: 0,
        history: [],
        achievements: [],
        plantingExp: 0,
        managementExp: 0,
        marketExp: 0,
        plantingLevel: 1,
        managementLevel: 1,
        marketLevel: 1,
        debt: 0,
        insurance: false,
        reputation: 50,
        reputationLevel: "æ–°æ‰‹å†œæ°‘",
        researchPoints: 0,
        completedResearch: [],
        ongoingResearch: null,
        researchProgress: 0,
        joinedCoops: [],
        coopBonus: 0,
        droughtResistance: 0,
        pestResistance: 0,
        yieldBonus: 0,
        soilQuality: 0,
        automation: 0,
        climateAdaptation: 0,
        marketInsight: false,
        weatherPrediction: false,
        nextWeatherEvent: null,
        incomeMultiplier: 1,
        equipmentCostMultiplier: 1,
        insuranceCostMultiplier: 1,
        grainPriceBonus: 0,
        climateRisk: 30,
        riskTakingSuccess: false,
        comebackSuccess: false
      };
      
      // é‡ç½®æ•™ç¨‹
      currentTutorialStep = 0;
      
      // é‡ç½®ç•Œé¢
      initializePrices();
      updateDisplay();
      updateMarketPanel();
      updateEquipmentPanel();
      updateAchievementPanel();
      
      document.getElementById('game-over-modal').style.display = 'none';
      document.getElementById('mode-selection-modal').style.display = 'flex';
      document.getElementById('current-crop-display').textContent = 'æ— ';
      document.getElementById('history-body').innerHTML = '';
      document.getElementById('log-container').innerHTML = '';
      document.getElementById('policy-effect').style.display = 'none';
      
      // æ¸…é™¤ä½œç‰©é€‰æ‹©çŠ¶æ€
      document.querySelectorAll('.crop-button').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      addLog("æ¸¸æˆé‡ç½®ï¼Œæ¬¢è¿å†æ¬¡ä½“éªŒå¢å¼ºç‰ˆï¼", "success");
    }

    // å¯¼å‡ºæˆ˜ç»©ç³»ç»Ÿ - å¤§å¹…å¢å¼º
    function exportScore() {
      document.getElementById('export-score-modal').style.display = 'flex';
    }

    function closeExportModal() {
      document.getElementById('export-score-modal').style.display = 'none';
    }

    // å¯¼å‡ºå›¾ç‰‡
    function exportScoreImage() {
      const playerName = document.getElementById('player-name').value || 'åŒ¿åç©å®¶';
      
      // åˆ›å»ºcanvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 1200;
      canvas.height = 1000;
      
      // ç»˜åˆ¶èƒŒæ™¯
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, '#667eea');
      gradient.addColorStop(0.5, '#764ba2');
      gradient.addColorStop(1, '#f093fb');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // æ·»åŠ è£…é¥°è¾¹æ¡†
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 5;
      ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
      
      // ç»˜åˆ¶æ ‡é¢˜
      ctx.fillStyle = 'white';
      ctx.font = 'bold 52px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('ğŸŒ¦ï¸ å­£é£å†³ç­–è€… - å¢å¼ºç‰ˆ', canvas.width / 2, 100);
      
      // ç»˜åˆ¶å‰¯æ ‡é¢˜
      ctx.font = '28px Arial';
      ctx.fillText('å†œä¸šç®¡ç†æˆå°±æŠ¥å‘Š', canvas.width / 2, 140);
      
      // ç»˜åˆ¶ç©å®¶ä¿¡æ¯
      ctx.font = 'bold 36px Arial';
      ctx.fillText(`å†œåœºä¸»ï¼š${playerName}`, canvas.width / 2, 200);
      
      // ç»˜åˆ¶æ¸¸æˆæ•°æ®
      ctx.font = '24px Arial';
      ctx.textAlign = 'left';
      const leftStats = [
        `ğŸ® æ¸¸æˆæ¨¡å¼ï¼š${gameState.gameMode}`,
        `ğŸ“Š éš¾åº¦ç­‰çº§ï¼š${gameState.difficulty}%`,
        `ğŸŒ å‡ºç”Ÿåœ°ï¼š${gameState.birthplace}`,
        `ğŸ“… ç»è¥å¹´æ•°ï¼š${gameState.year}å¹´`,
        `ğŸ’° æœ€ç»ˆèµ„é‡‘ï¼šâ‚¹${gameState.money}`,
        `ğŸ‘¥ æœ€ç»ˆäººå£ï¼š${gameState.population}äºº`,
        `ğŸ‘¨â€ğŸŒ¾ å†œæ°‘ç­‰çº§ï¼š${gameState.farmerLevel}çº§`,
        `ğŸŒŸ å£°æœ›ç­‰çº§ï¼š${gameState.reputationLevel}`,
        `ğŸ’µ æ€»æ”¶å…¥ï¼šâ‚¹${gameState.totalIncome}`,
        `ğŸ“Š æ”¶è·æ¬¡æ•°ï¼š${gameState.totalHarvests}æ¬¡`
      ];
      
      const rightStats = [
        `ğŸ”¬ å®Œæˆç ”å‘ï¼š${gameState.completedResearch.length}/${GAME_CONFIG.RESEARCH.length}`,
        `ğŸ¤ åŠ å…¥åˆä½œç¤¾ï¼š${gameState.joinedCoops.length}`,
        `âš¡ è¿ç»­æˆåŠŸï¼š${gameState.consecutiveWeatherSuccess}å¹´`,
        `ğŸŒªï¸ æç«¯å¤©æ°”ï¼š${gameState.extremeWeatherSurvived}æ¬¡`,
        `ğŸ’ æœ€å¤§æ”¶ç›Šï¼šâ‚¹${gameState.maxSingleProfit}`,
        `ğŸ”§ æ‹¥æœ‰è®¾å¤‡ï¼š${gameState.equipment.length}ä»¶`,
        `ğŸ† è·å¾—æˆå°±ï¼š${gameState.achievements.length}/${GAME_CONFIG.ACHIEVEMENTS.length}`,
        `ğŸ§ª ç ”å‘ç‚¹æ•°ï¼š${gameState.researchPoints}`,
        `â­ å£°æœ›å€¼ï¼š${gameState.reputation}`,
        `ğŸ“ˆ å®Œç¾å¹´ä»½ï¼š${gameState.perfectYears}å¹´`
      ];
      
      // ç»˜åˆ¶å·¦åˆ—æ•°æ®
      leftStats.forEach((stat, index) => {
        ctx.fillText(stat, 80, 280 + index * 35);
      });
      
      // ç»˜åˆ¶å³åˆ—æ•°æ®
      rightStats.forEach((stat, index) => {
        ctx.fillText(stat, 620, 280 + index * 35);
      });
      
      // ç»˜åˆ¶æˆå°±åŒºåŸŸ
      ctx.font = 'bold 32px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('ğŸ† ä¸»è¦æˆå°±', canvas.width / 2, 680);
      
      ctx.font = '20px Arial';
      ctx.textAlign = 'left';
      const majorAchievements = gameState.achievements
        .map(id => GAME_CONFIG.ACHIEVEMENTS.find(a => a.id === id))
        .filter(a => a && (a.type === 'legendary' || a.type === 'special'))
        .slice(0, 6);
      
      if (majorAchievements.length > 0) {
        majorAchievements.forEach((achievement, index) => {
          const col = index % 2;
          const row = Math.floor(index / 2);
          const x = col === 0 ? 80 : 620;
          const y = 720 + row * 35;
          ctx.fillText(`${achievement.icon} ${achievement.name}`, x, y);
        });
      } else {
        ctx.textAlign = 'center';
        ctx.fillText('å°šæœªè·å¾—é‡å¤§æˆå°±', canvas.width / 2, 720);
      }
      
      // ç»˜åˆ¶åº•éƒ¨ä¿¡æ¯
      ctx.font = '18px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(`å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}`, canvas.width / 2, 920);
      ctx.fillText('æ„Ÿè°¢æ‚¨æ¸¸ç©å­£é£å†³ç­–è€…å¢å¼ºç‰ˆï¼', canvas.width / 2, 950);
      
      // ä¸‹è½½å›¾ç‰‡
      const link = document.createElement('a');
      link.download = `å­£é£å†³ç­–è€…å¢å¼ºç‰ˆ-æˆ˜ç»©-${playerName}-${new Date().toLocaleDateString()}.png`;
      link.href = canvas.toDataURL();
      link.click();
      
      closeExportModal();
      addLog("æˆ˜ç»©å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼", "success");
    }

    // å¯¼å‡ºJSONæ•°æ®
    function exportScoreJSON() {
      const playerName = document.getElementById('player-name').value || 'åŒ¿åç©å®¶';
      
      const exportData = {
        version: "å¢å¼ºç‰ˆ",
        playerName: playerName,
        exportTime: new Date().toISOString(),
        gameState: { ...gameState },
        summary: {
          totalPlayTime: `${gameState.year}å¹´`,
          finalScore: calculateFinalScore(),
          grade: calculateGrade(),
          completionRate: {
            achievements: `${gameState.achievements.length}/${GAME_CONFIG.ACHIEVEMENTS.length}`,
            research: `${gameState.completedResearch.length}/${GAME_CONFIG.RESEARCH.length}`,
            cooperatives: `${gameState.joinedCoops.length}/${GAME_CONFIG.COOPERATIVES.length}`
          }
        },
        statistics: {
          economicStats: {
            totalIncome: gameState.totalIncome,
            maxSingleProfit: gameState.maxSingleProfit,
            finalWealth: gameState.money,
            debtHistory: gameState.debt
          },
          agriculturalStats: {
            totalHarvests: gameState.totalHarvests,
            cropsPlanted: Object.keys(gameState.cropsPlanted || {}).length,
            equipmentOwned: gameState.equipment.length,
            farmerLevel: gameState.farmerLevel
          },
          socialStats: {
            finalPopulation: gameState.population,
            reputation: gameState.reputation,
            reputationLevel: gameState.reputationLevel,
            cooperativesJoined: gameState.joinedCoops.length
          },
          survivalStats: {
            extremeWeatherSurvived: gameState.extremeWeatherSurvived,
            consecutiveSuccesses: gameState.consecutiveWeatherSuccess,
            perfectYears: gameState.perfectYears
          }
        },
        achievements: gameState.achievements.map(id => {
          const achievement = GAME_CONFIG.ACHIEVEMENTS.find(a => a.id === id);
          return achievement ? {
            id: achievement.id,
            name: achievement.name,
            type: achievement.type,
            description: achievement.description
          } : null;
        }).filter(a => a),
        research: gameState.completedResearch.map(id => {
          const research = GAME_CONFIG.RESEARCH.find(r => r.id === id);
          return research ? {
            id: research.id,
            name: research.name,
            category: research.category,
            description: research.description
          } : null;
        }).filter(r => r)
      };
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `å­£é£å†³ç­–è€…å¢å¼ºç‰ˆ-æ•°æ®-${playerName}-${new Date().toLocaleDateString()}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      closeExportModal();
      addLog("æ¸¸æˆæ•°æ®å¯¼å‡ºæˆåŠŸï¼", "success");
    }

    // å¯¼å‡ºè¯¦ç»†æŠ¥å‘Š
    function exportDetailedReport() {
      const playerName = document.getElementById('player-name').value || 'åŒ¿åç©å®¶';
      
      const report = `
# å­£é£å†³ç­–è€…å¢å¼ºç‰ˆ - è¯¦ç»†æ¸¸æˆæŠ¥å‘Š

**å†œåœºä¸»**: ${playerName}
**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: ${new Date().toLocaleString()}

## ğŸ® æ¸¸æˆæ¦‚å†µ
- **æ¸¸æˆæ¨¡å¼**: ${gameState.gameMode}
- **éš¾åº¦ç­‰çº§**: ${gameState.difficulty}%
- **å‡ºç”Ÿåœ°**: ${gameState.birthplace}
- **ç»è¥å¹´æ•°**: ${gameState.year}å¹´
- **æœ€ç»ˆè¯„çº§**: ${calculateGrade()}
- **ç»¼åˆå¾—åˆ†**: ${calculateFinalScore()}åˆ†

## ğŸ’° ç»æµæ•°æ®
- **æœ€ç»ˆèµ„é‡‘**: â‚¹${gameState.money}
- **æ€»æ”¶å…¥**: â‚¹${gameState.totalIncome}
- **å•æ¬¡æœ€å¤§æ”¶ç›Š**: â‚¹${gameState.maxSingleProfit}
- **å½“å‰å€ºåŠ¡**: â‚¹${gameState.debt}
- **å¹³å‡å¹´æ”¶å…¥**: â‚¹${Math.round(gameState.totalIncome / gameState.year)}

## ğŸŒ¾ å†œä¸šæ•°æ®
- **æ€»æ”¶è·æ¬¡æ•°**: ${gameState.totalHarvests}
- **å†œæ°‘ç­‰çº§**: ${gameState.farmerLevel}çº§
- **ç§æ¤ç»éªŒ**: ${gameState.plantingExp}
- **ç®¡ç†ç»éªŒ**: ${gameState.managementExp}
- **å¸‚åœºç»éªŒ**: ${gameState.marketExp}
- **æ‹¥æœ‰è®¾å¤‡**: ${gameState.equipment.length}ä»¶
- **ç§æ¤ä½œç‰©ç§ç±»**: ${Object.keys(gameState.cropsPlanted || {}).length}ç§

## ğŸ‘¥ ç¤¾ä¼šæ•°æ®
- **æœ€ç»ˆäººå£**: ${gameState.population}äºº
- **å£°æœ›å€¼**: ${gameState.reputation}
- **å£°æœ›ç­‰çº§**: ${gameState.reputationLevel}
- **åŠ å…¥åˆä½œç¤¾**: ${gameState.joinedCoops.length}ä¸ª

## ğŸŒªï¸ ç”Ÿå­˜æ•°æ®
- **åº¦è¿‡æç«¯å¤©æ°”**: ${gameState.extremeWeatherSurvived}æ¬¡
- **è¿ç»­æˆåŠŸå¹´æ•°**: ${gameState.consecutiveWeatherSuccess}å¹´
- **å®Œç¾ç»è¥å¹´æ•°**: ${gameState.perfectYears}å¹´
- **è¿ç»­æ­£å¸¸å¤©æ°”**: ${gameState.consecutiveNormalWeather}å¹´

## ğŸ”¬ ç§‘æŠ€å‘å±•
- **ç ”å‘ç‚¹æ•°**: ${gameState.researchPoints}
- **å®Œæˆç ”å‘é¡¹ç›®**: ${gameState.completedResearch.length}/${GAME_CONFIG.RESEARCH.length}
- **ç ”å‘å®Œæˆç‡**: ${((gameState.completedResearch.length / GAME_CONFIG.RESEARCH.length) * 100).toFixed(1)}%

### å·²å®Œæˆç ”å‘:
${gameState.completedResearch.map(id => {
  const research = GAME_CONFIG.RESEARCH.find(r => r.id === id);
  return research ? `- ${research.name}: ${research.description}` : '';
}).join('\n')}

## ğŸ† æˆå°±ç³»ç»Ÿ
- **è·å¾—æˆå°±**: ${gameState.achievements.length}/${GAME_CONFIG.ACHIEVEMENTS.length}
- **æˆå°±å®Œæˆç‡**: ${((gameState.achievements.length / GAME_CONFIG.ACHIEVEMENTS.length) * 100).toFixed(1)}%

### å·²è·å¾—æˆå°±:
${gameState.achievements.map(id => {
  const achievement = GAME_CONFIG.ACHIEVEMENTS.find(a => a.id === id);
  return achievement ? `- [${achievement.type}] ${achievement.name}: ${achievement.description}` : '';
}).join('\n')}

## ğŸ“Š å†å²è®°å½•
### æœ€è¿‘10å¹´ç»è¥è®°å½•:
${gameState.history.slice(-10).map(record => 
  `- ç¬¬${record.year}å¹´: ${record.weather}, ç§æ¤${record.crop}, æ”¶è·${record.quantity}å•ä½, æ”¶å…¥â‚¹${record.income}`
).join('\n')}

## ğŸ¯ æ¸¸æˆå»ºè®®
${generateGameSuggestions()}

---
*æŠ¥å‘Šç”±å­£é£å†³ç­–è€…å¢å¼ºç‰ˆè‡ªåŠ¨ç”Ÿæˆ*
      `;
      
      const dataStr = "data:text/markdown;charset=utf-8," + encodeURIComponent(report);
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `å­£é£å†³ç­–è€…å¢å¼ºç‰ˆ-è¯¦ç»†æŠ¥å‘Š-${playerName}-${new Date().toLocaleDateString()}.md`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      closeExportModal();
      addLog("è¯¦ç»†æŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼", "success");
    }

    // è®¡ç®—æœ€ç»ˆå¾—åˆ†
    function calculateFinalScore() {
      let score = 0;
      
      // åŸºç¡€å¾—åˆ†
      score += Math.min(1000, gameState.totalIncome / 100);
      score += gameState.reputation * 2;
      score += gameState.farmerLevel * 50;
      score += gameState.achievements.length * 30;
      score += gameState.completedResearch.length * 40;
      score += gameState.year * 10;
      
      // ç‰¹æ®ŠåŠ åˆ†
      if (gameState.perfectYears >= 5) score += 200;
      if (gameState.consecutiveWeatherSuccess >= 10) score += 300;
      if (gameState.population >= 1000) score += 250;
      if (gameState.money >= 10000) score += 400;
      
      // éš¾åº¦åŠ æˆ
      score *= (1 + gameState.difficulty / 200);
      
      return Math.round(score);
    }

    // è®¡ç®—ç­‰çº§
    function calculateGrade() {
      const score = calculateFinalScore();
      
      if (score >= 8000) return "ä¼ å¥‡å¤§å¸ˆ S+";
      if (score >= 6000) return "å†œä¸šä¸“å®¶ S";
      if (score >= 4500) return "èµ„æ·±å†œæ°‘ A+";
      if (score >= 3500) return "ç†Ÿç»ƒå†œæ°‘ A";
      if (score >= 2500) return "è¿›é˜¶å†œæ°‘ B+";
      if (score >= 1800) return "æ™®é€šå†œæ°‘ B";
      if (score >= 1200) return "åˆçº§å†œæ°‘ C+";
      if (score >= 800) return "æ–°æ‰‹å†œæ°‘ C";
      return "å­¦å¾’å†œæ°‘ D";
    }

    // ç”Ÿæˆæ¸¸æˆå»ºè®®
    function generateGameSuggestions() {
      const suggestions = [];
      
      if (gameState.achievements.length < GAME_CONFIG.ACHIEVEMENTS.length * 0.5) {
        suggestions.push("å°è¯•è§£é”æ›´å¤šæˆå°±ï¼ŒåŒ…æ‹¬éšè—æˆå°±ï¼");
      }
      
      if (gameState.completedResearch.length < GAME_CONFIG.RESEARCH.length * 0.6) {
        suggestions.push("åŠ å¼ºç§‘æŠ€ç ”å‘ï¼Œæå‡å†œåœºæŠ€æœ¯æ°´å¹³ã€‚");
      }
      
      if (gameState.joinedCoops.length === 0) {
        suggestions.push("è€ƒè™‘åŠ å…¥åˆä½œç¤¾ï¼Œè·å¾—é›†ä½“ä¼˜åŠ¿ã€‚");
      }
      
      if (gameState.reputation < 150) {
        suggestions.push("æå‡å£°æœ›å¯ä»¥è·å¾—æ›´å¤šä¼˜æƒ å’Œæœºä¼šã€‚");
      }
      
      if (gameState.farmerLevel < 20) {
        suggestions.push("ç»§ç»­æå‡å†œæ°‘æŠ€èƒ½ç­‰çº§ï¼Œè§£é”æ›´å¤šèƒ½åŠ›ã€‚");
      }
      
      if (gameState.difficulty < 75) {
        suggestions.push("å°è¯•æ›´é«˜éš¾åº¦ï¼ŒæŒ‘æˆ˜è‡ªå·±çš„æé™ï¼");
      }
      
      return suggestions.length > 0 ? suggestions.join('\n') : "æ‚¨å·²ç»æ˜¯ä¸€ä½å‡ºè‰²çš„å†œæ°‘ï¼Œç»§ç»­ä¿æŒï¼";
    }

    // å¤‡ä»½æ¸¸æˆæ•°æ®
    function backupGameData() {
      const playerName = document.getElementById('player-name').value || 'åŒ¿åç©å®¶';
      
      const backupData = {
        version: "å¢å¼ºç‰ˆ",
        backupTime: new Date().toISOString(),
        playerName: playerName,
        gameState: { ...gameState }
      };
      
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `å­£é£å†³ç­–è€…å¢å¼ºç‰ˆ-å­˜æ¡£-${playerName}-${new Date().toLocaleDateString()}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
      
      closeExportModal();
      addLog("æ¸¸æˆå­˜æ¡£å¤‡ä»½æˆåŠŸï¼", "success");
    }

    // æ¢å¤æ¸¸æˆæ•°æ®
    function restoreGameData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (backupData.version && backupData.gameState) {
            // æ¢å¤æ¸¸æˆçŠ¶æ€
            Object.assign(gameState, backupData.gameState);
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            updateMarketPanel();
            updateEquipmentPanel();
            updateAchievementPanel();
            updateHistoryDisplay();
            
            // æ›´æ–°ä½œç‰©é€‰æ‹©æ˜¾ç¤º
            if (gameState.currentCrop) {
              document.getElementById('current-crop-display').textContent = gameState.currentCrop;
              document.querySelectorAll('.crop-button').forEach(btn => {
                btn.classList.remove('selected');
              });
              const selectedBtn = document.querySelector(`[data-crop="${gameState.currentCrop}"]`);
              if (selectedBtn) selectedBtn.classList.add('selected');
            }
            
            closeExportModal();
            addLog(`æ¸¸æˆå­˜æ¡£æ¢å¤æˆåŠŸï¼æ¬¢è¿å›æ¥ï¼Œ${backupData.playerName || 'å†œåœºä¸»'}ï¼`, "success");
          } else {
            addLog("å­˜æ¡£æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼", "error");
          }
        } catch (error) {
          addLog("å­˜æ¡£æ–‡ä»¶è¯»å–å¤±è´¥ï¼", "error");
          console.error("æ¢å¤å­˜æ¡£é”™è¯¯:", error);
        }
      };
      reader.readAsText(file);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', function() {
      initializePrices();
      updateDisplay();
      updateMarketPanel();
      updateEquipmentPanel();
      updateAchievementPanel();
      updateSeasonEffect();
    });
  </script>
</body>

</html>