<!DOCTYPE html>
<html>

<head>
  <title>å­£é£å†³ç­–è€…2.1.1</title>
  <!-- å¼•å…¥ Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <!-- æ·»åŠ ç½‘ç«™å›¾æ ‡ -->
  <link rel="icon" href="f.ico" type="image/x-icon">
  <style>
    :root {
      --flood-color: #006994;
      --drought-color: #8B4513;
      --primary-bg: #f7faff;
      --secondary-bg: #fff;
      --accent-color: #FF5722;
      --policy-bg: #fff9e6;
      --policy-border: #ffd700;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--primary-bg);
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      color: #333;
    }

    .grid-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    #map {
      height: 250px;
      background: linear-gradient(160deg, #4d7c3f 0%, #87CEEB 100%);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }

    .satellite-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      background-size: 40px 40px;
      opacity: 0.7;
    }

    .policy-card {
      background: var(--policy-bg);
      padding: 15px;
      margin: 10px 0;
      border-left: 5px solid var(--policy-border);
      box-shadow: var(--box-shadow);
      border-radius: 5px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: var(--box-shadow);
    }

    .history-table th {
      background: var(--accent-color);
      color: white;
      padding: 10px;
    }

    .history-table td {
      padding: 10px;
      border: 1px solid #ddd;
    }

    @keyframes flood-pulse {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 40px 40px;
      }
    }

    @keyframes drought-pulse {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 40px -40px;
      }
    }

    .flood-effect {
      background-image: linear-gradient(45deg,
          var(--flood-color) 25%,
          transparent 25%,
          transparent 50%,
          var(--flood-color) 50%,
          var(--flood-color) 75%,
          transparent 75%);
      animation: flood-pulse 2s linear infinite;
    }

    .drought-effect {
      background-image: linear-gradient(45deg,
          var(--drought-color) 25%,
          transparent 25%,
          transparent 50%,
          var(--drought-color) 50%,
          var(--drought-color) 75%,
          transparent 75%);
      animation: drought-pulse 2s linear infinite;
    }

    button {
      background: var(--accent-color);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: var(--box-shadow);
      font-size: 1em;
    }

    button:hover {
      background: #e64a19;
      transform: translateY(-2px);
    }

    /* æŒ‰é’®ä¸è¯´æ˜å®¹å™¨ */
    .button-with-desc {
      display: inline-block;
      text-align: center;
      margin: 10px;
    }

    .button-with-desc small {
      display: block;
      font-size: 0.8em;
      color: #555;
      margin-top: 4px;
    }

    #log {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background: var(--secondary-bg);
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    /* åé¦ˆä¿¡æ¯é¢æ¿ */
    #feedback-panel {
      background: #eef;
      padding: 10px;
      border: 1px solid #99c;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 0.9em;
      display: none;
    }

    /* æˆå°±é¢æ¿ */
    #achievement-panel {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #achievement-panel h4 {
      margin: 5px 0;
      color: var(--accent-color);
    }

    /* å¸®åŠ©ä¿¡æ¯ï¼šæ”¹ä¸ºå‡ºç”Ÿåœ°ä»‹ç»å’Œæ¸¸ç©è§„åˆ™ */
    #help-info {
      background: var(--secondary-bg);
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #help-info h3 {
      margin-top: 0;
    }

    #help-info p {
      font-size: 0.9em;
      line-height: 1.4;
    }

    /* æ¸¸æˆç»“æŸå¼¹çª—æ ·å¼ */
    #game-over-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #modal-content {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    #modal-content.success {
      border: 2px solid green;
    }

    #modal-content.failure {
      border: 2px solid red;
    }

    /* æ–°å¢æ¨¡å¼é€‰æ‹©å¼¹çª—æ ·å¼ */
    #mode-selection-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #mode-selection-content {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    #mode-selection-content h2 {
      margin-bottom: 10px;
    }

    #mode-selection-content p {
      font-size: 1em;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* äººå£æœºåˆ¶ç›¸å…³æ ·å¼ */
    #population-panel {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    /* ä½œç‰©é€‰æ‹©ç›¸å…³æ ·å¼ */
    #crop-selection {
      margin-top: 20px;
    }

    #crop-selection h3 {
      margin-bottom: 10px;
    }

    .crop-type {
      margin-bottom: 15px;
    }

    .crop-type h4 {
      margin-bottom: 5px;
    }

    /* å‡ºç”Ÿåœ°é€‰æ‹©ç›¸å…³æ ·å¼ */
    #birthplace-selection {
      margin-top: 20px;
    }

    #birthplace-selection h3 {
      margin-bottom: 10px;
    }

    .birthplace-option {
      margin-bottom: 10px;
    }

    /* ä»“åº“ç›¸å…³æ ·å¼ */
    #warehouse {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    /* æ–°å¢å¯¼å‡ºæˆ˜ç»©å¼¹çª—æ ·å¼ */
    #export-score-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #export-score-content {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    #export-score-content h2 {
      margin-bottom: 10px;
    }

    #export-score-content p {
      font-size: 1em;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* ä»“åº“ä½œç‰©é€‰æ‹©æ ·å¼ */
    .crop-selection {
      margin: 10px 0;
    }

    .crop-selection h4 {
      margin-bottom: 5px;
    }

    .crop-selection input {
      width: 50px;
      text-align: right;
    }

    /* å…¬å‘Šæ æ ·å¼ */
    #announcement-bar {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #announcement-bar h4 {
      margin-top: 0;
    }

    #announcement-bar p {
      font-size: 0.9em;
      line-height: 1.4;
    }

    /* æ–°å¢ç¾å®³é¢„æµ‹åŒºå—æ ·å¼ */
    #disaster-prediction {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #disaster-prediction h3 {
      margin-top: 0;
    }

    /* æ–°å¢å›¾è¡¨æ ·å¼ */
    .chart-container {
      height: 100px;
      background: #f5f5f5;
      margin: 10px 0;
      border-radius: 5px;
      position: relative;
    }

    .chart-line {
      position: absolute;
      height: 2px;
      background: var(--accent-color);
      bottom: 0;
    }
  </style>
</head>

<body>
  <!-- æ¨¡å¼é€‰æ‹©å¼¹çª— -->
  <div id="mode-selection-modal">
    <div id="mode-selection-content">
      <h2>é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
      <div>
        <label>
          <input type="radio" name="game-mode" value="challenge" checked> æŒ‘æˆ˜æ¨¡å¼
        </label>
        <label>
          <input type="radio" name="game-mode" value="endless"> æ— å°½æ¨¡å¼
        </label>
      </div>
      <div id="challenge-settings" style="margin-top: 10px; display: none;">
        <label for="challenge-years">æŒ‘æˆ˜å¹´é™:</label>
        <input type="number" id="challenge-years" min="5" max="20" value="10">
      </div>
      <div style="margin-top: 20px;">
        <label>é€‰æ‹©éš¾åº¦:</label>
        <select id="difficulty">
          <option value="20">ç®€å• (20%)</option>
          <option value="40">æ™®é€š (40%)</option>
          <option value="70">å›°éš¾ (70%)</option>
          <option value="100">åœ°ç‹± (100%)</option>
        </select>
      </div>
      <button onclick="startSettings()">ä¸‹ä¸€æ­¥</button>
    </div>
  </div>

  <!-- è®¾ç½®å¼¹çª— -->
  <div id="settings-modal">
    <div id="settings-content">
      <h2>æ¸¸æˆè®¾ç½®</h2>
      <div id="birthplace-selection">
        <h3>ğŸŒ é€‰æ‹©å‡ºç”Ÿåœ°</h3>
        <div class="birthplace-option">
          <h4>ä¸­å›½</h4>
          <p>æ‹¥æœ‰å¤šç§æ°”å€™ç±»å‹ï¼Œå†œä¸šç»éªŒä¸°å¯Œï¼Œç¾å®³åº”å¯¹èƒ½åŠ›å¼ºã€‚</p>
          <label>
            <input type="radio" name="birthplace" value="china-north"> ååŒ—å¹³åŸ
          </label>
          <label>
            <input type="radio" name="birthplace" value="china-south"> é•¿æ±Ÿä¸­ä¸‹æ¸¸
          </label>
          <label>
            <input type="radio" name="birthplace" value="china-west"> è¥¿åŒ—åœ°åŒº
          </label>
        </div>
        <div class="birthplace-option">
          <h4>ä¿„ç½—æ–¯</h4>
          <p>æ°”å€™å¯’å†·ï¼Œå†œä¸šé›†ä¸­åœ¨å—éƒ¨åœ°åŒºï¼Œå¯¹æç«¯ä½æ¸©æœ‰è¾ƒå¼ºé€‚åº”èƒ½åŠ›ã€‚</p>
          <label>
            <input type="radio" name="birthplace" value="russia-south"> å—éƒ¨å¹³åŸ
          </label>
          <label>
            <input type="radio" name="birthplace" value="russia-west"> è¥¿ä¼¯åˆ©äºš
          </label>
          <label>
            <input type="radio" name="birthplace" value="russia-east"> è¿œä¸œåœ°åŒº
          </label>
        </div>
        <div class="birthplace-option">
          <h4>ä¸œå—äºš</h4>
          <p>çƒ­å¸¦æ°”å€™ä¸ºä¸»ï¼Œå­£é£å½±å“æ˜æ˜¾ï¼Œé€‚åˆç§æ¤çƒ­å¸¦ä½œç‰©ã€‚</p>
          <label>
            <input type="radio" name="birthplace" value="sea-thailand"> æ³°å›½ä¸­éƒ¨
          </label>
          <label>
            <input type="radio" name="birthplace" value="sea-vietnam"> è¶Šå—åŒ—éƒ¨
          </label>
          <label>
            <input type="radio" name="birthplace" value="sea-indonesia"> å°åº¦å°¼è¥¿äºšç¾¤å²›
          </label>
        </div>
        <div class="birthplace-option">
          <h4>å°åº¦</h4>
          <p>å­£é£æ°”å€™æ˜¾è‘—ï¼Œå†œä¸šä¾èµ–å­£é£é™é›¨ï¼Œå¯¹å­£é£å˜åŒ–æ•æ„Ÿã€‚</p>
          <label>
            <input type="radio" name="birthplace" value="india-north"> åŒ—éƒ¨å¹³åŸ
          </label>
          <label>
            <input type="radio" name="birthplace" value="india-south"> å—éƒ¨é«˜åŸ
          </label>
          <label>
            <input type="radio" name="birthplace" value="india-east"> ä¸œéƒ¨æ²¿æµ·
          </label>
        </div>
      </div>
      <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>
  </div>

  <!-- æ•™ç¨‹å¼¹çª— -->
  <div id="tutorial-overlay">
    <div id="tutorial-content">
      <h2>å­£é£å†³ç­–è€… - æ¸¸æˆè§„åˆ™</h2>
      <p>æ¬¢è¿æ¥åˆ°å­£é£å†³ç­–è€…ï¼åœ¨è¿™ä¸ªæ¸¸æˆä¸­ï¼Œä½ å°†æ‰®æ¼”ä¸€ä½å†œä¸šå†³ç­–è€…ï¼Œç®¡ç†å†œç”°ã€é€‰æ‹©ä½œç‰©ã€åº”å¯¹ç¾å®³ï¼ŒåŠªåŠ›å®ç°å†œä¸šçš„å¯æŒç»­å‘å±•ã€‚</p>
      <p>æ¸¸æˆç›®æ ‡ï¼šé€šè¿‡åˆç†é€‰æ‹©ä½œç‰©ã€è´­ä¹°è®¾å¤‡ã€åº”å¯¹ç¾å®³ï¼Œä½¿ä½ çš„å†œåœºåœ¨å„ç§æ°”å€™æ¡ä»¶ä¸‹ç¨³å®šå‘å±•ï¼Œå®ç°èµ„é‡‘å’Œäººå£çš„æŒç»­å¢é•¿ã€‚</p>
      <p>ä¸»è¦ç©æ³•ï¼š</p>
      <ul>
        <li>é€‰æ‹©åˆé€‚çš„ä½œç‰©ç§æ¤ï¼Œä¸åŒä½œç‰©é€‚åº”ä¸åŒçš„æ°”å€™æ¡ä»¶</li>
        <li>è´­ä¹°å†œä¸šè®¾å¤‡æ¥é™ä½ç¾å®³é£é™©ï¼Œæé«˜äº§é‡</li>
        <li>æ¸¸æˆä¸­ä¼šéšæœºè§¦å‘æ”¿ç­–å˜åŒ–å’Œè‡ªç„¶ç¾å®³ï¼Œè€ƒéªŒä½ çš„åº”å¯¹èƒ½åŠ›</li>
        <li>ç®¡ç†äººå£å¢é•¿å’Œç²®é£Ÿæ¶ˆè€—ï¼Œç¡®ä¿ç¤¾ä¼šç¨³å®š</li>
        <li>é€šè¿‡ä»“åº“ç®¡ç†ï¼Œåˆç†å‡ºå”®ä½œç‰©è·å–èµ„é‡‘</li>
      </ul>
      <p>ç¥ä½ å¥½è¿ï¼</p>
      <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>
  </div>

  <div class="grid-container">
    <!-- ä¸»æ¸¸æˆåŒº -->
    <div>
      <h1>ğŸŒ¦ï¸ å­£é£å†³ç­–è€… -  ğŸšœ</h1>
      <div id="map"></div>
      <div id="controls">
        <h3>ğŸ’° èµ„é‡‘: â‚¹<span id="money">800</span></h3>
        <div id="current-policy" class="policy-card"></div>
        <h3>ğŸŒ± é€‰æ‹©ä½œç‰©:</h3>
        <div id="crop-buttons">
          <div class="button-with-desc">
            <button onclick="chooseCrop('æ°´ç¨»')">ğŸŒ¾ æ°´ç¨»</button>
            <small>é€‚åº”æ´ªæ°´ç¯å¢ƒï¼Œæ°´åˆ†å……è¶³</small>
          </div>
          <div class="button-with-desc">
            <button onclick="chooseCrop('å°éº¦')">ğŸŒ¾ å°éº¦</button>
            <small>é€‚åº”æ­£å¸¸æ°”å€™ï¼Œå‡è¡¡å‘å±•</small>
          </div>
          <div class="button-with-desc">
            <button onclick="chooseCrop('é«˜ç²±')">ğŸŒ¾ é«˜ç²±</button>
            <small>è€æ—±ï¼Œé€‚åˆå»¶è¿Ÿå¹²æ—±ç¯å¢ƒ</small>
          </div>
          <div class="button-with-desc">
            <button onclick="chooseCrop('ç‰ç±³')">ğŸŒ¾ ç‰ç±³</button>
            <small>é€‚åˆæ­£å¸¸ç¯å¢ƒï¼Œäº§é‡è¾ƒé«˜</small>
          </div>
          <!-- æ–°å¢ç»æµä½œç‰© -->
          <div class="crop-type">
            <h4>ç»æµä½œç‰©</h4>
            <div class="button-with-desc">
              <button onclick="chooseCrop('æ£‰èŠ±')">ğŸŒ¿ æ£‰èŠ±</button>
              <small>é€‚åº”æ­£å¸¸æ°”å€™ï¼Œç»æµä»·å€¼é«˜</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('ç”˜è”—')">ğŸŒ¿ ç”˜è”—</button>
              <small>é€‚åº”é«˜æ¸©å¤šæ¹¿ç¯å¢ƒ</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('èŒ¶å¶')">ğŸŒ¿ èŒ¶å¶</button>
              <small>é€‚åº”å±±åœ°æ°”å€™ï¼Œéœ€è¦æ’æ°´è‰¯å¥½</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('å’–å•¡')">ğŸŒ¿ å’–å•¡</button>
              <small>é€‚åº”çƒ­å¸¦æ°”å€™ï¼Œéœ€è¦å……è¶³é˜³å…‰</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('æ©¡èƒ¶')">ğŸŒ¿ æ©¡èƒ¶</button>
              <small>é€‚åº”é«˜æ¸©å¤šé›¨ç¯å¢ƒ</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('å¯å¯')">ğŸŒ¿ å¯å¯</button>
              <small>é€‚åº”çƒ­å¸¦é›¨æ—æ°”å€™</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('èŠ±ç”Ÿ')">ğŸŒ¿ èŠ±ç”Ÿ</button>
              <small>é€‚åº”å¤šç§æ°”å€™ï¼Œè€è´«ç˜ åœŸå£¤</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('å¤§è±†')">ğŸŒ¿ å¤§è±†</button>
              <small>å¯Œå«è›‹ç™½è´¨ï¼Œé€‚åº”å¹¿æ³›ç¯å¢ƒ</small>
            </div>
          </div>
        </div>
        <h3>ğŸ› ï¸ å†œä¸šè®¾å¤‡:</h3>
        <div id="equipment-buttons">
          <div class="button-with-desc">
            <button onclick="buyItem('çŒæº‰è®¾å¤‡', 300)">ğŸ’§ çŒæº‰è®¾å¤‡ (â‚¹300)</button>
            <small>ç¼“è§£å»¶è¿Ÿå¹²æ—±ï¼Œæé«˜ä½œç‰©äº§é‡</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('é˜²æ´ªè®¾æ–½', 500)">ğŸ›¡ï¸ é˜²æ´ªè®¾æ–½ (â‚¹500)</button>
            <small>é™ä½æ´ªæ°´å¯¹ä½œç‰©çš„ç ´å</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('æ°”è±¡ç›‘æµ‹ä»ª', 400)">ğŸ“¡ æ°”è±¡ç›‘æµ‹ä»ª (â‚¹400)</button>
            <small>æå‰é¢„æµ‹æç«¯å¤©æ°”ï¼Œè°ƒæ•´ç­–ç•¥</small>
          </div>
          <!-- æ–°å¢ç¾å®³åº”å¯¹æªæ–½ -->
          <div class="button-with-desc">
            <button onclick="buyItem('å¹²æ—±é¢„è­¦ç³»ç»Ÿ', 450)">âš ï¸ å¹²æ—±é¢„è­¦ç³»ç»Ÿ (â‚¹450)</button>
            <small>æå‰é¢„è­¦å¹²æ—±ï¼Œå‡å°‘æŸå¤±</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('æ´ªæ°´é¢„è­¦ç³»ç»Ÿ', 450)">âš ï¸ æ´ªæ°´é¢„è­¦ç³»ç»Ÿ (â‚¹450)</button>
            <small>æå‰é¢„è­¦æ´ªæ°´ï¼Œå‡å°‘æŸå¤±</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('ç—…è™«å®³é˜²æ²»', 350)">ğŸ› ç—…è™«å®³é˜²æ²» (â‚¹350)</button>
            <small>é¢„é˜²ç—…è™«å®³ï¼Œä¿æŠ¤ä½œç‰©</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('åœŸå£¤æ”¹è‰¯å‰‚', 300)">ğŸŒ± åœŸå£¤æ”¹è‰¯å‰‚ (â‚¹300)</button>
            <small>æ”¹å–„åœŸå£¤è´¨é‡ï¼Œæé«˜äº§é‡</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('æ¸©å®¤å¤§æ£š', 600)">ğŸ  æ¸©å®¤å¤§æ£š (â‚¹600)</button>
            <small>è°ƒèŠ‚æ¸©åº¦å’Œæ¹¿åº¦ï¼Œé€‚åº”å¤šç§æ°”å€™</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('ç²®é£Ÿå‚¨å¤‡åº“', 500)">ğŸ“¦ ç²®é£Ÿå‚¨å¤‡åº“ (â‚¹500)</button>
            <small>å‚¨å­˜ç²®é£Ÿï¼Œåº”å¯¹æ­‰æ”¶å¹´ä»½</small>
          </div>
        </div>
        <button onclick="startNewYear()" style="margin:20px 0">â© è¿›å…¥ä¸‹ä¸€å¹´</button>
        <!-- åé¦ˆé¢æ¿ï¼šæ¯å›åˆç»“æŸåæ˜¾ç¤ºåé¦ˆä¿¡æ¯ -->
        <div id="feedback-panel"></div>
      </div>
      <div id="log"></div>
    </div>
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div>
      <!-- å…¬å‘Šæ ç§»åŠ¨åˆ°é¡¶éƒ¨ -->
      <div id="announcement-bar">
        <h4>ğŸ“¢ å…¬å‘Šæ </h4>
        <p id="announcement-content">æ¬¢è¿æ¥åˆ°å­£é£å†³ç­–è€…ï¼æœ¬ç‰ˆæœ¬ä¸º2.1.1ï¼Œæš‚æ—¶è§£å†³äº†BUGï¼Œä¹‹åä¼šç»§ç»­æ›´æ–°ä»¥ä¿®å¤æ‰€æœ‰BUGï¼Œä½œè€…é‚®ç®±ï¼š383492384@qq.com</p>
      </div>
      <h3>ğŸ“œ å½“å‰æ”¿ç­–</h3>
      <div id="policy-effect"></div>
      <h3>ğŸ“Š å†å²æ•°æ®</h3>
      <table class="history-table">
        <thead>
          <tr>
            <th>å¹´ä»½</th>
            <th>å­£é£/ç¾å®³</th>
            <th>æ”¶å…¥</th>
            <th>æ”¿ç­–</th>
          </tr>
        </thead>
        <tbody id="history-body"></tbody>
      </table>
      <h3>ğŸŒ æ°”å€™å˜åŒ–æŒ‡æ•°</h3>
      <div id="climate-meter">æç«¯å¤©æ°”æ¦‚ç‡: 25%</div>
      <h3>ğŸ† æˆå°±ç³»ç»Ÿ</h3>
      <div id="achievement-panel">
        <p>æš‚æ— æˆå°±</p>
      </div>
      <!-- å¸®åŠ©ä¿¡æ¯ï¼šæ”¹ä¸ºå‡ºç”Ÿåœ°ä»‹ç»å’Œæ¸¸ç©è§„åˆ™ -->
      <div id="help-info">
        <h3>å¸®åŠ©ä¿¡æ¯</h3>
        <div id="birthplace-intro">
          <h4>å½“å‰å‡ºç”Ÿåœ°ä»‹ç»</h4>
          <p id="birthplace-description">è¿™é‡Œå°†æ˜¾ç¤ºå½“å‰å‡ºç”Ÿåœ°çš„è¯¦ç»†ä»‹ç»ã€‚</p>
        </div>
        <div id="game-rules">
          <h4>æ¸¸ç©è§„åˆ™</h4>
          <p>1. æ¯å¹´é€‰æ‹©åˆé€‚çš„ä½œç‰©ç§æ¤ï¼Œä¸åŒä½œç‰©é€‚åº”ä¸åŒçš„æ°”å€™æ¡ä»¶ã€‚</p>
          <p>2. å¯ä»¥è´­ä¹°å†œä¸šè®¾å¤‡æ¥é™ä½ç¾å®³é£é™©ï¼Œæé«˜äº§é‡ã€‚</p>
          <p>3. æ¸¸æˆä¸­ä¼šéšæœºè§¦å‘æ”¿ç­–å˜åŒ–å’Œè‡ªç„¶ç¾å®³ï¼Œè€ƒéªŒä½ çš„åº”å¯¹èƒ½åŠ›ã€‚</p>
          <p>4. ç®¡ç†å¥½äººå£å¢é•¿å’Œç²®é£Ÿæ¶ˆè€—ï¼Œç¡®ä¿ç¤¾ä¼šç¨³å®šå‘å±•ã€‚</p>
          <p>5. é€šè¿‡åˆç†è§„åˆ’ï¼Œä½¿å†œåœºåœ¨å„ç§æ°”å€™æ¡ä»¶ä¸‹ç¨³å®šå‘å±•ï¼Œå®ç°èµ„é‡‘å’Œäººå£çš„æŒç»­å¢é•¿ã€‚</p>
        </div>
      </div>
      <!-- æ–°å¢äººå£æœºåˆ¶ -->
      <div id="population-panel">
        <h3>ğŸ‘¥ äººå£æœºåˆ¶</h3>
        <p>åˆå§‹äººå£: <span id="initial-population">150~250äºº</span></p>
        <p>å½“å‰äººå£: <span id="current-population">150äºº</span></p>
        <p>æ¯å¹´å¹³å‡å¢åŠ 7%ï¼Œç²®é£Ÿä¸è¶³æ—¶äººå£ä¼šå‡å°‘ã€‚</p>
        <div>
          <button onclick="increasePopulation()">â• å¢åŠ 10%äººå£ (â‚¹1500)</button>
          <button onclick="decreasePopulation()">â– å‡å°‘10%äººå£ (â‚¹50)</button>
        </div>
      </div>
      <!-- æ–°å¢ä»“åº“æœºåˆ¶ -->
      <div id="warehouse">
        <h3>ğŸ“¦ ä»“åº“</h3>
        <p>åˆå§‹ä½œç‰©: å°éº¦ 200å•ä½</p>
        <div class="crop-selection">
          <h4>ç²®é£Ÿä½œç‰©</h4>
          <label>å°éº¦:</label>
          <span id="wheat-crops">200</span>
          <input type="range" id="sell-wheat-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('wheat')">å‡ºå”®</button>
          <span id="wheat-price">å½“å‰ä»·æ ¼: â‚¹2.0/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>æ°´ç¨»:</label>
          <span id="rice-crops">0</span>
          <input type="range" id="sell-rice-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('rice')">å‡ºå”®</button>
          <span id="rice-price">å½“å‰ä»·æ ¼: â‚¹2.5/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>é«˜ç²±:</label>
          <span id="sorghum-crops">0</span>
          <input type="range" id="sell-sorghum-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('sorghum')">å‡ºå”®</button>
          <span id="sorghum-price">å½“å‰ä»·æ ¼: â‚¹1.8/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>ç‰ç±³:</label>
          <span id="corn-crops">0</span>
          <input type="range" id="sell-corn-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('corn')">å‡ºå”®</button>
          <span id="corn-price">å½“å‰ä»·æ ¼: â‚¹2.2/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <h4>ç»æµä½œç‰©</h4>
          <label>æ£‰èŠ±:</label>
          <span id="cotton-crops">0</span>
          <input type="range" id="sell-cotton-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('cotton')">å‡ºå”®</button>
          <span id="cotton-price">å½“å‰ä»·æ ¼: â‚¹3.0/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>ç”˜è”—:</label>
          <span id="sugarcane-crops">0</span>
          <input type="range" id="sell-sugarcane-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('sugarcane')">å‡ºå”®</button>
          <span id="sugarcane-price">å½“å‰ä»·æ ¼: â‚¹2.8/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>èŒ¶å¶:</label>
          <span id="tea-crops">0</span>
          <input type="range" id="sell-tea-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('tea')">å‡ºå”®</button>
          <span id="tea-price">å½“å‰ä»·æ ¼: â‚¹3.5/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>å’–å•¡:</label>
          <span id="coffee-crops">0</span>
          <input type="range" id="sell-coffee-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('coffee')">å‡ºå”®</button>
          <span id="coffee-price">å½“å‰ä»·æ ¼: â‚¹4.0/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>æ©¡èƒ¶:</label>
          <span id="rubber-crops">0</span>
          <input type="range" id="sell-rubber-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('rubber')">å‡ºå”®</button>
          <span id="rubber-price">å½“å‰ä»·æ ¼: â‚¹3.2/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>å¯å¯:</label>
          <span id="cocoa-crops">0</span>
          <input type="range" id="sell-cocoa-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('cocoa')">å‡ºå”®</button>
          <span id="cocoa-price">å½“å‰ä»·æ ¼: â‚¹3.8/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>èŠ±ç”Ÿ:</label>
          <span id="peanut-crops">0</span>
          <input type="range" id="sell-peanut-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('peanut')">å‡ºå”®</button>
          <span id="peanut-price">å½“å‰ä»·æ ¼: â‚¹2.3/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>å¤§è±†:</label>
          <span id="soybean-crops">0</span>
          <input type="range" id="sell-soybean-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('soybean')">å‡ºå”®</button>
          <span id="soybean-price">å½“å‰ä»·æ ¼: â‚¹2.6/å•ä½</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
      </div>
      <!-- æ–°å¢ç¾å®³é¢„æµ‹åŒºå— -->
      <div id="disaster-prediction">
        <h3>âš ï¸ ç¾å®³é¢„æµ‹</h3>
        <p>ä½¿ç”¨æ°”è±¡ç›‘æµ‹ä»ªå¯é¢„æµ‹ä¸‹ä¸€å¹´çš„ç¾å®³ï¼Œæ¶ˆè€—300èµ„é‡‘</p>
        <button onclick="predictDisaster()">è¿›è¡Œé¢„æµ‹</button>
        <div id="prediction-result"></div>
      </div>
    </div>
  </div>
  <div id="game-over-modal">
    <div id="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-message"></p>
      <button onclick="restartGame()">é‡æ–°å¼€å§‹</button>
      <button onclick="showExportScoreModal()">å¯¼å‡ºæˆ˜ç»©</button>
    </div>
  </div>
  <!-- æ–°å¢å¯¼å‡ºæˆ˜ç»©å¼¹çª— -->
  <div id="export-score-modal">
    <div id="export-score-content">
      <h2>å¯¼å‡ºæˆ˜ç»©</h2>
      <p>è¯·è¾“å…¥ä½ çš„å§“å:</p>
      <input type="text" id="player-name" placeholder="è¯·è¾“å…¥å§“å">
      <button onclick="exportScore()">å¯¼å‡º</button>
    </div>
  </div>
  <script>
    // æ•™ç¨‹æ­¥éª¤åŠå½“å‰æ­¥éª¤ç´¢å¼•
    const tutorialSteps = [
      "æ¬¢è¿æ¥åˆ°å­£é£å†³ç­–è€…ï¼æœ¬æ¸¸æˆå°†å¸¦ä½ äº†è§£å°åº¦å­£é£å†œä¸šçš„åŸºæœ¬çŸ¥è¯†ã€‚",
      "é¦–å…ˆï¼Œä½ éœ€è¦é€‰æ‹©åˆé€‚çš„ä½œç‰©ã€‚æ¯ç§ä½œç‰©éƒ½æœ‰å…¶æœ€ä½³ç”Ÿé•¿ç¯å¢ƒï¼Œä¾‹å¦‚æ°´ç¨»é€‚åˆæ´ªæ°´ç¯å¢ƒã€‚",
      "æ¥ä¸‹æ¥ï¼Œè´­ä¹°å†œä¸šè®¾å¤‡èƒ½æœ‰æ•ˆé™ä½ç¾å®³é£é™©ï¼Œä¾‹å¦‚é˜²æ´ªè®¾æ–½å¯ä»¥å‡å°‘æ´ªæ°´æŸå¤±ã€‚",
      "æ¸¸æˆä¸­ä¼šéšæœºè§¦å‘æ”¿ç­–å’Œç¾å®³ï¼Œè¿™å°†è€ƒéªŒä½ çš„é£é™©æ§åˆ¶ä¸å†³ç­–èƒ½åŠ›ã€‚",
      "æœ€åï¼Œç³»ç»Ÿä¼šè®°å½•ç»è¥æ•°æ®å’Œæˆå°±ï¼Œå®æ—¶åé¦ˆå¸®åŠ©ä½ æ€»ç»“ç»éªŒã€‚ç¥ä½ å¥½è¿ï¼"
    ];
    let currentTutorialStep = 0;

    // ä½œç‰©æ•°æ®ï¼ˆå››ç§ä½œç‰©ï¼‰
    const CROPS = {
      "æ°´ç¨»": { ideal: "æ´ªæ°´", modifiers: { "æ´ªæ°´": 0.8, "å»¶è¿Ÿå¹²æ—±": 0.9, "æ­£å¸¸": 1.0 } },
      "å°éº¦": { ideal: "æ­£å¸¸", modifiers: { "æ´ªæ°´": 0.5, "å»¶è¿Ÿå¹²æ—±": 0.2, "æ­£å¸¸": 1.0 } },
      "é«˜ç²±": { ideal: "å»¶è¿Ÿå¹²æ—±", modifiers: { "æ´ªæ°´": 0.5, "å»¶è¿Ÿå¹²æ—±": 0.6, "æ­£å¸¸": 1.0 } },
      "ç‰ç±³": { ideal: "æ­£å¸¸", modifiers: { "æ´ªæ°´": 0.7, "å»¶è¿Ÿå¹²æ—±": 0.8, "æ­£å¸¸": 1.1 } },
      "æ£‰èŠ±": { ideal: "æ­£å¸¸", modifiers: { "æ´ªæ°´": 0.3, "å»¶è¿Ÿå¹²æ—±": 0.6, "æ­£å¸¸": 1.2 } },
      "ç”˜è”—": { ideal: "é«˜æ¸©å¤šæ¹¿", modifiers: { "æ´ªæ°´": 0.7, "å»¶è¿Ÿå¹²æ—±": 0.4, "æ­£å¸¸": 1.1 } },
      "èŒ¶å¶": { ideal: "å±±åœ°æ°”å€™", modifiers: { "æ´ªæ°´": 0.5, "å»¶è¿Ÿå¹²æ—±": 0.3, "æ­£å¸¸": 1.0 } },
      "å’–å•¡": { ideal: "çƒ­å¸¦æ°”å€™", modifiers: { "æ´ªæ°´": 0.6, "å»¶è¿Ÿå¹²æ—±": 0.5, "æ­£å¸¸": 1.1 } },
      "æ©¡èƒ¶": { ideal: "é«˜æ¸©å¤šé›¨", modifiers: { "æ´ªæ°´": 0.8, "å»¶è¿Ÿå¹²æ—±": 0.2, "æ­£å¸¸": 1.0 } },
      "å¯å¯": { ideal: "çƒ­å¸¦é›¨æ—", modifiers: { "æ´ªæ°´": 0.7, "å»¶è¿Ÿå¹²æ—±": 0.3, "æ­£å¸¸": 1.2 } },
      "èŠ±ç”Ÿ": { ideal: "å¤šç§æ°”å€™", modifiers: { "æ´ªæ°´": 0.6, "å»¶è¿Ÿå¹²æ—±": 0.7, "æ­£å¸¸": 1.0 } },
      "å¤§è±†": { ideal: "å¹¿æ³›ç¯å¢ƒ", modifiers: { "æ´ªæ°´": 0.7, "å»¶è¿Ÿå¹²æ—±": 0.6, "æ­£å¸¸": 1.1 } }
    };

    // æ”¿ç­–åˆ—è¡¨
    const POLICIES = [
      {
        name: "å‡ºå£ç¦ä»¤",
        effect: () => gameState.incomeMultiplier *= 0.5,
        description: "å›½é™…å¸‚åœºä»·æ ¼ä¸‹é™50%"
      },
      {
        name: "ç§æ¤è¡¥è´´",
        effect: () => gameState.equipmentCost = 0.8,
        description: "è®¾å¤‡ä»·æ ¼é™ä½20%"
      },
      {
        name: "ç´§æ€¥èµˆç¾",
        effect: () => gameState.money += 200,
        description: "æ”¿åºœè¡¥åŠ©â‚¹200"
      },
      {
        name: "æŠ€æœ¯æ¨å¹¿",
        effect: () => gameState.incomeMultiplier *= 1.2,
        description: "ä½œç‰©äº§é‡æé«˜20%"
      },
      {
        name: "ç¨æ”¶æ”¿ç­–",
        effect: () => gameState.incomeMultiplier *= 0.9,
        description: "éƒ¨åˆ†ä½œç‰©é”€å”®å¾æ”¶10%ç¨æ”¶"
      },
      {
        name: "ç¯ä¿æ”¿ç­–",
        effect: () => gameState.equipmentCost *= 0.9,
        description: "ç¯ä¿æªæ–½ä½¿è®¾å¤‡ä»·æ ¼é™ä½10%"
      }
    ];

    // ç¾å®³/å­£é£æƒ…å½¢
    const monsoonScenarios = [
      { type: "æ­£å¸¸", yieldFactor: 1 },
      { type: "å»¶è¿Ÿå¹²æ—±", yieldFactor: 0.3 },
      { type: "æ´ªæ°´", yieldFactor: 0.5 },
      { type: "ç—…è™«å®³", yieldFactor: 0.4 },
      { type: "éœœå†»", yieldFactor: 0.6 },
      { type: "å°é£", yieldFactor: 0.3 },
      { type: "æ²™å°˜æš´", yieldFactor: 0.5 },
      { type: "æ—±ç¾", yieldFactor: 0.2 },
      { type: "é›¹ç¾", yieldFactor: 0.4 },
      { type: "åœŸå£¤é€€åŒ–", yieldFactor: 0.7 },
      { type: "æ°´èµ„æºçŸ­ç¼º", yieldFactor: 0.6 },
      { type: "æç«¯é«˜æ¸©", yieldFactor: 0.5 }
    ];

    let gameState = {
      money: 800,
      currentCrop: null,
      equipment: [],
      policies: [],
      allPolicies: [],
      history: [],
      climateRisk: 25,
      year: 2023,
      incomeMultiplier: 1,
      equipmentCost: 1,
      consecutiveDisasters: 0,
      consecutiveSafeYears: 0,
      achievements: [],
      optimalCropMatches: 0,
      weatherSuccess: 0,
      gameMode: null,
      challengeYears: null,
      difficulty: null,
      disasterLevel: null,
      population: 150,
      initialPopulation: null,
      birthplace: null,
      crops: {
        wheat: 200,
        rice: 0,
        sorghum: 0,
        corn: 0,
        cotton: 0,
        sugarcane: 0,
        tea: 0,
        coffee: 0,
        rubber: 0,
        cocoa: 0,
        peanut: 0,
        soybean: 0
      },
      cropPrices: {
        wheat: 2.0,
        rice: 2.5,
        sorghum: 1.8,
        corn: 2.2,
        cotton: 3.0,
        sugarcane: 2.8,
        tea: 3.5,
        coffee: 4.0,
        rubber: 3.2,
        cocoa: 3.8,
        peanut: 2.3,
        soybean: 2.6
      },
      priceHistory: {
        wheat: [2.0, 2.2, 1.8, 2.5, 1.9],
        rice: [2.5, 2.8, 2.3, 3.0, 2.6],
        sorghum: [1.8, 2.0, 1.7, 2.3, 1.9],
        corn: [2.2, 2.4, 2.0, 2.7, 2.3],
        cotton: [3.0, 3.3, 2.8, 3.5, 3.1],
        sugarcane: [2.8, 3.0, 2.7, 3.2, 2.9],
        tea: [3.5, 3.8, 3.4, 4.0, 3.7],
        coffee: [4.0, 4.2, 3.9, 4.3, 4.1],
        rubber: [3.2, 3.4, 3.1, 3.5, 3.3],
        cocoa: [3.8, 4.0, 3.7, 4.2, 3.9],
        peanut: [2.3, 2.4, 2.2, 2.5, 2.1],
        soybean: [2.6, 2.7, 2.5, 2.8, 2.4]
      }
    };

    function updateClimate() {
      gameState.climateRisk = gameState.difficulty;
      document.getElementById('climate-meter').textContent =
        `æç«¯å¤©æ°”æ¦‚ç‡: ${gameState.climateRisk}%`;
    }

    function applyRandomPolicy() {
      if (Math.random() < 0.6) return;
      const policy = POLICIES[Math.floor(Math.random() * POLICIES.length)];
      policy.effect();
      gameState.policies.push(policy.name);
      gameState.allPolicies.push(policy.name);
      const policyDiv = document.getElementById('policy-effect');
      policyDiv.innerHTML = `
        <h4>æ–°æ”¿ç­–é¢å¸ƒï¼š${policy.name}</h4>
        <p>${policy.description}</p>
      `;
    }

    function updateMapEffect(scenario) {
      const map = document.getElementById('map');
      map.className = '';
      map.innerHTML = '';
      const overlay = document.createElement('div');
      overlay.className = 'satellite-overlay';
      if (scenario.type === 'æ´ªæ°´') {
        overlay.classList.add('flood-effect');
        map.style.backgroundColor = '#006994';
      } else if (scenario.type === 'å»¶è¿Ÿå¹²æ—±') {
        overlay.classList.add('drought-effect');
        map.style.backgroundColor = '#8B4513';
      } else {
        map.style.backgroundColor = '#87CEEB';
      }
      map.appendChild(overlay);
      map.insertAdjacentHTML('beforeend',
        `<h2 style="color:white; position:absolute; top:10px; left:10px">
          ${scenario.type}
        </h2>`);
    }

    function calculateYield(scenario) {
      let yieldRate = scenario.yieldFactor;
      if (gameState.currentCrop && CROPS[gameState.currentCrop]) {
        const cropModifiers = CROPS[gameState.currentCrop].modifiers;
        if (cropModifiers[scenario.type] !== undefined) {
          yieldRate = cropModifiers[scenario.type];
        }
      }
      if (gameState.equipment.includes('çŒæº‰è®¾å¤‡') && scenario.type === 'å»¶è¿Ÿå¹²æ—±') {
        yieldRate *= 1.5;
      }
      if (gameState.equipment.includes('é˜²æ´ªè®¾æ–½') && scenario.type === 'æ´ªæ°´') {
        yieldRate *= 1.3;
      }
      let weatherBonusApplied = false;
      if (gameState.equipment.includes('æ°”è±¡ç›‘æµ‹ä»ª')) {
        const isExtreme = Math.random() < gameState.climateRisk / 100;
        if (isExtreme) {
          const predictedScenario = monsoonScenarios[Math.random() > 0.5 ? 1 : 2];
          if (predictedScenario.type === scenario.type) {
            yieldRate *= 1.2;
            weatherBonusApplied = true;
          }
        }
      }
      if (weatherBonusApplied) {
        gameState.weatherSuccess = (gameState.weatherSuccess || 0) + 1;
      } else {
        gameState.weatherSuccess = 0;
      }
      if ((scenario.type === 'å»¶è¿Ÿå¹²æ—±' && !gameState.equipment.includes('çŒæº‰è®¾å¤‡')) ||
        (scenario.type === 'æ´ªæ°´' && !gameState.equipment.includes('é˜²æ´ªè®¾æ–½'))
      ) {
        yieldRate *= 0.8;
      }
      return yieldRate;
    }

    function calculateHarvest() {
      const isExtreme = Math.random() < gameState.climateRisk / 100;
      const scenario = isExtreme ?
        monsoonScenarios[Math.floor(Math.random() * (monsoonScenarios.length - 1)) + 1] :
        monsoonScenarios[0];

      updateMapEffect(scenario);
      applyRandomPolicy();
      let yieldRate = calculateYield(scenario);
      let baseIncome = 400;
      if (gameState.policies.includes('å‡ºå£ç¦ä»¤')) baseIncome *= 0.5;
      if (gameState.policies.includes('æŠ€æœ¯æ¨å¹¿')) baseIncome *= 1.2;
      const income = Math.round(baseIncome * yieldRate * gameState.incomeMultiplier);

      // åˆ¤æ–­ä½œç‰©é€‰æ‹©æ˜¯å¦æœ€ä½³
      if (gameState.currentCrop && CROPS[gameState.currentCrop].ideal === scenario.type) {
        gameState.optimalCropMatches++;
      } else {
        gameState.optimalCropMatches = 0;
      }

      if (isExtreme && scenario.type !== "æ­£å¸¸") {
        const disasterPenalty = 400;
        gameState.money -= disasterPenalty;
        addLog(`ç¾å®³ã€${scenario.type}ã€‘å‘ç”Ÿï¼Œæ‰£é™¤èµ„é‡‘: â‚¹${disasterPenalty}`);
        gameState.consecutiveDisasters++;
        gameState.consecutiveSafeYears = 0;
      } else {
        gameState.consecutiveDisasters = 0;
        gameState.consecutiveSafeYears++;
      }
      // å­˜å…¥ä»“åº“
      if (gameState.currentCrop) {
        const cropToAdd = gameState.population * 2;
        gameState.crops[gameState.currentCrop.toLowerCase()] += cropToAdd;
        addLog(`æ”¶è·äº†${cropToAdd}å•ä½${gameState.currentCrop}ï¼Œå­˜å…¥ä»“åº“`);
      }
      recordHistory(scenario, income);
      updateClimate();
      updateAchievements(income);
      updateDisplay();
      addLog(`æ”¶è·æ”¶å…¥: â‚¹${income}`);
      showFeedback(income, scenario);
      checkGameOver();
    }

    function checkGameOver() {
      if (gameState.money <= 0) {
        sellCropsToCoverDebt();
        showGameOverModal('å¤±è´¥', 'èµ„é‡‘è€—å°½ï¼Œæ¸¸æˆå¤±è´¥ï¼', 'failure');
      } else if (gameState.consecutiveDisasters >= 3) {
        showGameOverModal('å¤±è´¥', 'è¿ç»­3æ¬¡ç¾å®³ï¼Œæ¸¸æˆå¤±è´¥ï¼', 'failure');
      } else if (gameState.year >= 2030) {
        showGameOverModal('èƒœåˆ©', 'æˆåŠŸå­˜æ´»åˆ°2030å¹´ï¼Œæ¸¸æˆèƒœåˆ©ï¼', 'success');
      } else if (gameState.gameMode === 'challenge' && gameState.year - 2023 >= gameState.challengeYears) {
        showGameOverModal('èƒœåˆ©', `æŒ‘æˆ˜æ¨¡å¼å®Œæˆï¼åšæŒäº†${gameState.challengeYears}å¹´`, 'success');
      } else if (gameState.population <= 0) {
        showGameOverModal('å¤±è´¥', 'äººå£å½’é›¶ï¼Œæ¸¸æˆç»“æŸï¼', 'failure');
      }
    }

    function chooseCrop(crop) {
      if (CROPS[crop]) {
        gameState.currentCrop = crop;
        addLog(`ä½ é€‰æ‹©äº† ${crop}`);
      } else {
        addLog(`æœªçŸ¥ä½œç‰©: ${crop}`);
      }
    }

    function buyItem(item, cost) {
      const actualCost = Math.round(cost * gameState.equipmentCost);
      if (gameState.money >= actualCost) {
        gameState.money -= actualCost;
        gameState.equipment.push(item);
        addLog(`ä½ è´­ä¹°äº† ${item}ï¼ŒèŠ±è´¹ â‚¹${actualCost}`);
        updateDisplay();
      } else {
        addLog(`èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è´­ä¹° ${item}`);
      }
    }

    function startNewYear() {
      if (!gameState.currentCrop) {
        addLog('è¯·å…ˆé€‰æ‹©ä½œç‰©ï¼');
        return;
      }
      gameState.year++;
      gameState.policies = [];
      document.getElementById('policy-effect').innerHTML = '';
      calculateHarvest();
      updatePopulation();
    }

    function recordHistory(scenario, income) {
      const historyRow = `
        <tr>
          <td>${gameState.year}</td>
          <td>${scenario.type}</td>
          <td>â‚¹${income}</td>
          <td>${gameState.policies.join(', ')}</td>
        </tr>
      `;
      document.getElementById('history-body').insertAdjacentHTML('beforeend', historyRow);
      gameState.history.push({ year: gameState.year, scenario: scenario.type, income: income });
    }

    function updateDisplay() {
      document.getElementById('money').textContent = gameState.money;
      document.getElementById('current-population').textContent = gameState.population;
      document.getElementById('wheat-crops').textContent = gameState.crops.wheat;
      document.getElementById('rice-crops').textContent = gameState.crops.rice;
      document.getElementById('sorghum-crops').textContent = gameState.crops.sorghum;
      document.getElementById('corn-crops').textContent = gameState.crops.corn;
      document.getElementById('cotton-crops').textContent = gameState.crops.cotton;
      document.getElementById('sugarcane-crops').textContent = gameState.crops.sugarcane;
      document.getElementById('tea-crops').textContent = gameState.crops.tea;
      document.getElementById('coffee-crops').textContent = gameState.crops.coffee;
      document.getElementById('rubber-crops').textContent = gameState.crops.rubber;
      document.getElementById('cocoa-crops').textContent = gameState.crops.cocoa;
      document.getElementById('peanut-crops').textContent = gameState.crops.peanut;
      document.getElementById('soybean-crops').textContent = gameState.crops.soybean;
      document.getElementById('wheat-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.wheat.toFixed(1)}/å•ä½`;
      document.getElementById('rice-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.rice.toFixed(1)}/å•ä½`;
      document.getElementById('sorghum-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.sorghum.toFixed(1)}/å•ä½`;
      document.getElementById('corn-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.corn.toFixed(1)}/å•ä½`;
      document.getElementById('cotton-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.cotton.toFixed(1)}/å•ä½`;
      document.getElementById('sugarcane-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.sugarcane.toFixed(1)}/å•ä½`;
      document.getElementById('tea-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.tea.toFixed(1)}/å•ä½`;
      document.getElementById('coffee-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.coffee.toFixed(1)}/å•ä½`;
      document.getElementById('rubber-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.rubber.toFixed(1)}/å•ä½`;
      document.getElementById('cocoa-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.cocoa.toFixed(1)}/å•ä½`;
      document.getElementById('peanut-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.peanut.toFixed(1)}/å•ä½`;
      document.getElementById('soybean-price').textContent = `å½“å‰ä»·æ ¼: â‚¹${gameState.cropPrices.soybean.toFixed(1)}/å•ä½`;
      
      // æ›´æ–°æ»‘å—æœ€å¤§å€¼
      document.getElementById('sell-wheat-amount').max = gameState.crops.wheat;
      document.getElementById('sell-rice-amount').max = gameState.crops.rice;
      document.getElementById('sell-sorghum-amount').max = gameState.crops.sorghum;
      document.getElementById('sell-corn-amount').max = gameState.crops.corn;
      document.getElementById('sell-cotton-amount').max = gameState.crops.cotton;
      document.getElementById('sell-sugarcane-amount').max = gameState.crops.sugarcane;
      document.getElementById('sell-tea-amount').max = gameState.crops.tea;
      document.getElementById('sell-coffee-amount').max = gameState.crops.coffee;
      document.getElementById('sell-rubber-amount').max = gameState.crops.rubber;
      document.getElementById('sell-cocoa-amount').max = gameState.crops.cocoa;
      document.getElementById('sell-peanut-amount').max = gameState.crops.peanut;
      document.getElementById('sell-soybean-amount').max = gameState.crops.soybean;
    }

    function addLog(message) {
      const log = document.getElementById('log');
      const logEntry = document.createElement('p');
      logEntry.textContent = message;
      log.appendChild(logEntry);
      log.scrollTop = log.scrollHeight;
    }

    // è¿›é˜¶æˆå°±ä¸åé¦ˆç³»ç»Ÿ
    function updateAchievements(income) {
      const achievementPanel = document.getElementById('achievement-panel');
      // â€œå¯Œå†œç§°å·â€ï¼šèµ„é‡‘è¶…è¿‡2000
      if (gameState.money >= 2000 && !gameState.achievements.includes("å¯Œå†œç§°å·")) {
        gameState.achievements.push("å¯Œå†œç§°å·");
        addLog("æˆå°±è¾¾æˆï¼šå¯Œå†œç§°å·ï¼é€šè¿‡ç§¯ç´¯èµ„é‡‘ï¼Œä½ æŒæ¡äº†å†œä¸šç»è¥çš„åŸºæœ¬ç†è´¢çŸ¥è¯†ã€‚");
      }
      // â€œä¸°æ”¶è¾¾äººâ€ï¼šè¿ç»­å®‰å…¨å¹´ä»½è¾¾åˆ°5å¹´
      if (gameState.consecutiveSafeYears >= 5 && !gameState.achievements.includes("ä¸°æ”¶è¾¾äºº")) {
        gameState.achievements.push("ä¸°æ”¶è¾¾äºº");
        addLog("æˆå°±è¾¾æˆï¼šä¸°æ”¶è¾¾äººï¼ä½ æˆåŠŸèº²è¿‡è¿ç»­ç¾å®³ï¼Œä¿éšœäº†å†œä¸šç¨³å®šå‘å±•ã€‚");
      }
      // â€œå¤©é™æ¨ªè´¢â€ï¼šå•å¹´æ”¶å…¥è¶…è¿‡â‚¹1000
      if (income > 1000 && !gameState.achievements.includes("å¤©é™æ¨ªè´¢")) {
        gameState.achievements.push("å¤©é™æ¨ªè´¢");
        addLog("æˆå°±è¾¾æˆï¼šå¤©é™æ¨ªè´¢ï¼ä½ åœ¨å±æœºä¸­ä¹Ÿèƒ½æ”¶è·é«˜é¢æ”¶å…¥ï¼Œå±•ç¤ºäº†é«˜è¶…çš„å†³ç­–èƒ½åŠ›ã€‚");
      }
      // â€œè£…å¤‡å¤§å¸ˆâ€ï¼šæ‹¥æœ‰å…¨éƒ¨3ç§è®¾å¤‡
      const uniqueEquip = new Set(gameState.equipment);
      if (uniqueEquip.size >= 3 && !gameState.achievements.includes("è£…å¤‡å¤§å¸ˆ")) {
        gameState.achievements.push("è£…å¤‡å¤§å¸ˆ");
        addLog("æˆå°±è¾¾æˆï¼šè£…å¤‡å¤§å¸ˆï¼ä½ å……åˆ†åˆ©ç”¨äº†é˜²ç¾è®¾å¤‡ï¼Œç¡®ä¿äº†å†œä¸šå®‰å…¨ã€‚");
      }
      // æ–°å¢â€”â€”â€œä½œç‰©ä¸“å®¶â€ï¼šè¿ç»­3å¹´é€‰æ‹©æœ€ä½³ä½œç‰©
      if (gameState.optimalCropMatches >= 3 && !gameState.achievements.includes("ä½œç‰©ä¸“å®¶")) {
        gameState.achievements.push("ä½œç‰©ä¸“å®¶");
        addLog("æˆå°±è¾¾æˆï¼šä½œç‰©ä¸“å®¶ï¼ä½ æ·±åˆ»ç†è§£äº†å„ä½œç‰©ä¸å­£é£ç¯å¢ƒçš„åŒ¹é…åŸç†ã€‚");
      }
      // æ–°å¢â€”â€”â€œæ°”å€™é¢„æµ‹å®¶â€ï¼šæ°”è±¡ç›‘æµ‹ä»ªé¢å¤–åŠ æˆç´¯è®¡è¾¾åˆ°2æ¬¡
      if (gameState.weatherSuccess >= 2 && !gameState.achievements.includes("æ°”å€™é¢„æµ‹å®¶")) {
        gameState.achievements.push("æ°”å€™é¢„æµ‹å®¶");
        addLog("æˆå°±è¾¾æˆï¼šæ°”å€™é¢„æµ‹å®¶ï¼ä½ æˆåŠŸåˆ©ç”¨ç°ä»£ç§‘æŠ€é¢„æµ‹å¤©æ°”å˜åŒ–ã€‚");
      }
      // æ–°å¢â€”â€”â€œæ”¿ç­–è§£è¯»è€…â€ï¼šç´¯è®¡è§¦å‘æœ‰åˆ©æ”¿ç­–ï¼ˆç§æ¤è¡¥è´´æˆ–æŠ€æœ¯æ¨å¹¿ï¼‰2æ¬¡ä»¥ä¸Š
      const beneficialPolicies = gameState.allPolicies.filter(p => p === "ç§æ¤è¡¥è´´" || p === "æŠ€æœ¯æ¨å¹¿");
      if (beneficialPolicies.length >= 2 && !gameState.achievements.includes("æ”¿ç­–è§£è¯»è€…")) {
        gameState.achievements.push("æ”¿ç­–è§£è¯»è€…");
        addLog("æˆå°±è¾¾æˆï¼šæ”¿ç­–è§£è¯»è€…ï¼ä½ æ•é”æ•æ‰åˆ°æ”¿ç­–å˜åŒ–ï¼Œå¹¶åˆ©ç”¨å…¶ä¼˜åŠ¿æé«˜äº§é‡ã€‚");
      }
      // æ–°å¢â€”â€”â€œå¯æŒç»­å‘å±•è€…â€ï¼šæ›¾è§¦å‘ç¯ä¿æ”¿ç­–
      if (gameState.allPolicies.includes("ç¯ä¿æ”¿ç­–") && !gameState.achievements.includes("å¯æŒç»­å‘å±•è€…")) {
        gameState.achievements.push("å¯æŒç»­å‘å±•è€…");
        addLog("æˆå°±è¾¾æˆï¼šå¯æŒç»­å‘å±•è€…ï¼ä½ å…³æ³¨ç¯å¢ƒä¿æŠ¤ï¼Œè·µè¡Œå¯æŒç»­å†œä¸šç†å¿µã€‚");
      }
      if (gameState.achievements.length === 0) {
        achievementPanel.innerHTML = "<p>æš‚æ— æˆå°±</p>";
      } else {
        achievementPanel.innerHTML = "";
        gameState.achievements.forEach(ach => {
          const achElem = document.createElement('h4');
          achElem.textContent = ach;
          achievementPanel.appendChild(achElem);
        });
      }
    }

    // å®æ—¶åé¦ˆç³»ç»Ÿï¼šæ¯å›åˆç»“æŸåæ˜¾ç¤ºåé¦ˆä¿¡æ¯
    function showFeedback(income, scenario) {
      const feedbackPanel = document.getElementById('feedback-panel');
      let feedbackMsg = "";
      if (gameState.currentCrop && CROPS[gameState.currentCrop].ideal === scenario.type) {
        feedbackMsg += "ä½ é€‰æ‹©çš„ä½œç‰©ä¸æœ¬å¹´åº¦ç¯å¢ƒå®Œç¾åŒ¹é…ï¼Œäº§é‡æå‡æ˜æ˜¾ã€‚";
      } else {
        feedbackMsg += "æ³¨æ„ï¼šæœ¬å¹´åº¦ç¯å¢ƒä¸æ‰€é€‰ä½œç‰©ä¸å®Œå…¨åŒ¹é…ï¼Œè€ƒè™‘è°ƒæ•´ç­–ç•¥ã€‚";
      }
      if (income > 1000) {
        feedbackMsg += " å•å¹´æ”¶å…¥è¡¨ç°ä¼˜ç§€ï¼";
      }
      feedbackPanel.textContent = feedbackMsg;
      feedbackPanel.style.display = "block";
      // 3ç§’åéšè—åé¦ˆ
      setTimeout(() => { feedbackPanel.style.display = "none"; }, 3000);
    }

    function restartGame() {
      gameState.money = 800;
      gameState.currentCrop = null;
      gameState.equipment = [];
      gameState.policies = [];
      gameState.allPolicies = [];
      gameState.history = [];
      gameState.climateRisk = gameState.difficulty;
      gameState.year = 2023;
      gameState.incomeMultiplier = 1;
      gameState.equipmentCost = 1;
      gameState.consecutiveDisasters = 0;
      gameState.consecutiveSafeYears = 0;
      gameState.achievements = [];
      gameState.optimalCropMatches = 0;
      gameState.weatherSuccess = 0;
      gameState.population = gameState.initialPopulation;
      gameState.crops = {
        wheat: 200,
        rice: 0,
        sorghum: 0,
        corn: 0,
        cotton: 0,
        sugarcane: 0,
        tea: 0,
        coffee: 0,
        rubber: 0,
        cocoa: 0,
        peanut: 0,
        soybean: 0
      };
      gameState.cropPrices = {
        wheat: 2.0,
        rice: 2.5,
        sorghum: 1.8,
        corn: 2.2,
        cotton: 3.0,
        sugarcane: 2.8,
        tea: 3.5,
        coffee: 4.0,
        rubber: 3.2,
        cocoa: 3.8,
        peanut: 2.3,
        soybean: 2.6
      };
      updateDisplay();
      document.getElementById('policy-effect').innerHTML = '';
      document.getElementById('history-body').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('achievement-panel').innerHTML = "<p>æš‚æ— æˆå°±</p>";
      document.getElementById('game-over-modal').style.display = 'none';
      // é‡ç½®æ•™ç¨‹
      currentTutorialStep = 0;
      document.getElementById("tutorial-text").textContent = tutorialSteps[currentTutorialStep];
      document.getElementById("tutorial-overlay").style.display = "flex";
    }

    function startSettings() {
      document.getElementById('mode-selection-modal').style.display = 'none';
      document.getElementById('settings-modal').style.display = 'flex';
    }

    function startGame() {
      const gameMode = document.querySelector('input[name="game-mode"]:checked').value;
      gameState.gameMode = gameMode;
      if (gameMode === 'challenge') {
        gameState.challengeYears = parseInt(document.getElementById('challenge-years').value);
      }
      gameState.difficulty = parseInt(document.getElementById('difficulty').value);
      gameState.climateRisk = gameState.difficulty;
      gameState.initialPopulation = Math.floor(Math.random() * 101) + 150; // éšæœºåˆå§‹äººå£150~250
      gameState.population = gameState.initialPopulation;
      gameState.birthplace = document.querySelector('input[name="birthplace"]:checked').value;
      updateDisplay();
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById("tutorial-overlay").style.display = "flex";
    }

    function increasePopulation() {
      if (gameState.money >= 1500) {
        gameState.money -= 1500;
        gameState.population = Math.round(gameState.population * 1.1);
        addLog("ä½ å¢åŠ äº†10%çš„äººå£");
        updateDisplay();
      } else {
        addLog("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•å¢åŠ äººå£");
      }
    }

    function decreasePopulation() {
      if (gameState.money >= 50) {
        gameState.money -= 50;
        gameState.population = Math.round(gameState.population * 0.9);
        addLog("ä½ å‡å°‘äº†10%çš„äººå£");
        updateDisplay();
      } else {
        addLog("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•å‡å°‘äººå£");
      }
    }

    function updatePopulation() {
      // æ¯å¹´å¢åŠ 7%äººå£
      gameState.population = Math.round(gameState.population * 1.07);
      // æ¶ˆè€—ç²®é£Ÿ
      // const grainNeeded = Math.ceil(gameState.population * 0.5);
      // let totalGrain = gameState.crops.wheat + gameState.crops.rice + gameState.crops.sorghum + gameState.crops.corn;
      // if (totalGrain >= grainNeeded) {
      //   // æŒ‰æ¯”ä¾‹æ¶ˆè€—ç²®é£Ÿ
      //   const wheatConsumption = Math.round(grainNeeded * (gameState.crops.wheat / totalGrain));
      //   const riceConsumption = Math.round(grainNeeded * (gameState.crops.rice / totalGrain));
      //   const sorghumConsumption = Math.round(grainNeeded * (gameState.crops.sorghum / totalGrain));
      //   const cornConsumption = Math.round(grainNeeded * (gameState.crops.corn / totalGrain));
      
      //   gameState.crops.wheat -= wheatConsumption;
      //   gameState.crops.rice -= riceConsumption;
      //   gameState.crops.sorghum -= sorghumConsumption;
      //   gameState.crops.corn -= cornConsumption;
      // } else {
      //   const deficit = grainNeeded - totalGrain;
      //   gameState.population -= deficit;
      //   gameState.crops.wheat = 0;
      //   gameState.crops.rice = 0;
      //   gameState.crops.sorghum = 0;
      //   gameState.crops.corn = 0;
      // }
      // ç¡®ä¿äººå£ä¸ä¸ºè´Ÿæ•°å’Œå°æ•°
      gameState.population = Math.max(0, gameState.population);
      updateDisplay();
    }

    function sellCrop(cropName) {
      const amount = parseInt(document.getElementById(`sell-${cropName}-amount`).value);
      if (isNaN(amount) || amount <= 0) {
        addLog("è¯·è¾“å…¥æœ‰æ•ˆçš„å‡ºå”®æ•°é‡");
        return;
      }
      if (amount > gameState.crops[cropName]) {
        addLog(`${cropName}ä¸è¶³ï¼Œæ— æ³•å‡ºå”®`);
        return;
      }
      gameState.crops[cropName] -= amount;
      gameState.money += Math.round(amount * gameState.cropPrices[cropName]);
      addLog(`å‡ºå”®äº†${amount}å•ä½${cropName}ï¼Œè·å¾—â‚¹${Math.round(amount * gameState.cropPrices[cropName])}`);
      updateDisplay();
      // æ›´æ–°ä»·æ ¼ï¼ˆæ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨ï¼‰
      gameState.priceHistory[cropName].shift();
      gameState.priceHistory[cropName].push(gameState.cropPrices[cropName]);
      gameState.cropPrices[cropName] = (gameState.priceHistory[cropName].reduce((a, b) => a + b, 0) / gameState.priceHistory[cropName].length) * (0.9 + Math.random() * 0.2);
    }

    function sellCropsToCoverDebt() {
      // è‡ªåŠ¨å‡ºå”®ä½œç‰©ä»¥è¦†ç›–å€ºåŠ¡
      const crops = ['wheat', 'rice', 'sorghum', 'corn', 'cotton', 'sugarcane', 'tea', 'coffee', 'rubber', 'cocoa', 'peanut', 'soybean'];
      let debt = -gameState.money;
      for (const crop of crops) {
        if (debt <= 0) break;
        const maxSell = Math.min(gameState.crops[crop], Math.ceil(debt / gameState.cropPrices[crop]));
        if (maxSell <= 0) continue;
        gameState.crops[crop] -= maxSell;
        gameState.money += maxSell * gameState.cropPrices[crop];
        debt -= maxSell * gameState.cropPrices[crop];
        addLog(`è‡ªåŠ¨å‡ºå”®${maxSell}å•ä½${crop}ä»¥è¦†ç›–å€ºåŠ¡`);
      }
      // ç¡®ä¿é‡‘é’±ä¸ä½äº0
      gameState.money = Math.max(0, gameState.money);
      updateDisplay();
    }

    function showGameOverModal(title, message, status) {
      const modal = document.getElementById('game-over-modal');
      const modalContent = document.getElementById('modal-content');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      modal.style.display = 'flex';
      modalContent.classList.remove('success', 'failure');
      modalContent.classList.add(status);
      modalTitle.textContent = title;
      modalMessage.textContent = message + ` æœ€ç»ˆèµ„é‡‘: â‚¹${gameState.money}ï¼Œæœ€ç»ˆäººå£: ${gameState.population}`;
    }

    function showExportScoreModal() {
      document.getElementById('export-score-modal').style.display = 'flex';
    }

    function exportScore() {
      const playerName = document.getElementById('player-name').value || 'åŒ¿åç©å®¶';
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„canvaså…ƒç´ ç”¨äºç»˜åˆ¶æˆ˜ç»©
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 800;
      canvas.height = 600;
      // ç»˜åˆ¶èƒŒæ™¯
      ctx.fillStyle = '#f7faff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // ç»˜åˆ¶æ ‡é¢˜
      ctx.font = '36px Roboto';
      ctx.fillStyle = '#333';
      ctx.textAlign = 'center';
      ctx.fillText('å­£é£å†³ç­–è€… - æˆ˜ç»©', canvas.width / 2, 50);
      // ç»˜åˆ¶ç©å®¶ä¿¡æ¯
      ctx.font = '24px Roboto';
      ctx.fillText(`ç©å®¶: ${playerName}`, canvas.width / 2, 100);
      // ç»˜åˆ¶æ¸¸æˆæ•°æ®
      ctx.font = '18px Roboto';
      ctx.fillText(`æ¸¸æˆæ¨¡å¼: ${gameState.gameMode}`, canvas.width / 2, 150);
      if (gameState.gameMode === 'challenge') {
        ctx.fillText(`æŒ‘æˆ˜å¹´é™: ${gameState.challengeYears}å¹´`, canvas.width / 2, 180);
      }
      ctx.fillText(`éš¾åº¦: ${gameState.difficulty}%`, canvas.width / 2, 210);
      ctx.fillText(`å‡ºç”Ÿåœ°: ${gameState.birthplace}`, canvas.width / 2, 240);
      ctx.fillText(`åˆå§‹äººå£: ${gameState.initialPopulation}äºº`, canvas.width / 2, 270);
      ctx.fillText(`æœ€ç»ˆäººå£: ${gameState.population}äºº`, canvas.width / 2, 300);
      ctx.fillText(`æ¸¸æˆå¹´ä»½: ${gameState.year - 2023}å¹´`, canvas.width / 2, 330);
      ctx.fillText(`æœ€ç»ˆèµ„é‡‘: â‚¹${gameState.money}`, canvas.width / 2, 360);
      // ç»˜åˆ¶æˆå°±
      ctx.fillText('æˆå°±:', canvas.width / 2, 400);
      if (gameState.achievements.length > 0) {
        gameState.achievements.forEach((ach, index) => {
          ctx.fillText(`${index + 1}. ${ach}`, canvas.width / 2, 430 + index * 30);
        });
      } else {
        ctx.fillText('æš‚æ— æˆå°±', canvas.width / 2, 430);
      }
      // å°†canvaså†…å®¹è½¬æ¢ä¸ºPNGå›¾ç‰‡
      const dataURL = canvas.toDataURL('image/png');
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„aå…ƒç´ ç”¨äºä¸‹è½½
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = `monsoon-decision-maker-score-${playerName}.png`;
      link.click();
      // éšè—å¯¼å‡ºå¼¹çª—
      document.getElementById('export-score-modal').style.display = 'none';
    }

    function predictDisaster() {
      if (!gameState.equipment.includes('æ°”è±¡ç›‘æµ‹ä»ª')) {
        addLog('éœ€è¦æ°”è±¡ç›‘æµ‹ä»ªæ‰èƒ½è¿›è¡Œç¾å®³é¢„æµ‹');
        return;
      }
      if (gameState.money < 300) {
        addLog('èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œç¾å®³é¢„æµ‹');
        return;
      }
      gameState.money -= 300;
      const isExtreme = Math.random() < gameState.climateRisk / 100;
      const predictedScenario = isExtreme ?
        monsoonScenarios[Math.floor(Math.random() * (monsoonScenarios.length - 1)) + 1] :
        monsoonScenarios[0];
      document.getElementById('prediction-result').textContent = `é¢„æµ‹ä¸‹ä¸€å¹´å¯èƒ½å‡ºç°çš„ç¾å®³: ${predictedScenario.type}`;
      addLog(`é¢„æµ‹ä¸‹ä¸€å¹´å¯èƒ½å‡ºç°çš„ç¾å®³: ${predictedScenario.type}`);
    }
  </script>
</body>

</html>
