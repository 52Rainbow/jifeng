<!DOCTYPE html>
<html>

<head>
  <title>季风决策者2.1.1</title>
  <!-- 引入 Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <!-- 添加网站图标 -->
  <link rel="icon" href="f.ico" type="image/x-icon">
  <style>
    :root {
      --flood-color: #006994;
      --drought-color: #8B4513;
      --primary-bg: #f7faff;
      --secondary-bg: #fff;
      --accent-color: #FF5722;
      --policy-bg: #fff9e6;
      --policy-border: #ffd700;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--primary-bg);
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      color: #333;
    }

    .grid-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    #map {
      height: 250px;
      background: linear-gradient(160deg, #4d7c3f 0%, #87CEEB 100%);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }

    .satellite-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      background-size: 40px 40px;
      opacity: 0.7;
    }

    .policy-card {
      background: var(--policy-bg);
      padding: 15px;
      margin: 10px 0;
      border-left: 5px solid var(--policy-border);
      box-shadow: var(--box-shadow);
      border-radius: 5px;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: var(--box-shadow);
    }

    .history-table th {
      background: var(--accent-color);
      color: white;
      padding: 10px;
    }

    .history-table td {
      padding: 10px;
      border: 1px solid #ddd;
    }

    @keyframes flood-pulse {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 40px 40px;
      }
    }

    @keyframes drought-pulse {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 40px -40px;
      }
    }

    .flood-effect {
      background-image: linear-gradient(45deg,
          var(--flood-color) 25%,
          transparent 25%,
          transparent 50%,
          var(--flood-color) 50%,
          var(--flood-color) 75%,
          transparent 75%);
      animation: flood-pulse 2s linear infinite;
    }

    .drought-effect {
      background-image: linear-gradient(45deg,
          var(--drought-color) 25%,
          transparent 25%,
          transparent 50%,
          var(--drought-color) 50%,
          var(--drought-color) 75%,
          transparent 75%);
      animation: drought-pulse 2s linear infinite;
    }

    button {
      background: var(--accent-color);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: var(--box-shadow);
      font-size: 1em;
    }

    button:hover {
      background: #e64a19;
      transform: translateY(-2px);
    }

    /* 按钮与说明容器 */
    .button-with-desc {
      display: inline-block;
      text-align: center;
      margin: 10px;
    }

    .button-with-desc small {
      display: block;
      font-size: 0.8em;
      color: #555;
      margin-top: 4px;
    }

    #log {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background: var(--secondary-bg);
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    /* 反馈信息面板 */
    #feedback-panel {
      background: #eef;
      padding: 10px;
      border: 1px solid #99c;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 0.9em;
      display: none;
    }

    /* 成就面板 */
    #achievement-panel {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #achievement-panel h4 {
      margin: 5px 0;
      color: var(--accent-color);
    }

    /* 帮助信息：改为出生地介绍和游玩规则 */
    #help-info {
      background: var(--secondary-bg);
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #help-info h3 {
      margin-top: 0;
    }

    #help-info p {
      font-size: 0.9em;
      line-height: 1.4;
    }

    /* 游戏结束弹窗样式 */
    #game-over-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #modal-content {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    #modal-content.success {
      border: 2px solid green;
    }

    #modal-content.failure {
      border: 2px solid red;
    }

    /* 新增模式选择弹窗样式 */
    #mode-selection-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #mode-selection-content {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    #mode-selection-content h2 {
      margin-bottom: 10px;
    }

    #mode-selection-content p {
      font-size: 1em;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* 人口机制相关样式 */
    #population-panel {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    /* 作物选择相关样式 */
    #crop-selection {
      margin-top: 20px;
    }

    #crop-selection h3 {
      margin-bottom: 10px;
    }

    .crop-type {
      margin-bottom: 15px;
    }

    .crop-type h4 {
      margin-bottom: 5px;
    }

    /* 出生地选择相关样式 */
    #birthplace-selection {
      margin-top: 20px;
    }

    #birthplace-selection h3 {
      margin-bottom: 10px;
    }

    .birthplace-option {
      margin-bottom: 10px;
    }

    /* 仓库相关样式 */
    #warehouse {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    /* 新增导出战绩弹窗样式 */
    #export-score-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #export-score-content {
      background: var(--secondary-bg);
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    #export-score-content h2 {
      margin-bottom: 10px;
    }

    #export-score-content p {
      font-size: 1em;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* 仓库作物选择样式 */
    .crop-selection {
      margin: 10px 0;
    }

    .crop-selection h4 {
      margin-bottom: 5px;
    }

    .crop-selection input {
      width: 50px;
      text-align: right;
    }

    /* 公告栏样式 */
    #announcement-bar {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #announcement-bar h4 {
      margin-top: 0;
    }

    #announcement-bar p {
      font-size: 0.9em;
      line-height: 1.4;
    }

    /* 新增灾害预测区块样式 */
    #disaster-prediction {
      background: var(--secondary-bg);
      padding: 10px;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: var(--box-shadow);
    }

    #disaster-prediction h3 {
      margin-top: 0;
    }

    /* 新增图表样式 */
    .chart-container {
      height: 100px;
      background: #f5f5f5;
      margin: 10px 0;
      border-radius: 5px;
      position: relative;
    }

    .chart-line {
      position: absolute;
      height: 2px;
      background: var(--accent-color);
      bottom: 0;
    }
  </style>
</head>

<body>
  <!-- 模式选择弹窗 -->
  <div id="mode-selection-modal">
    <div id="mode-selection-content">
      <h2>选择游戏模式</h2>
      <div>
        <label>
          <input type="radio" name="game-mode" value="challenge" checked> 挑战模式
        </label>
        <label>
          <input type="radio" name="game-mode" value="endless"> 无尽模式
        </label>
      </div>
      <div id="challenge-settings" style="margin-top: 10px; display: none;">
        <label for="challenge-years">挑战年限:</label>
        <input type="number" id="challenge-years" min="5" max="20" value="10">
      </div>
      <div style="margin-top: 20px;">
        <label>选择难度:</label>
        <select id="difficulty">
          <option value="20">简单 (20%)</option>
          <option value="40">普通 (40%)</option>
          <option value="70">困难 (70%)</option>
          <option value="100">地狱 (100%)</option>
        </select>
      </div>
      <button onclick="startSettings()">下一步</button>
    </div>
  </div>

  <!-- 设置弹窗 -->
  <div id="settings-modal">
    <div id="settings-content">
      <h2>游戏设置</h2>
      <div id="birthplace-selection">
        <h3>🌍 选择出生地</h3>
        <div class="birthplace-option">
          <h4>中国</h4>
          <p>拥有多种气候类型，农业经验丰富，灾害应对能力强。</p>
          <label>
            <input type="radio" name="birthplace" value="china-north"> 华北平原
          </label>
          <label>
            <input type="radio" name="birthplace" value="china-south"> 长江中下游
          </label>
          <label>
            <input type="radio" name="birthplace" value="china-west"> 西北地区
          </label>
        </div>
        <div class="birthplace-option">
          <h4>俄罗斯</h4>
          <p>气候寒冷，农业集中在南部地区，对极端低温有较强适应能力。</p>
          <label>
            <input type="radio" name="birthplace" value="russia-south"> 南部平原
          </label>
          <label>
            <input type="radio" name="birthplace" value="russia-west"> 西伯利亚
          </label>
          <label>
            <input type="radio" name="birthplace" value="russia-east"> 远东地区
          </label>
        </div>
        <div class="birthplace-option">
          <h4>东南亚</h4>
          <p>热带气候为主，季风影响明显，适合种植热带作物。</p>
          <label>
            <input type="radio" name="birthplace" value="sea-thailand"> 泰国中部
          </label>
          <label>
            <input type="radio" name="birthplace" value="sea-vietnam"> 越南北部
          </label>
          <label>
            <input type="radio" name="birthplace" value="sea-indonesia"> 印度尼西亚群岛
          </label>
        </div>
        <div class="birthplace-option">
          <h4>印度</h4>
          <p>季风气候显著，农业依赖季风降雨，对季风变化敏感。</p>
          <label>
            <input type="radio" name="birthplace" value="india-north"> 北部平原
          </label>
          <label>
            <input type="radio" name="birthplace" value="india-south"> 南部高原
          </label>
          <label>
            <input type="radio" name="birthplace" value="india-east"> 东部沿海
          </label>
        </div>
      </div>
      <button onclick="startGame()">开始游戏</button>
    </div>
  </div>

  <!-- 教程弹窗 -->
  <div id="tutorial-overlay">
    <div id="tutorial-content">
      <h2>季风决策者 - 游戏规则</h2>
      <p>欢迎来到季风决策者！在这个游戏中，你将扮演一位农业决策者，管理农田、选择作物、应对灾害，努力实现农业的可持续发展。</p>
      <p>游戏目标：通过合理选择作物、购买设备、应对灾害，使你的农场在各种气候条件下稳定发展，实现资金和人口的持续增长。</p>
      <p>主要玩法：</p>
      <ul>
        <li>选择合适的作物种植，不同作物适应不同的气候条件</li>
        <li>购买农业设备来降低灾害风险，提高产量</li>
        <li>游戏中会随机触发政策变化和自然灾害，考验你的应对能力</li>
        <li>管理人口增长和粮食消耗，确保社会稳定</li>
        <li>通过仓库管理，合理出售作物获取资金</li>
      </ul>
      <p>祝你好运！</p>
      <button onclick="startGame()">开始游戏</button>
    </div>
  </div>

  <div class="grid-container">
    <!-- 主游戏区 -->
    <div>
      <h1>🌦️ 季风决策者 -  🚜</h1>
      <div id="map"></div>
      <div id="controls">
        <h3>💰 资金: ₹<span id="money">800</span></h3>
        <div id="current-policy" class="policy-card"></div>
        <h3>🌱 选择作物:</h3>
        <div id="crop-buttons">
          <div class="button-with-desc">
            <button onclick="chooseCrop('水稻')">🌾 水稻</button>
            <small>适应洪水环境，水分充足</small>
          </div>
          <div class="button-with-desc">
            <button onclick="chooseCrop('小麦')">🌾 小麦</button>
            <small>适应正常气候，均衡发展</small>
          </div>
          <div class="button-with-desc">
            <button onclick="chooseCrop('高粱')">🌾 高粱</button>
            <small>耐旱，适合延迟干旱环境</small>
          </div>
          <div class="button-with-desc">
            <button onclick="chooseCrop('玉米')">🌾 玉米</button>
            <small>适合正常环境，产量较高</small>
          </div>
          <!-- 新增经济作物 -->
          <div class="crop-type">
            <h4>经济作物</h4>
            <div class="button-with-desc">
              <button onclick="chooseCrop('棉花')">🌿 棉花</button>
              <small>适应正常气候，经济价值高</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('甘蔗')">🌿 甘蔗</button>
              <small>适应高温多湿环境</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('茶叶')">🌿 茶叶</button>
              <small>适应山地气候，需要排水良好</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('咖啡')">🌿 咖啡</button>
              <small>适应热带气候，需要充足阳光</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('橡胶')">🌿 橡胶</button>
              <small>适应高温多雨环境</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('可可')">🌿 可可</button>
              <small>适应热带雨林气候</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('花生')">🌿 花生</button>
              <small>适应多种气候，耐贫瘠土壤</small>
            </div>
            <div class="button-with-desc">
              <button onclick="chooseCrop('大豆')">🌿 大豆</button>
              <small>富含蛋白质，适应广泛环境</small>
            </div>
          </div>
        </div>
        <h3>🛠️ 农业设备:</h3>
        <div id="equipment-buttons">
          <div class="button-with-desc">
            <button onclick="buyItem('灌溉设备', 300)">💧 灌溉设备 (₹300)</button>
            <small>缓解延迟干旱，提高作物产量</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('防洪设施', 500)">🛡️ 防洪设施 (₹500)</button>
            <small>降低洪水对作物的破坏</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('气象监测仪', 400)">📡 气象监测仪 (₹400)</button>
            <small>提前预测极端天气，调整策略</small>
          </div>
          <!-- 新增灾害应对措施 -->
          <div class="button-with-desc">
            <button onclick="buyItem('干旱预警系统', 450)">⚠️ 干旱预警系统 (₹450)</button>
            <small>提前预警干旱，减少损失</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('洪水预警系统', 450)">⚠️ 洪水预警系统 (₹450)</button>
            <small>提前预警洪水，减少损失</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('病虫害防治', 350)">🐛 病虫害防治 (₹350)</button>
            <small>预防病虫害，保护作物</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('土壤改良剂', 300)">🌱 土壤改良剂 (₹300)</button>
            <small>改善土壤质量，提高产量</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('温室大棚', 600)">🏠 温室大棚 (₹600)</button>
            <small>调节温度和湿度，适应多种气候</small>
          </div>
          <div class="button-with-desc">
            <button onclick="buyItem('粮食储备库', 500)">📦 粮食储备库 (₹500)</button>
            <small>储存粮食，应对歉收年份</small>
          </div>
        </div>
        <button onclick="startNewYear()" style="margin:20px 0">⏩ 进入下一年</button>
        <!-- 反馈面板：每回合结束后显示反馈信息 -->
        <div id="feedback-panel"></div>
      </div>
      <div id="log"></div>
    </div>
    <!-- 信息面板 -->
    <div>
      <!-- 公告栏移动到顶部 -->
      <div id="announcement-bar">
        <h4>📢 公告栏</h4>
        <p id="announcement-content">欢迎来到季风决策者！本版本为2.1.1，暂时解决了BUG，之后会继续更新以修复所有BUG，作者邮箱：383492384@qq.com</p>
      </div>
      <h3>📜 当前政策</h3>
      <div id="policy-effect"></div>
      <h3>📊 历史数据</h3>
      <table class="history-table">
        <thead>
          <tr>
            <th>年份</th>
            <th>季风/灾害</th>
            <th>收入</th>
            <th>政策</th>
          </tr>
        </thead>
        <tbody id="history-body"></tbody>
      </table>
      <h3>🌍 气候变化指数</h3>
      <div id="climate-meter">极端天气概率: 25%</div>
      <h3>🏆 成就系统</h3>
      <div id="achievement-panel">
        <p>暂无成就</p>
      </div>
      <!-- 帮助信息：改为出生地介绍和游玩规则 -->
      <div id="help-info">
        <h3>帮助信息</h3>
        <div id="birthplace-intro">
          <h4>当前出生地介绍</h4>
          <p id="birthplace-description">这里将显示当前出生地的详细介绍。</p>
        </div>
        <div id="game-rules">
          <h4>游玩规则</h4>
          <p>1. 每年选择合适的作物种植，不同作物适应不同的气候条件。</p>
          <p>2. 可以购买农业设备来降低灾害风险，提高产量。</p>
          <p>3. 游戏中会随机触发政策变化和自然灾害，考验你的应对能力。</p>
          <p>4. 管理好人口增长和粮食消耗，确保社会稳定发展。</p>
          <p>5. 通过合理规划，使农场在各种气候条件下稳定发展，实现资金和人口的持续增长。</p>
        </div>
      </div>
      <!-- 新增人口机制 -->
      <div id="population-panel">
        <h3>👥 人口机制</h3>
        <p>初始人口: <span id="initial-population">150~250人</span></p>
        <p>当前人口: <span id="current-population">150人</span></p>
        <p>每年平均增加7%，粮食不足时人口会减少。</p>
        <div>
          <button onclick="increasePopulation()">➕ 增加10%人口 (₹1500)</button>
          <button onclick="decreasePopulation()">➖ 减少10%人口 (₹50)</button>
        </div>
      </div>
      <!-- 新增仓库机制 -->
      <div id="warehouse">
        <h3>📦 仓库</h3>
        <p>初始作物: 小麦 200单位</p>
        <div class="crop-selection">
          <h4>粮食作物</h4>
          <label>小麦:</label>
          <span id="wheat-crops">200</span>
          <input type="range" id="sell-wheat-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('wheat')">出售</button>
          <span id="wheat-price">当前价格: ₹2.0/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>水稻:</label>
          <span id="rice-crops">0</span>
          <input type="range" id="sell-rice-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('rice')">出售</button>
          <span id="rice-price">当前价格: ₹2.5/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>高粱:</label>
          <span id="sorghum-crops">0</span>
          <input type="range" id="sell-sorghum-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('sorghum')">出售</button>
          <span id="sorghum-price">当前价格: ₹1.8/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>玉米:</label>
          <span id="corn-crops">0</span>
          <input type="range" id="sell-corn-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('corn')">出售</button>
          <span id="corn-price">当前价格: ₹2.2/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <h4>经济作物</h4>
          <label>棉花:</label>
          <span id="cotton-crops">0</span>
          <input type="range" id="sell-cotton-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('cotton')">出售</button>
          <span id="cotton-price">当前价格: ₹3.0/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>甘蔗:</label>
          <span id="sugarcane-crops">0</span>
          <input type="range" id="sell-sugarcane-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('sugarcane')">出售</button>
          <span id="sugarcane-price">当前价格: ₹2.8/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>茶叶:</label>
          <span id="tea-crops">0</span>
          <input type="range" id="sell-tea-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('tea')">出售</button>
          <span id="tea-price">当前价格: ₹3.5/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>咖啡:</label>
          <span id="coffee-crops">0</span>
          <input type="range" id="sell-coffee-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('coffee')">出售</button>
          <span id="coffee-price">当前价格: ₹4.0/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>橡胶:</label>
          <span id="rubber-crops">0</span>
          <input type="range" id="sell-rubber-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('rubber')">出售</button>
          <span id="rubber-price">当前价格: ₹3.2/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>可可:</label>
          <span id="cocoa-crops">0</span>
          <input type="range" id="sell-cocoa-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('cocoa')">出售</button>
          <span id="cocoa-price">当前价格: ₹3.8/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>花生:</label>
          <span id="peanut-crops">0</span>
          <input type="range" id="sell-peanut-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('peanut')">出售</button>
          <span id="peanut-price">当前价格: ₹2.3/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
        <div class="crop-selection">
          <label>大豆:</label>
          <span id="soybean-crops">0</span>
          <input type="range" id="sell-soybean-amount" min="0" max="0" step="1" value="0" style="width: 100px;">
          <button onclick="sellCrop('soybean')">出售</button>
          <span id="soybean-price">当前价格: ₹2.6/单位</span>
          <div class="chart-container">
            <div class="chart-line" style="left: 0%; width: 20%"></div>
          </div>
        </div>
      </div>
      <!-- 新增灾害预测区块 -->
      <div id="disaster-prediction">
        <h3>⚠️ 灾害预测</h3>
        <p>使用气象监测仪可预测下一年的灾害，消耗300资金</p>
        <button onclick="predictDisaster()">进行预测</button>
        <div id="prediction-result"></div>
      </div>
    </div>
  </div>
  <div id="game-over-modal">
    <div id="modal-content">
      <h2 id="modal-title"></h2>
      <p id="modal-message"></p>
      <button onclick="restartGame()">重新开始</button>
      <button onclick="showExportScoreModal()">导出战绩</button>
    </div>
  </div>
  <!-- 新增导出战绩弹窗 -->
  <div id="export-score-modal">
    <div id="export-score-content">
      <h2>导出战绩</h2>
      <p>请输入你的姓名:</p>
      <input type="text" id="player-name" placeholder="请输入姓名">
      <button onclick="exportScore()">导出</button>
    </div>
  </div>
  <script>
    // 教程步骤及当前步骤索引
    const tutorialSteps = [
      "欢迎来到季风决策者！本游戏将带你了解印度季风农业的基本知识。",
      "首先，你需要选择合适的作物。每种作物都有其最佳生长环境，例如水稻适合洪水环境。",
      "接下来，购买农业设备能有效降低灾害风险，例如防洪设施可以减少洪水损失。",
      "游戏中会随机触发政策和灾害，这将考验你的风险控制与决策能力。",
      "最后，系统会记录经营数据和成就，实时反馈帮助你总结经验。祝你好运！"
    ];
    let currentTutorialStep = 0;

    // 作物数据（四种作物）
    const CROPS = {
      "水稻": { ideal: "洪水", modifiers: { "洪水": 0.8, "延迟干旱": 0.9, "正常": 1.0 } },
      "小麦": { ideal: "正常", modifiers: { "洪水": 0.5, "延迟干旱": 0.2, "正常": 1.0 } },
      "高粱": { ideal: "延迟干旱", modifiers: { "洪水": 0.5, "延迟干旱": 0.6, "正常": 1.0 } },
      "玉米": { ideal: "正常", modifiers: { "洪水": 0.7, "延迟干旱": 0.8, "正常": 1.1 } },
      "棉花": { ideal: "正常", modifiers: { "洪水": 0.3, "延迟干旱": 0.6, "正常": 1.2 } },
      "甘蔗": { ideal: "高温多湿", modifiers: { "洪水": 0.7, "延迟干旱": 0.4, "正常": 1.1 } },
      "茶叶": { ideal: "山地气候", modifiers: { "洪水": 0.5, "延迟干旱": 0.3, "正常": 1.0 } },
      "咖啡": { ideal: "热带气候", modifiers: { "洪水": 0.6, "延迟干旱": 0.5, "正常": 1.1 } },
      "橡胶": { ideal: "高温多雨", modifiers: { "洪水": 0.8, "延迟干旱": 0.2, "正常": 1.0 } },
      "可可": { ideal: "热带雨林", modifiers: { "洪水": 0.7, "延迟干旱": 0.3, "正常": 1.2 } },
      "花生": { ideal: "多种气候", modifiers: { "洪水": 0.6, "延迟干旱": 0.7, "正常": 1.0 } },
      "大豆": { ideal: "广泛环境", modifiers: { "洪水": 0.7, "延迟干旱": 0.6, "正常": 1.1 } }
    };

    // 政策列表
    const POLICIES = [
      {
        name: "出口禁令",
        effect: () => gameState.incomeMultiplier *= 0.5,
        description: "国际市场价格下降50%"
      },
      {
        name: "种植补贴",
        effect: () => gameState.equipmentCost = 0.8,
        description: "设备价格降低20%"
      },
      {
        name: "紧急赈灾",
        effect: () => gameState.money += 200,
        description: "政府补助₹200"
      },
      {
        name: "技术推广",
        effect: () => gameState.incomeMultiplier *= 1.2,
        description: "作物产量提高20%"
      },
      {
        name: "税收政策",
        effect: () => gameState.incomeMultiplier *= 0.9,
        description: "部分作物销售征收10%税收"
      },
      {
        name: "环保政策",
        effect: () => gameState.equipmentCost *= 0.9,
        description: "环保措施使设备价格降低10%"
      }
    ];

    // 灾害/季风情形
    const monsoonScenarios = [
      { type: "正常", yieldFactor: 1 },
      { type: "延迟干旱", yieldFactor: 0.3 },
      { type: "洪水", yieldFactor: 0.5 },
      { type: "病虫害", yieldFactor: 0.4 },
      { type: "霜冻", yieldFactor: 0.6 },
      { type: "台风", yieldFactor: 0.3 },
      { type: "沙尘暴", yieldFactor: 0.5 },
      { type: "旱灾", yieldFactor: 0.2 },
      { type: "雹灾", yieldFactor: 0.4 },
      { type: "土壤退化", yieldFactor: 0.7 },
      { type: "水资源短缺", yieldFactor: 0.6 },
      { type: "极端高温", yieldFactor: 0.5 }
    ];

    let gameState = {
      money: 800,
      currentCrop: null,
      equipment: [],
      policies: [],
      allPolicies: [],
      history: [],
      climateRisk: 25,
      year: 2023,
      incomeMultiplier: 1,
      equipmentCost: 1,
      consecutiveDisasters: 0,
      consecutiveSafeYears: 0,
      achievements: [],
      optimalCropMatches: 0,
      weatherSuccess: 0,
      gameMode: null,
      challengeYears: null,
      difficulty: null,
      disasterLevel: null,
      population: 150,
      initialPopulation: null,
      birthplace: null,
      crops: {
        wheat: 200,
        rice: 0,
        sorghum: 0,
        corn: 0,
        cotton: 0,
        sugarcane: 0,
        tea: 0,
        coffee: 0,
        rubber: 0,
        cocoa: 0,
        peanut: 0,
        soybean: 0
      },
      cropPrices: {
        wheat: 2.0,
        rice: 2.5,
        sorghum: 1.8,
        corn: 2.2,
        cotton: 3.0,
        sugarcane: 2.8,
        tea: 3.5,
        coffee: 4.0,
        rubber: 3.2,
        cocoa: 3.8,
        peanut: 2.3,
        soybean: 2.6
      },
      priceHistory: {
        wheat: [2.0, 2.2, 1.8, 2.5, 1.9],
        rice: [2.5, 2.8, 2.3, 3.0, 2.6],
        sorghum: [1.8, 2.0, 1.7, 2.3, 1.9],
        corn: [2.2, 2.4, 2.0, 2.7, 2.3],
        cotton: [3.0, 3.3, 2.8, 3.5, 3.1],
        sugarcane: [2.8, 3.0, 2.7, 3.2, 2.9],
        tea: [3.5, 3.8, 3.4, 4.0, 3.7],
        coffee: [4.0, 4.2, 3.9, 4.3, 4.1],
        rubber: [3.2, 3.4, 3.1, 3.5, 3.3],
        cocoa: [3.8, 4.0, 3.7, 4.2, 3.9],
        peanut: [2.3, 2.4, 2.2, 2.5, 2.1],
        soybean: [2.6, 2.7, 2.5, 2.8, 2.4]
      }
    };

    function updateClimate() {
      gameState.climateRisk = gameState.difficulty;
      document.getElementById('climate-meter').textContent =
        `极端天气概率: ${gameState.climateRisk}%`;
    }

    function applyRandomPolicy() {
      if (Math.random() < 0.6) return;
      const policy = POLICIES[Math.floor(Math.random() * POLICIES.length)];
      policy.effect();
      gameState.policies.push(policy.name);
      gameState.allPolicies.push(policy.name);
      const policyDiv = document.getElementById('policy-effect');
      policyDiv.innerHTML = `
        <h4>新政策颁布：${policy.name}</h4>
        <p>${policy.description}</p>
      `;
    }

    function updateMapEffect(scenario) {
      const map = document.getElementById('map');
      map.className = '';
      map.innerHTML = '';
      const overlay = document.createElement('div');
      overlay.className = 'satellite-overlay';
      if (scenario.type === '洪水') {
        overlay.classList.add('flood-effect');
        map.style.backgroundColor = '#006994';
      } else if (scenario.type === '延迟干旱') {
        overlay.classList.add('drought-effect');
        map.style.backgroundColor = '#8B4513';
      } else {
        map.style.backgroundColor = '#87CEEB';
      }
      map.appendChild(overlay);
      map.insertAdjacentHTML('beforeend',
        `<h2 style="color:white; position:absolute; top:10px; left:10px">
          ${scenario.type}
        </h2>`);
    }

    function calculateYield(scenario) {
      let yieldRate = scenario.yieldFactor;
      if (gameState.currentCrop && CROPS[gameState.currentCrop]) {
        const cropModifiers = CROPS[gameState.currentCrop].modifiers;
        if (cropModifiers[scenario.type] !== undefined) {
          yieldRate = cropModifiers[scenario.type];
        }
      }
      if (gameState.equipment.includes('灌溉设备') && scenario.type === '延迟干旱') {
        yieldRate *= 1.5;
      }
      if (gameState.equipment.includes('防洪设施') && scenario.type === '洪水') {
        yieldRate *= 1.3;
      }
      let weatherBonusApplied = false;
      if (gameState.equipment.includes('气象监测仪')) {
        const isExtreme = Math.random() < gameState.climateRisk / 100;
        if (isExtreme) {
          const predictedScenario = monsoonScenarios[Math.random() > 0.5 ? 1 : 2];
          if (predictedScenario.type === scenario.type) {
            yieldRate *= 1.2;
            weatherBonusApplied = true;
          }
        }
      }
      if (weatherBonusApplied) {
        gameState.weatherSuccess = (gameState.weatherSuccess || 0) + 1;
      } else {
        gameState.weatherSuccess = 0;
      }
      if ((scenario.type === '延迟干旱' && !gameState.equipment.includes('灌溉设备')) ||
        (scenario.type === '洪水' && !gameState.equipment.includes('防洪设施'))
      ) {
        yieldRate *= 0.8;
      }
      return yieldRate;
    }

    function calculateHarvest() {
      const isExtreme = Math.random() < gameState.climateRisk / 100;
      const scenario = isExtreme ?
        monsoonScenarios[Math.floor(Math.random() * (monsoonScenarios.length - 1)) + 1] :
        monsoonScenarios[0];

      updateMapEffect(scenario);
      applyRandomPolicy();
      let yieldRate = calculateYield(scenario);
      let baseIncome = 400;
      if (gameState.policies.includes('出口禁令')) baseIncome *= 0.5;
      if (gameState.policies.includes('技术推广')) baseIncome *= 1.2;
      const income = Math.round(baseIncome * yieldRate * gameState.incomeMultiplier);

      // 判断作物选择是否最佳
      if (gameState.currentCrop && CROPS[gameState.currentCrop].ideal === scenario.type) {
        gameState.optimalCropMatches++;
      } else {
        gameState.optimalCropMatches = 0;
      }

      if (isExtreme && scenario.type !== "正常") {
        const disasterPenalty = 400;
        gameState.money -= disasterPenalty;
        addLog(`灾害【${scenario.type}】发生，扣除资金: ₹${disasterPenalty}`);
        gameState.consecutiveDisasters++;
        gameState.consecutiveSafeYears = 0;
      } else {
        gameState.consecutiveDisasters = 0;
        gameState.consecutiveSafeYears++;
      }
      // 存入仓库
      if (gameState.currentCrop) {
        const cropToAdd = gameState.population * 2;
        gameState.crops[gameState.currentCrop.toLowerCase()] += cropToAdd;
        addLog(`收获了${cropToAdd}单位${gameState.currentCrop}，存入仓库`);
      }
      recordHistory(scenario, income);
      updateClimate();
      updateAchievements(income);
      updateDisplay();
      addLog(`收获收入: ₹${income}`);
      showFeedback(income, scenario);
      checkGameOver();
    }

    function checkGameOver() {
      if (gameState.money <= 0) {
        sellCropsToCoverDebt();
        showGameOverModal('失败', '资金耗尽，游戏失败！', 'failure');
      } else if (gameState.consecutiveDisasters >= 3) {
        showGameOverModal('失败', '连续3次灾害，游戏失败！', 'failure');
      } else if (gameState.year >= 2030) {
        showGameOverModal('胜利', '成功存活到2030年，游戏胜利！', 'success');
      } else if (gameState.gameMode === 'challenge' && gameState.year - 2023 >= gameState.challengeYears) {
        showGameOverModal('胜利', `挑战模式完成！坚持了${gameState.challengeYears}年`, 'success');
      } else if (gameState.population <= 0) {
        showGameOverModal('失败', '人口归零，游戏结束！', 'failure');
      }
    }

    function chooseCrop(crop) {
      if (CROPS[crop]) {
        gameState.currentCrop = crop;
        addLog(`你选择了 ${crop}`);
      } else {
        addLog(`未知作物: ${crop}`);
      }
    }

    function buyItem(item, cost) {
      const actualCost = Math.round(cost * gameState.equipmentCost);
      if (gameState.money >= actualCost) {
        gameState.money -= actualCost;
        gameState.equipment.push(item);
        addLog(`你购买了 ${item}，花费 ₹${actualCost}`);
        updateDisplay();
      } else {
        addLog(`资金不足，无法购买 ${item}`);
      }
    }

    function startNewYear() {
      if (!gameState.currentCrop) {
        addLog('请先选择作物！');
        return;
      }
      gameState.year++;
      gameState.policies = [];
      document.getElementById('policy-effect').innerHTML = '';
      calculateHarvest();
      updatePopulation();
    }

    function recordHistory(scenario, income) {
      const historyRow = `
        <tr>
          <td>${gameState.year}</td>
          <td>${scenario.type}</td>
          <td>₹${income}</td>
          <td>${gameState.policies.join(', ')}</td>
        </tr>
      `;
      document.getElementById('history-body').insertAdjacentHTML('beforeend', historyRow);
      gameState.history.push({ year: gameState.year, scenario: scenario.type, income: income });
    }

    function updateDisplay() {
      document.getElementById('money').textContent = gameState.money;
      document.getElementById('current-population').textContent = gameState.population;
      document.getElementById('wheat-crops').textContent = gameState.crops.wheat;
      document.getElementById('rice-crops').textContent = gameState.crops.rice;
      document.getElementById('sorghum-crops').textContent = gameState.crops.sorghum;
      document.getElementById('corn-crops').textContent = gameState.crops.corn;
      document.getElementById('cotton-crops').textContent = gameState.crops.cotton;
      document.getElementById('sugarcane-crops').textContent = gameState.crops.sugarcane;
      document.getElementById('tea-crops').textContent = gameState.crops.tea;
      document.getElementById('coffee-crops').textContent = gameState.crops.coffee;
      document.getElementById('rubber-crops').textContent = gameState.crops.rubber;
      document.getElementById('cocoa-crops').textContent = gameState.crops.cocoa;
      document.getElementById('peanut-crops').textContent = gameState.crops.peanut;
      document.getElementById('soybean-crops').textContent = gameState.crops.soybean;
      document.getElementById('wheat-price').textContent = `当前价格: ₹${gameState.cropPrices.wheat.toFixed(1)}/单位`;
      document.getElementById('rice-price').textContent = `当前价格: ₹${gameState.cropPrices.rice.toFixed(1)}/单位`;
      document.getElementById('sorghum-price').textContent = `当前价格: ₹${gameState.cropPrices.sorghum.toFixed(1)}/单位`;
      document.getElementById('corn-price').textContent = `当前价格: ₹${gameState.cropPrices.corn.toFixed(1)}/单位`;
      document.getElementById('cotton-price').textContent = `当前价格: ₹${gameState.cropPrices.cotton.toFixed(1)}/单位`;
      document.getElementById('sugarcane-price').textContent = `当前价格: ₹${gameState.cropPrices.sugarcane.toFixed(1)}/单位`;
      document.getElementById('tea-price').textContent = `当前价格: ₹${gameState.cropPrices.tea.toFixed(1)}/单位`;
      document.getElementById('coffee-price').textContent = `当前价格: ₹${gameState.cropPrices.coffee.toFixed(1)}/单位`;
      document.getElementById('rubber-price').textContent = `当前价格: ₹${gameState.cropPrices.rubber.toFixed(1)}/单位`;
      document.getElementById('cocoa-price').textContent = `当前价格: ₹${gameState.cropPrices.cocoa.toFixed(1)}/单位`;
      document.getElementById('peanut-price').textContent = `当前价格: ₹${gameState.cropPrices.peanut.toFixed(1)}/单位`;
      document.getElementById('soybean-price').textContent = `当前价格: ₹${gameState.cropPrices.soybean.toFixed(1)}/单位`;
      
      // 更新滑块最大值
      document.getElementById('sell-wheat-amount').max = gameState.crops.wheat;
      document.getElementById('sell-rice-amount').max = gameState.crops.rice;
      document.getElementById('sell-sorghum-amount').max = gameState.crops.sorghum;
      document.getElementById('sell-corn-amount').max = gameState.crops.corn;
      document.getElementById('sell-cotton-amount').max = gameState.crops.cotton;
      document.getElementById('sell-sugarcane-amount').max = gameState.crops.sugarcane;
      document.getElementById('sell-tea-amount').max = gameState.crops.tea;
      document.getElementById('sell-coffee-amount').max = gameState.crops.coffee;
      document.getElementById('sell-rubber-amount').max = gameState.crops.rubber;
      document.getElementById('sell-cocoa-amount').max = gameState.crops.cocoa;
      document.getElementById('sell-peanut-amount').max = gameState.crops.peanut;
      document.getElementById('sell-soybean-amount').max = gameState.crops.soybean;
    }

    function addLog(message) {
      const log = document.getElementById('log');
      const logEntry = document.createElement('p');
      logEntry.textContent = message;
      log.appendChild(logEntry);
      log.scrollTop = log.scrollHeight;
    }

    // 进阶成就与反馈系统
    function updateAchievements(income) {
      const achievementPanel = document.getElementById('achievement-panel');
      // “富农称号”：资金超过2000
      if (gameState.money >= 2000 && !gameState.achievements.includes("富农称号")) {
        gameState.achievements.push("富农称号");
        addLog("成就达成：富农称号！通过积累资金，你掌握了农业经营的基本理财知识。");
      }
      // “丰收达人”：连续安全年份达到5年
      if (gameState.consecutiveSafeYears >= 5 && !gameState.achievements.includes("丰收达人")) {
        gameState.achievements.push("丰收达人");
        addLog("成就达成：丰收达人！你成功躲过连续灾害，保障了农业稳定发展。");
      }
      // “天降横财”：单年收入超过₹1000
      if (income > 1000 && !gameState.achievements.includes("天降横财")) {
        gameState.achievements.push("天降横财");
        addLog("成就达成：天降横财！你在危机中也能收获高额收入，展示了高超的决策能力。");
      }
      // “装备大师”：拥有全部3种设备
      const uniqueEquip = new Set(gameState.equipment);
      if (uniqueEquip.size >= 3 && !gameState.achievements.includes("装备大师")) {
        gameState.achievements.push("装备大师");
        addLog("成就达成：装备大师！你充分利用了防灾设备，确保了农业安全。");
      }
      // 新增——“作物专家”：连续3年选择最佳作物
      if (gameState.optimalCropMatches >= 3 && !gameState.achievements.includes("作物专家")) {
        gameState.achievements.push("作物专家");
        addLog("成就达成：作物专家！你深刻理解了各作物与季风环境的匹配原理。");
      }
      // 新增——“气候预测家”：气象监测仪额外加成累计达到2次
      if (gameState.weatherSuccess >= 2 && !gameState.achievements.includes("气候预测家")) {
        gameState.achievements.push("气候预测家");
        addLog("成就达成：气候预测家！你成功利用现代科技预测天气变化。");
      }
      // 新增——“政策解读者”：累计触发有利政策（种植补贴或技术推广）2次以上
      const beneficialPolicies = gameState.allPolicies.filter(p => p === "种植补贴" || p === "技术推广");
      if (beneficialPolicies.length >= 2 && !gameState.achievements.includes("政策解读者")) {
        gameState.achievements.push("政策解读者");
        addLog("成就达成：政策解读者！你敏锐捕捉到政策变化，并利用其优势提高产量。");
      }
      // 新增——“可持续发展者”：曾触发环保政策
      if (gameState.allPolicies.includes("环保政策") && !gameState.achievements.includes("可持续发展者")) {
        gameState.achievements.push("可持续发展者");
        addLog("成就达成：可持续发展者！你关注环境保护，践行可持续农业理念。");
      }
      if (gameState.achievements.length === 0) {
        achievementPanel.innerHTML = "<p>暂无成就</p>";
      } else {
        achievementPanel.innerHTML = "";
        gameState.achievements.forEach(ach => {
          const achElem = document.createElement('h4');
          achElem.textContent = ach;
          achievementPanel.appendChild(achElem);
        });
      }
    }

    // 实时反馈系统：每回合结束后显示反馈信息
    function showFeedback(income, scenario) {
      const feedbackPanel = document.getElementById('feedback-panel');
      let feedbackMsg = "";
      if (gameState.currentCrop && CROPS[gameState.currentCrop].ideal === scenario.type) {
        feedbackMsg += "你选择的作物与本年度环境完美匹配，产量提升明显。";
      } else {
        feedbackMsg += "注意：本年度环境与所选作物不完全匹配，考虑调整策略。";
      }
      if (income > 1000) {
        feedbackMsg += " 单年收入表现优秀！";
      }
      feedbackPanel.textContent = feedbackMsg;
      feedbackPanel.style.display = "block";
      // 3秒后隐藏反馈
      setTimeout(() => { feedbackPanel.style.display = "none"; }, 3000);
    }

    function restartGame() {
      gameState.money = 800;
      gameState.currentCrop = null;
      gameState.equipment = [];
      gameState.policies = [];
      gameState.allPolicies = [];
      gameState.history = [];
      gameState.climateRisk = gameState.difficulty;
      gameState.year = 2023;
      gameState.incomeMultiplier = 1;
      gameState.equipmentCost = 1;
      gameState.consecutiveDisasters = 0;
      gameState.consecutiveSafeYears = 0;
      gameState.achievements = [];
      gameState.optimalCropMatches = 0;
      gameState.weatherSuccess = 0;
      gameState.population = gameState.initialPopulation;
      gameState.crops = {
        wheat: 200,
        rice: 0,
        sorghum: 0,
        corn: 0,
        cotton: 0,
        sugarcane: 0,
        tea: 0,
        coffee: 0,
        rubber: 0,
        cocoa: 0,
        peanut: 0,
        soybean: 0
      };
      gameState.cropPrices = {
        wheat: 2.0,
        rice: 2.5,
        sorghum: 1.8,
        corn: 2.2,
        cotton: 3.0,
        sugarcane: 2.8,
        tea: 3.5,
        coffee: 4.0,
        rubber: 3.2,
        cocoa: 3.8,
        peanut: 2.3,
        soybean: 2.6
      };
      updateDisplay();
      document.getElementById('policy-effect').innerHTML = '';
      document.getElementById('history-body').innerHTML = '';
      document.getElementById('log').innerHTML = '';
      document.getElementById('achievement-panel').innerHTML = "<p>暂无成就</p>";
      document.getElementById('game-over-modal').style.display = 'none';
      // 重置教程
      currentTutorialStep = 0;
      document.getElementById("tutorial-text").textContent = tutorialSteps[currentTutorialStep];
      document.getElementById("tutorial-overlay").style.display = "flex";
    }

    function startSettings() {
      document.getElementById('mode-selection-modal').style.display = 'none';
      document.getElementById('settings-modal').style.display = 'flex';
    }

    function startGame() {
      const gameMode = document.querySelector('input[name="game-mode"]:checked').value;
      gameState.gameMode = gameMode;
      if (gameMode === 'challenge') {
        gameState.challengeYears = parseInt(document.getElementById('challenge-years').value);
      }
      gameState.difficulty = parseInt(document.getElementById('difficulty').value);
      gameState.climateRisk = gameState.difficulty;
      gameState.initialPopulation = Math.floor(Math.random() * 101) + 150; // 随机初始人口150~250
      gameState.population = gameState.initialPopulation;
      gameState.birthplace = document.querySelector('input[name="birthplace"]:checked').value;
      updateDisplay();
      document.getElementById('settings-modal').style.display = 'none';
      document.getElementById("tutorial-overlay").style.display = "flex";
    }

    function increasePopulation() {
      if (gameState.money >= 1500) {
        gameState.money -= 1500;
        gameState.population = Math.round(gameState.population * 1.1);
        addLog("你增加了10%的人口");
        updateDisplay();
      } else {
        addLog("资金不足，无法增加人口");
      }
    }

    function decreasePopulation() {
      if (gameState.money >= 50) {
        gameState.money -= 50;
        gameState.population = Math.round(gameState.population * 0.9);
        addLog("你减少了10%的人口");
        updateDisplay();
      } else {
        addLog("资金不足，无法减少人口");
      }
    }

    function updatePopulation() {
      // 每年增加7%人口
      gameState.population = Math.round(gameState.population * 1.07);
      // 消耗粮食
      // const grainNeeded = Math.ceil(gameState.population * 0.5);
      // let totalGrain = gameState.crops.wheat + gameState.crops.rice + gameState.crops.sorghum + gameState.crops.corn;
      // if (totalGrain >= grainNeeded) {
      //   // 按比例消耗粮食
      //   const wheatConsumption = Math.round(grainNeeded * (gameState.crops.wheat / totalGrain));
      //   const riceConsumption = Math.round(grainNeeded * (gameState.crops.rice / totalGrain));
      //   const sorghumConsumption = Math.round(grainNeeded * (gameState.crops.sorghum / totalGrain));
      //   const cornConsumption = Math.round(grainNeeded * (gameState.crops.corn / totalGrain));
      
      //   gameState.crops.wheat -= wheatConsumption;
      //   gameState.crops.rice -= riceConsumption;
      //   gameState.crops.sorghum -= sorghumConsumption;
      //   gameState.crops.corn -= cornConsumption;
      // } else {
      //   const deficit = grainNeeded - totalGrain;
      //   gameState.population -= deficit;
      //   gameState.crops.wheat = 0;
      //   gameState.crops.rice = 0;
      //   gameState.crops.sorghum = 0;
      //   gameState.crops.corn = 0;
      // }
      // 确保人口不为负数和小数
      gameState.population = Math.max(0, gameState.population);
      updateDisplay();
    }

    function sellCrop(cropName) {
      const amount = parseInt(document.getElementById(`sell-${cropName}-amount`).value);
      if (isNaN(amount) || amount <= 0) {
        addLog("请输入有效的出售数量");
        return;
      }
      if (amount > gameState.crops[cropName]) {
        addLog(`${cropName}不足，无法出售`);
        return;
      }
      gameState.crops[cropName] -= amount;
      gameState.money += Math.round(amount * gameState.cropPrices[cropName]);
      addLog(`出售了${amount}单位${cropName}，获得₹${Math.round(amount * gameState.cropPrices[cropName])}`);
      updateDisplay();
      // 更新价格（模拟价格波动）
      gameState.priceHistory[cropName].shift();
      gameState.priceHistory[cropName].push(gameState.cropPrices[cropName]);
      gameState.cropPrices[cropName] = (gameState.priceHistory[cropName].reduce((a, b) => a + b, 0) / gameState.priceHistory[cropName].length) * (0.9 + Math.random() * 0.2);
    }

    function sellCropsToCoverDebt() {
      // 自动出售作物以覆盖债务
      const crops = ['wheat', 'rice', 'sorghum', 'corn', 'cotton', 'sugarcane', 'tea', 'coffee', 'rubber', 'cocoa', 'peanut', 'soybean'];
      let debt = -gameState.money;
      for (const crop of crops) {
        if (debt <= 0) break;
        const maxSell = Math.min(gameState.crops[crop], Math.ceil(debt / gameState.cropPrices[crop]));
        if (maxSell <= 0) continue;
        gameState.crops[crop] -= maxSell;
        gameState.money += maxSell * gameState.cropPrices[crop];
        debt -= maxSell * gameState.cropPrices[crop];
        addLog(`自动出售${maxSell}单位${crop}以覆盖债务`);
      }
      // 确保金钱不低于0
      gameState.money = Math.max(0, gameState.money);
      updateDisplay();
    }

    function showGameOverModal(title, message, status) {
      const modal = document.getElementById('game-over-modal');
      const modalContent = document.getElementById('modal-content');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      modal.style.display = 'flex';
      modalContent.classList.remove('success', 'failure');
      modalContent.classList.add(status);
      modalTitle.textContent = title;
      modalMessage.textContent = message + ` 最终资金: ₹${gameState.money}，最终人口: ${gameState.population}`;
    }

    function showExportScoreModal() {
      document.getElementById('export-score-modal').style.display = 'flex';
    }

    function exportScore() {
      const playerName = document.getElementById('player-name').value || '匿名玩家';
      // 创建一个临时的canvas元素用于绘制战绩
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 800;
      canvas.height = 600;
      // 绘制背景
      ctx.fillStyle = '#f7faff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // 绘制标题
      ctx.font = '36px Roboto';
      ctx.fillStyle = '#333';
      ctx.textAlign = 'center';
      ctx.fillText('季风决策者 - 战绩', canvas.width / 2, 50);
      // 绘制玩家信息
      ctx.font = '24px Roboto';
      ctx.fillText(`玩家: ${playerName}`, canvas.width / 2, 100);
      // 绘制游戏数据
      ctx.font = '18px Roboto';
      ctx.fillText(`游戏模式: ${gameState.gameMode}`, canvas.width / 2, 150);
      if (gameState.gameMode === 'challenge') {
        ctx.fillText(`挑战年限: ${gameState.challengeYears}年`, canvas.width / 2, 180);
      }
      ctx.fillText(`难度: ${gameState.difficulty}%`, canvas.width / 2, 210);
      ctx.fillText(`出生地: ${gameState.birthplace}`, canvas.width / 2, 240);
      ctx.fillText(`初始人口: ${gameState.initialPopulation}人`, canvas.width / 2, 270);
      ctx.fillText(`最终人口: ${gameState.population}人`, canvas.width / 2, 300);
      ctx.fillText(`游戏年份: ${gameState.year - 2023}年`, canvas.width / 2, 330);
      ctx.fillText(`最终资金: ₹${gameState.money}`, canvas.width / 2, 360);
      // 绘制成就
      ctx.fillText('成就:', canvas.width / 2, 400);
      if (gameState.achievements.length > 0) {
        gameState.achievements.forEach((ach, index) => {
          ctx.fillText(`${index + 1}. ${ach}`, canvas.width / 2, 430 + index * 30);
        });
      } else {
        ctx.fillText('暂无成就', canvas.width / 2, 430);
      }
      // 将canvas内容转换为PNG图片
      const dataURL = canvas.toDataURL('image/png');
      // 创建一个临时的a元素用于下载
      const link = document.createElement('a');
      link.href = dataURL;
      link.download = `monsoon-decision-maker-score-${playerName}.png`;
      link.click();
      // 隐藏导出弹窗
      document.getElementById('export-score-modal').style.display = 'none';
    }

    function predictDisaster() {
      if (!gameState.equipment.includes('气象监测仪')) {
        addLog('需要气象监测仪才能进行灾害预测');
        return;
      }
      if (gameState.money < 300) {
        addLog('资金不足，无法进行灾害预测');
        return;
      }
      gameState.money -= 300;
      const isExtreme = Math.random() < gameState.climateRisk / 100;
      const predictedScenario = isExtreme ?
        monsoonScenarios[Math.floor(Math.random() * (monsoonScenarios.length - 1)) + 1] :
        monsoonScenarios[0];
      document.getElementById('prediction-result').textContent = `预测下一年可能出现的灾害: ${predictedScenario.type}`;
      addLog(`预测下一年可能出现的灾害: ${predictedScenario.type}`);
    }
  </script>
</body>

</html>
